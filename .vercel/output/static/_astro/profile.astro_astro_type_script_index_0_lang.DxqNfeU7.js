const x=document.getElementById("profileForm");x?.addEventListener("submit",async function(s){s.preventDefault();const t=s.currentTarget;if(!(t instanceof HTMLFormElement)||t.dataset.saving==="1")return;t.dataset.saving="1";const c=t.querySelector('button[type="submit"]'),e=c instanceof HTMLButtonElement?c:null,l=e&&e.textContent?e.textContent:"Enregistrer les modifications";let i=t.querySelector("#profileSaveStatus");i instanceof HTMLElement||(i=document.createElement("div"),i.id="profileSaveStatus",i.className="mt-4 text-sm",i.setAttribute("role","status"),i.setAttribute("aria-live","polite"),t.appendChild(i));function u(f,a){i.textContent=f||"",i.className="mt-4 text-sm "+(a==="error"?"text-red-700":a==="success"?"text-emerald-700":"text-gray-600")}function d(){e&&(e.textContent=l)}const g=()=>u("","info");t.addEventListener("input",g,{once:!0}),u("","info"),e&&(e.disabled=!0,e.textContent="Enregistrement...");try{const f=await fetch("/api/profile/save",{method:"POST",body:new FormData(t),headers:{Accept:"application/json"}});let a=null;try{a=await f.json()}catch{a=null}if(!f.ok){e&&(e.textContent="Réessayer"),u(a&&a.error?a.error:`Erreur lors de l’enregistrement (HTTP ${f.status}).`,"error");return}if(!a||a.ok!==!0){e&&(e.textContent="Réessayer"),u(a&&a.error?a.error:"Erreur lors de l’enregistrement.","error");return}u("Profil enregistré.","success"),e&&(e.textContent="✓ Modifications enregistrées",setTimeout(()=>{d()},2e3))}catch{e&&(e.textContent="Réessayer"),u("Erreur réseau. Veuillez réessayer.","error")}finally{t.dataset.saving="0",e&&(e.disabled=!1),e&&!e.textContent&&d()}});const v=document.querySelector('select[name="origin_city_ids"]'),p=v instanceof HTMLSelectElement?v:null;if(p){let s=function(){const t=Array.from(p.selectedOptions);t.length>3&&(t[t.length-1].selected=!1);const e=Array.from(p.selectedOptions).filter(d=>/^\d{5}$/.test(d.value)).map(d=>(d.textContent||"").trim()),l=document.getElementById("origin_city_label_1"),i=document.getElementById("origin_city_label_2"),u=document.getElementById("origin_city_label_3");l&&(l.value=e[0]||""),i&&(i.value=e[1]||""),u&&(u.value=e[2]||"")};p.addEventListener("change",s),s()}function h(s,t){!s||!(s instanceof HTMLSelectElement)||s.multiple&&s.addEventListener("mousedown",function(c){const e=c.target;if(!(e instanceof HTMLOptionElement))return;c.preventDefault(),e.selected=!e.selected,Array.from(s.selectedOptions).length>t&&(e.selected=!1),s.dispatchEvent(new Event("change",{bubbles:!0}))},!0)}h(document.querySelector('select[name="primary_audience_1"]'),2);h(document.querySelector('select[name="origin_city_ids"]'),3);(function(){const s=document.getElementById("companyAddressInput"),t=document.getElementById("companyAddressSuggestions");if(!(s instanceof HTMLInputElement)||!(t instanceof HTMLDivElement))return;let c=null,e=-1,l=[];function i(){t.classList.add("hidden"),t.innerHTML="",e=-1,l=[]}function u(){t.classList.remove("hidden")}function d(n){return String(n).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function g(n,r){let o=null;return function(...m){o&&clearTimeout(o),o=setTimeout(()=>n.apply(this,m),r)}}async function f(n){c&&c.abort(),c=new AbortController;const r=new URL("https://api-adresse.data.gouv.fr/search");r.searchParams.set("q",n),r.searchParams.set("limit","6"),r.searchParams.set("type","housenumber");const o=await fetch(r.toString(),{method:"GET",headers:{Accept:"application/json"},signal:c.signal});if(!o.ok)return[];const m=await o.json().catch(()=>null);return Array.isArray(m?.features)?m.features:[]}function a(n){if(l=n,e=-1,!l.length){i();return}const r=l.map((o,m)=>{const b=o?.properties?.label??"";return typeof o?.properties?.score=="number"&&o.properties.score,`
              <button
                type="button"
                data-idx="${m}"
                class="w-full text-left px-5 py-3 hover:bg-gray-50 focus:bg-gray-50 outline-none"
              >
                <div class="text-sm text-gray-900">${d(b)}</div>
              </button>
            `}).join("");t.innerHTML=r,u()}function y(n){const o=l[n]?.properties?.label;typeof o=="string"&&o.trim()&&(s.value=o.trim(),s.dispatchEvent(new Event("input",{bubbles:!0}))),i()}const E=g(async()=>{const n=s.value.trim();if(n.length<6){i();return}try{const r=await f(n);a(r)}catch{i()}},220);s.addEventListener("input",E),t.addEventListener("click",n=>{const r=n.target instanceof Element?n.target.closest("button[data-idx]"):null;if(!r)return;const o=Number(r.getAttribute("data-idx"));Number.isFinite(o)&&y(o)}),s.addEventListener("keydown",n=>{if(t.classList.contains("hidden"))return;n.key==="ArrowDown"?(n.preventDefault(),e=Math.min(e+1,l.length-1)):n.key==="ArrowUp"?(n.preventDefault(),e=Math.max(e-1,0)):n.key==="Enter"?e>=0&&(n.preventDefault(),y(e)):n.key==="Escape"&&i();const r=t.querySelectorAll("button[data-idx]");r.forEach(o=>o.classList.remove("bg-gray-50")),e>=0&&r[e]&&(r[e].classList.add("bg-gray-50"),r[e].scrollIntoView({block:"nearest"}))}),document.addEventListener("mousedown",n=>{const r=n.target;r instanceof Node&&(r===s||t.contains(r)||i())}),s.addEventListener("blur",()=>{setTimeout(()=>i(),150)})})();
