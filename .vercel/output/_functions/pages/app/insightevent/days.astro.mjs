/* empty css                                          */
import { e as createAstro, f as createComponent, k as renderComponent, r as renderTemplate, l as defineScriptVars, h as addAttribute, m as maybeRenderHead } from "../../../chunks/astro/server_C4zwJFjj.mjs";
import "piccolore";
import { a as $$SignedOut, b as $$SignedIn, $ as $$BaseLayout } from "../../../chunks/BaseLayout_B7lVY6IF.mjs";
import { $ as $$InsightBottomBar } from "../../../chunks/InsightBottomBar_CMpl7VY1.mjs";
import { renderers } from "../../../renderers.mjs";
var __freeze = Object.freeze;
var __defProp = Object.defineProperty;
var __template = (cooked, raw) => __freeze(__defProp(cooked, "raw", { value: __freeze(raw || cooked.slice()) }));
var _a, _b;
const $$Astro = createAstro("http://localhost:4322");
const prerender = false;
const $$Days = createComponent(async ($$result, $$props, $$slots) => {
  const Astro2 = $$result.createAstro($$Astro, $$props, $$slots);
  Astro2.self = $$Days;
  const location_id = Astro2.locals && typeof Astro2.locals.location_id === "string" && Astro2.locals.location_id.trim() ? Astro2.locals.location_id.trim() : null;
  if (!location_id) {
    return Astro2.redirect("/profile");
  }
  const selected_dates_raw = Astro2.url?.searchParams?.get("selected_dates") ?? "";
  const saved_item_id_raw = Astro2.url?.searchParams?.get("saved_item_id") ?? "";
  const has_selected_dates = selected_dates_raw.split(",").map((s) => s.trim()).filter(Boolean).length > 0;
  const has_saved_item_id = typeof saved_item_id_raw === "string" && saved_item_id_raw.trim().length > 0;
  const show_actions = has_selected_dates || has_saved_item_id;
  return renderTemplate`${renderComponent($$result, "SignedOut", $$SignedOut, {}, { "default": async ($$result2) => renderTemplate(_a || (_a = __template([' <script>\n    window.location.href = "/sign-in";\n  <\/script> ']))) })} ${renderComponent($$result, "SignedIn", $$SignedIn, {}, { "default": async ($$result2) => renderTemplate` ${renderComponent($$result2, "BaseLayout", $$BaseLayout, { "title": "Insight Event — Days", "hideSurveyCta": true, "hideFooter": true }, { "default": async ($$result3) => renderTemplate(_b || (_b = __template([" ", '<div class="ms-container px-6 pt-6 w-full max-w-none"> <style id="ms-selected-days-style">  \n  /* add near your inline styles */\n  .ms-grid--split { grid-template-columns: minmax(0,1fr) 360px; }\n  .ms-grid--single { grid-template-columns: minmax(0,1fr); }\n\n  /* ---------- List mode layout fix (Saved list must NOT live in 360px aside) ---------- */\n  .ms-days-grid.ms-list-mode { grid-template-columns: 1fr !important; }\n  .ms-days-grid.ms-list-mode > aside { width: 100%; }\n  .ms-days-grid.ms-list-mode #main-col { display: none; }\n\n  /* =========================\n   Days grid (split vs single)\n   ========================= */\n  .ms-days-grid{\n    display:grid;\n    grid-template-columns: 1fr;\n    gap: 24px;\n    align-items:start;\n  }\n\n  @media (min-width: 1024px){\n    .ms-days-grid.ms-grid--split{\n      grid-template-columns: minmax(0,1fr) 360px;\n    }\n    .ms-days-grid.ms-grid--single{\n      grid-template-columns: minmax(0,1fr);\n    }\n  }\n\n  /* =========================\n   Selected Days (core view)\n   ========================= */\n\n  .ms-days-wrap{ width:100%; max-width:620px; margin:0 auto; padding:16px 16px 32px 16px; }\n  .ms-top-wrap{ text-align:center; }\n  .ms-top-month{ font-size:28px; line-height:1.08; font-weight:500; letter-spacing:-0.01em; margin:10px 0 6px 0; color:#111827; }\n  .ms-top-week{ font-size:12px; letter-spacing:0.22em; text-transform:uppercase; color:rgba(17,24,39,0.55); margin:0 0 28px 0; font-weight:500; }\n\n  /* --- Carousel (3 cards: left / mid / right) --- */\n  .ms-carousel-viewport{\n    overflow:visible;\n    display:flex;\n    justify-content:center;\n    margin-top:8px;\n    margin-bottom:28px;\n    width:100vw;\n    margin-left:calc(50% - 50vw);\n    margin-right:calc(50% - 50vw);\n  }\n\n  .ms-carousel-strip{ position:relative; width:666px; height:330px; transform-style:preserve-3d; }\n  .ms-carousel-strip.is-animating{ pointer-events:none; }\n\n  .ms-slot{\n    position:absolute;\n    top:0;\n    width:210px;\n    height:330px;\n    transition:left 520ms cubic-bezier(0.22,1,0.36,1),\n              transform 520ms cubic-bezier(0.22,1,0.36,1),\n              opacity 520ms cubic-bezier(0.22,1,0.36,1);\n    will-change:left,transform,opacity;\n  }\n\n  .ms-slot.left{\n    left:0px;\n    transform: translateX(14px) scale(0.92);\n    opacity:0.62;\n    z-index:1;\n  }\n  .ms-slot.mid{\n    left:228px;\n    transform: translateX(0px) scale(1.00);\n    opacity:1.00;\n    z-index:3;\n  }\n  .ms-slot.right{\n    left:456px;\n    transform: translateX(-14px) scale(0.92);\n    opacity:0.62;\n    z-index:1;\n  }\n\n  .ms-c-ghost{ width:210px; height:330px; border-radius:34px; visibility:hidden; }\n\n  .ms-c-card{\n    width:210px; height:330px; border-radius:34px; position:relative;\n    display:flex; flex-direction:column; align-items:center;\n    padding:22px 20px;\n    user-select:none;\n    -webkit-font-smoothing:antialiased;\n  }\n  .ms-c-card.active{ background:#fff; border:3px solid #000; box-shadow:0 14px 40px rgba(17,24,39,0.20); }\n  .ms-c-card.preview{ background:#fff; border:1px solid #eef2f7; box-shadow:0 10px 24px rgba(17,24,39,0.08); cursor:pointer; }\n\n  .ms-c-dow{ font-size:12px; letter-spacing:0.16em; text-transform:uppercase; margin-top:4px; font-weight:400; }\n  .ms-c-daynum{ font-size:26px; font-weight:500; margin-top:8px; line-height:1; }\n\n  .ms-c-marker{\n    margin-top:18px;\n    line-height:1;\n    font-weight:400;\n    letter-spacing:-0.02em;\n    flex:1 1 auto;\n    display:flex;\n    align-items:center;\n    justify-content:center;\n  }\n  .ms-c-card.active .ms-c-marker{ font-size:92px; }\n  .ms-c-card.preview .ms-c-marker{ font-size:44px; }\n\n  .ms-c-pill{ margin-top:auto; margin-bottom:10px; }\n  .ms-chip{\n    display:inline-flex; align-items:center; justify-content:center;\n    padding:7px 14px; border-radius:12px;\n    font-size:12px; letter-spacing:0.14em; text-transform:uppercase; font-weight:500;\n    background:#f3f4f6; border:1px solid #e5e7eb; color:#111827;\n  }\n\n  .ms-chip-date{\n    display:inline-flex;\n    align-items:center;\n    justify-content:center;\n    padding:6px 10px;\n    border-radius:12px;\n    font-size:12px;\n    border:1px solid #e5e7eb;\n    background:#f9fafb;\n    color:#111827;\n  }\n\n  .ms-chip-date.removable {\n    position: relative;\n    padding-right: 22px;\n    cursor: pointer;\n  }\n\n  .ms-chip-date.removable::after {\n    content: "×";\n    position: absolute;\n    right: 6px;\n    top: 50%;\n    transform: translateY(-50%);\n    font-size: 12px;\n    opacity: 0.6;\n  }\n\n  .ms-c-score{ font-size:20px; font-weight:500; letter-spacing:0.01em; margin-bottom:4px; line-height:1; color:#111827; }\n  .ms-c-score .muted{ opacity:0.55; font-weight:400; font-size:18px; }\n\n  .ms-c-card.preview .ms-c-dow,\n  .ms-c-card.preview .ms-c-daynum,\n  .ms-c-card.preview .ms-c-marker,\n  .ms-c-card.preview .ms-c-score{ color:#9ca3af; }\n\n  /* --- Analysis block --- */\n  .ms-analyse-wrap{ margin-top:0px; margin-bottom:10px; text-align:center; }\n  .ms-analyse-line{ display:flex; align-items:center; gap:14px; justify-content:center; margin-top:6px; }\n  .ms-analyse-line:before,\n  .ms-analyse-line:after{ content:""; height:1px; background:rgba(17,24,39,0.18); flex:1 1 auto; max-width:220px; }\n  .ms-analyse-label{ font-size:12px; letter-spacing:0.10em; text-transform:uppercase; color:rgba(17,24,39,0.55); font-weight:500; }\n  .ms-analyse-meaning{ margin-top:10px; font-size:16px; font-style:italic; color:#111827; font-weight:500; min-height:1.2em; }\n\n  /* --- Context tags --- */\n  .ms-context-tags{ margin-top:14px; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }\n  .ms-ctx-tag{\n    display:inline-flex; align-items:center; gap:10px;\n    padding:10px 14px;\n    border-radius:14px;\n    border:1px solid #e5e7eb;\n    background:#f3f4f6;\n    color:rgba(17,24,39,0.55);\n    font-size:14px;\n    font-weight:500;\n    line-height:1;\n    white-space:nowrap;\n  }\n  .ms-ctx-ico{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto; }\n  \n  /* --- Panels (Points clés / Alertes / Concurrence / Météo) --- */\n  .ms-panels{\n    padding-top:12px;\n    display:flex;\n    flex-direction:column;\n    gap:16px;\n  }\n  .ms-section{ width:100%; margin-top:0; }\n\n  .ms-kicker{\n    display:block;\n    font-size:12px;\n    font-weight:500;\n    letter-spacing:0.08em;\n    text-transform:uppercase;\n    color:rgba(17,24,39,0.45);\n    line-height:1.1;\n    margin:0 0 16px 0;\n  }\n  .ms-card{\n    background:#ffffff;\n    border:1px solid #eef2f7;\n    border-radius:22px;\n    padding:26px 26px;\n    font-size:14px;\n    line-height:1.55;\n    color:#111827;\n  }\n  .ms-head{ display:flex; gap:14px; align-items:center; }\n\n  /* Points clés: icon aligns to top of multi-line content */\n  .ms-section--sparkle .ms-head { align-items: flex-start; }\n  .ms-section--sparkle .ms-ico { margin-top: 2px; }\n\n  .ms-ico{\n    width:42px; height:42px;\n    border-radius:14px;\n    border:1px solid #f1f5f9;\n    background:#ffffff;\n    display:flex;\n    align-items:center;\n    justify-content:center;\n    flex:0 0 auto;\n  }\n  .ms-head-content{ flex:1; min-width:0; }\n  /* Deterministic renderer output (new): preserve \\n line breaks */\n  .ms-takeaway.preline{ white-space: pre-line; }\n  .ms-below{ margin-left:56px; margin-top:14px; }\n\n  .ms-ul{ list-style:disc !important; padding-left:18px !important; margin:0 !important; }\n  .ms-ul li{ margin:8px 0 !important; }\n  .ms-muted{ color:#6b7280; font-size:14px; }\n  .ms-caveat{ margin-top:12px; color:#6b7280; font-size:12.5px; line-height:1.4; font-style:italic; }\n\n  /* --- Selected dates pills bar --- */\n  .ms-pills-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }\n  .ms-pill{\n    border:1px solid rgba(17,24,39,0.12);\n    background:rgba(17,24,39,0.06);\n    border-radius:12px;\n    padding:8px 10px;\n    font:inherit;\n    color:#111827;\n    cursor:pointer;\n  }\n  .ms-pill.is-active{ outline:2px solid #111827; }\n  .ms-pill:disabled{ opacity:0.45; cursor:not-allowed; }\n  \n  /* ---------- Saved panel + pills (already used by your markup) ---------- */\n  .ms-pills-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }\n  .ms-pill{\n    border:1px solid rgba(17,24,39,0.12);\n    background:rgba(17,24,39,0.06);\n    border-radius:12px;\n    padding:8px 10px;\n    font:inherit;\n    color:#111827;\n    cursor:pointer;\n  }\n  .ms-pill.is-active{ outline:2px solid #111827; }\n  .ms-pill:disabled{ opacity:0.45; cursor:not-allowed; }\n\n  /* ---------- Saved list (template-like rows) ---------- */\n  .ms-saved-wrap{ width:100%; max-width:1080px; margin:0 auto; padding-top:6px; }\n\n  .ms-saved-hero{\n    font-size:24px;\n    line-height:1.05;\n    font-weight:500;\n    letter-spacing:-0.02em;\n    margin:10px 0 18px 0;\n    color:#111827;\n  }\n\n  .ms-saved-list{\n    border-top:1px solid #eef2f7;\n  }\n\n  .ms-saved-row{\n    display:flex;\n    align-items:center;\n    justify-content:space-between;\n    gap:18px;\n    padding:18px 0;\n    border-bottom:1px solid #eef2f7;\n  }\n\n  .ms-saved-left{ min-width:0; flex:1 1 auto; display:flex; flex-direction:column; gap:6px; }\n  .ms-saved-title2{\n    font-size:20px;\n    font-weight:400;\n    color:#111827;\n    line-height:1.15;\n    white-space:nowrap;\n    overflow:hidden;\n    text-overflow:ellipsis;\n  }\n\n  .ms-saved-subline{\n    display:flex;\n    align-items:center;\n    gap:10px;\n    min-width:0;\n    color:#6b7280;\n    font-size:14px;\n    line-height:1.3;\n  }\n\n  .ms-saved-datesline{\n    color:#111827;\n    font-weight:400;\n    white-space:nowrap;\n  }\n\n  .ms-saved-sep{ opacity:0.4; }\n\n  .ms-saved-desc{\n    white-space:nowrap;\n    overflow:hidden;\n    text-overflow:ellipsis;\n    color:#9ca3af;\n    font-weight:400;\n    min-width:0;\n  }\n\n  .ms-saved-right{\n    flex:0 0 auto;\n    display:flex;\n    align-items:center;\n    gap:14px;\n  }\n\n  .ms-saved-kpis{\n    display:flex;\n    align-items:center;\n    gap:14px;\n  }\n\n  .ms-kpi{\n    display:flex;\n    flex-direction:column;\n    gap:4px;\n    min-width:72px;\n  }\n\n  .ms-kpi-label{\n    font-size:11px;\n    letter-spacing:0.10em;\n    text-transform:uppercase;\n    color:rgba(15, 15, 16, 0.45);\n    font-weight:500;\n    line-height:1;\n  }\n\n  .ms-kpi-value{\n    font-size:14px;\n    color:#6b7280;\n    font-weight:500;\n    line-height:1.1;\n  }\n\n  .ms-saved-actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end; }\n\n  /* ---------- Modal (critical: prevents flash + keeps centered overlay) ---------- */\n  .ms-modal-backdrop{\n    position:fixed; inset:0;\n    background:rgba(17,24,39,0.45);\n    display:flex;\n    align-items:center;\n    justify-content:center;\n    padding:18px;\n    z-index:9999;\n  }\n  .ms-modal-backdrop[hidden]{ display:none !important; }\n\n  .ms-modal{\n    width:100%;\n    max-width:560px;\n    background:#fff;\n    border-radius:22px;\n    border:1px solid #eef2f7;\n    box-shadow:0 22px 60px rgba(17,24,39,0.22);\n    overflow:hidden;\n  }\n  .ms-modal-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; padding:18px 18px 0 18px; }\n  .ms-modal-title{ font-size:16px; font-weight:700; color:#111827; }\n  .ms-modal-sub{ margin-top:4px; font-size:13px; color:#6b7280; }\n  .ms-modal-x{ border:1px solid #eef2f7; background:#fff; border-radius:12px; padding:6px 10px; cursor:pointer; }\n\n  .ms-modal-body{ padding:14px 18px 16px 18px; display:flex; flex-direction:column; gap:12px; }\n  .ms-field{ display:block; }\n  .ms-label{ font-size:12px; font-weight:600; color:rgba(17,24,39,0.55); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:6px; }\n  .ms-input{ width:100%; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; font:inherit; background:#fff; }\n  .ms-textarea{ width:100%; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; font:inherit; background:#fff; }\n  .ms-datechips{ display:flex; flex-wrap:wrap; gap:6px; }\n  .ms-error{ margin-top:2px; color:#b91c1c; font-size:13px; }\n\n  .ms-modal-actions{ padding:0 18px 18px 18px; display:flex; gap:10px; justify-content:flex-end; }\n  .ms-btn{ border-radius:14px; padding:10px 14px; font:inherit; cursor:pointer; }\n  .ms-btn.ghost{ border:1px solid rgba(17,24,39,0.14); background:rgba(17,24,39,0.06); color:#111827; }\n  .ms-btn.solid{ border:1px solid #111827; background:#111827; color:#fff; }\n  .ms-btn:disabled{ opacity:0.55; cursor:not-allowed; }\n</style> <!-- Header / breadcrumb placeholder --> <div class="mb-4"></div> <div id="days-grid" class="ms-days-grid ms-grid--split"> <!-- Main --> <div id="main-col"> <!-- Focused day container --> <div id="day-content"', ' class="min-h-[120px]"> <div class="text-gray-400 text-sm">Chargement…</div> </div> </div> <!-- Saved panel --> <aside> <div id="saved-panel"></div> </aside> </div> <!-- Save modal (hidden by default) --> <div id="ms-save-modal" class="ms-modal-backdrop" aria-hidden="true" hidden> <div class="ms-modal" role="dialog" aria-modal="true" aria-labelledby="ms-save-title"> <div class="ms-modal-head"> <div> <div id="ms-save-title" class="ms-modal-title">Enregistrer ces jours</div> <div class="ms-modal-sub">Vous pourrez les retrouver dans “Enregistrés”.</div> </div> <button type="button" id="ms-save-close" class="ms-modal-x" aria-label="Fermer">✕</button> </div> <div class="ms-modal-body"> <label class="ms-field"> <div class="ms-label">Titre</div> <input id="ms-save-title-input" class="ms-input" type="text" placeholder="Ex: Week-end de Pâques" maxlength="120"> </label> <label class="ms-field"> <div class="ms-label">Étape</div> <select id="ms-save-stage" class="ms-input"> <option value="">—</option> <option value="option">Option</option> <option value="exploration">Exploration</option> <option value="prevalidation">Pré-validation</option> <option value="retenue">Retenue</option> </select> </label> <label class="ms-field"> <div class="ms-label">Description (optionnel)</div> <textarea id="ms-save-desc" class="ms-textarea" rows="3" placeholder="Contrainte, intuition, note interne…"></textarea> </label> <div class="ms-field"> <div class="ms-label">Dates</div> <div id="ms-save-dates" class="ms-datechips"></div> </div> <div id="ms-save-error" class="ms-error" style="display:none;"></div> </div> <div class="ms-modal-actions"> <button type="button" id="ms-save-cancel" class="ms-btn ghost">Annuler</button> <button type="button" id="ms-save-submit" class="ms-btn solid">Enregistrer</button> </div> </div> </div> </div> <div style="height:120px;"></div> ', "  <script>(function(){", '\n      (function () {\n        // ---- SERVER TRUTH (injected by Astro via define:vars) ----\n        const LOCATION_ID = (typeof location_id === "string" ? location_id : "").trim();\n\n        const params = new URLSearchParams(window.location.search);\n\n        const selectedDatesRaw = params.get("selected_dates") || "";\n        let selectedDate = (params.get("selected_date") || "").trim();\n\n        const selectedDates = selectedDatesRaw\n          .split(",")\n          .map(s => s.trim())\n          .filter(Boolean)\n          .slice(0, 7);\n\n        const savedItemId = (params.get("saved_item_id") || "").trim();\n\n        // Canonicalize selected_date if missing but we do have selected_dates\n        if (!selectedDate && selectedDates.length > 0) {\n          selectedDate = selectedDates[0];\n          params.set("selected_date", selectedDate);\n          window.history.replaceState({}, "", "?" + params.toString());\n        }\n\n        function getPillsContainer() {\n          // created by renderFocusedDay() via innerHTML\n          return document.getElementById("ms-selected-dates-bar");\n        }\n\n        function getSavedPanel() {\n          return document.getElementById("saved-panel");\n        }\n\n        function setLayoutMode(mode) {\n          const grid = document.getElementById("days-grid");\n          const panel = getSavedPanel();\n          const aside = panel ? panel.closest("aside") : null;\n          const mainCol = document.getElementById("main-col");\n          if (!grid || !aside || !mainCol) return;\n\n          if (mode === "list") {\n            // LIST MODE: saved list uses full width; main hidden\n            aside.style.display = "";\n            mainCol.style.display = "none";\n\n            grid.classList.remove("ms-grid--split");\n            grid.classList.add("ms-grid--single");\n            grid.classList.add("ms-list-mode");\n          } else {\n            // DETAIL MODE: selected day view; saved panel hidden\n            mainCol.style.display = "";\n            aside.style.display = "none";\n\n            grid.classList.remove("ms-list-mode");\n            grid.classList.remove("ms-grid--split");\n            grid.classList.add("ms-grid--single");\n          }\n        }\n\n        const container = document.getElementById("day-content");\n\n        function ensureSelectedDaysStyles() {\n          // Styles are now server-rendered via <style is:inline id="ms-selected-days-style">.\n          // Keep this function only because other code calls it.\n          return;\n        }\n\n        const modalBackdrop = document.getElementById("ms-save-modal");\n        const modalClose = document.getElementById("ms-save-close");\n        const modalCancel = document.getElementById("ms-save-cancel");\n        const modalSubmit = document.getElementById("ms-save-submit");\n        const modalTitle = document.getElementById("ms-save-title-input");\n        const modalStage = document.getElementById("ms-save-stage");\n        const modalDesc = document.getElementById("ms-save-desc");\n        const modalDates = document.getElementById("ms-save-dates");\n        const modalError = document.getElementById("ms-save-error");\n\n        // ---- Single global namespace (minimum “production-grade” state) ----\n        const MS = (window.__MS_DAYS__ ||= {});\n        MS.editingId ||= "";\n        MS.editingDates ||= [];\n        MS.pointsCles ||= null;\n        MS.draftDates ||= [];\n\n        // Allow BottomBar to open modal without tight coupling\n        window.addEventListener("ms:open-save-modal", () => {\n          if (Array.isArray(selectedDates) && selectedDates.length > 0) openSaveModal();\n        });\n\n        // EXTRA SAFETY: also bind the BottomBar button directly (no reliance on CustomEvent)\n        const saveActionBtn = document.getElementById("cta-save");\n        if (saveActionBtn) {\n          saveActionBtn.addEventListener("click", () => {\n            if (Array.isArray(selectedDates) && selectedDates.length > 0) openSaveModal();\n          });\n        }\n\n        function openSaveModal() {\n          ensureSelectedDaysStyles();\n          if (!modalBackdrop) return;\n\n          // Ensure create mode wording + clear edit state ---\n          MS.editingId = "";\n          MS.editingDates = [];\n          \n          const modalHeading = document.getElementById("ms-save-title");\n          if (modalHeading) modalHeading.textContent = "Enregistrer ces jours";\n          if (modalSubmit) modalSubmit.textContent = "Enregistrer";\n\n          // HARD RESET (avoid stale edit values leaking into create)\n          if (modalStage) modalStage.value = "";\n          if (modalDesc) modalDesc.value = "";\n          if (modalTitle) modalTitle.value = "";\n\n          // default title suggestion (create mode only)\n          if (modalTitle && !String(modalTitle.value || "").trim()) {\n            modalTitle.value = selectedDates.length ? `Sélection ${selectedDates[0]}…` : "";\n          }\n\n          // render date chips (create mode = read-only)\n          MS.draftDates = (Array.isArray(selectedDates) ? selectedDates : [])\n            .map(normalizeYmd)\n            .filter(Boolean)\n            .slice(0, 7);\n\n          renderModalDateChipsCreate(MS.draftDates);\n\n          if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n          \n          modalBackdrop.hidden = false;\n          modalBackdrop.setAttribute("aria-hidden", "false");\n\n          // focus\n          setTimeout(() => { try { modalTitle && modalTitle.focus(); } catch(_) {} }, 0);\n        }\n\n        function closeSaveModal() {\n          if (!modalBackdrop) return;\n          modalBackdrop.hidden = true;\n          modalBackdrop.setAttribute("aria-hidden", "true");\n\n          // avoid stale removable chips/state\n          MS.editingId = "";\n          MS.editingDates = [];\n        }\n\n        function showSaveError(msg) {\n          if (!modalError) return;\n          modalError.textContent = msg || "Erreur.";\n          modalError.style.display = "block";\n        }\n\n        async function saveCurrentSelection() {\n          if (MS.isSaving) return;\n          MS.isSaving = true;\n          \n          const editingId = String(MS.editingId || "").trim();\n          const isEdit = Boolean(editingId);\n\n          const loc = String(LOCATION_ID || "").trim();\n          if (!loc) return showSaveError("location_id manquant.");\n\n          const title = String(modalTitle?.value || "").trim();\n          if (!title) return showSaveError("Le titre est requis.");\n\n          if (!isEdit && !selectedDates.length) {\n            return showSaveError("Aucune date sélectionnée.");\n          }\n\n          const url = isEdit ? "/api/saved-items/update" : "/api/saved-items/create";\n\n          const payload = isEdit\n            ? {\n                saved_item_id: editingId,\n                title,\n                description: String(modalDesc?.value || "").trim() || null,\n                stage: String(modalStage?.value || "").trim() || null,\n                dates: (Array.isArray(MS.editingDates) ? MS.editingDates : []).map(normalizeYmd).filter(Boolean).slice(0, 7),\n              }\n            : {\n                location_id: loc,\n                title,\n                description: String(modalDesc?.value || "").trim() || null,\n                stage: String(modalStage?.value || "").trim() || null,\n                dates: (Array.isArray(MS.draftDates) ? MS.draftDates : []).map(normalizeYmd).filter(Boolean).slice(0, 7),\n              };\n\n          if (modalSubmit) modalSubmit.disabled = true;\n\n          try {\n            const res = await fetch(url, {\n              method: "POST",\n              headers: { "content-type": "application/json", accept: "application/json" },\n              body: JSON.stringify(payload),\n              cache: "no-store",\n            });\n\n            const ct = (res.headers.get("content-type") || "").toLowerCase();\n            const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n            if (!res.ok || !json?.ok) {\n              throw new Error(json?.error || `Erreur API (${res.status})`);\n            }\n\n            // reset edit state\n            MS.editingId = "";\n            MS.editingDates = [];\n\n            closeSaveModal();\n\n            const newId = (!isEdit && json?.saved_item_id) ? String(json.saved_item_id).trim() : "";\n            if (newId) {\n              // Canonical permalink: shareable, stable, no selected_dates required\n              const next = new URL(window.location.origin + "/app/insightevent/days");\n              next.searchParams.set("saved_item_id", newId);\n              window.location.assign(next.toString());\n              return;\n            }\n\n            // Fallback: refresh list\n            await loadSavedItems();\n\n          } catch (e) {\n            showSaveError(e?.message || "Erreur.");\n          } finally {\n            MS.isSaving = false;\n            if (modalSubmit) modalSubmit.disabled = false;\n          }\n        }\n\n        function stageLabel(s) {\n          const v = String(s || "").toLowerCase();\n          if (v === "option") return "Option";\n          if (v === "exploration") return "Exploration";\n          if (v === "prevalidation") return "Pré-validation";\n          if (v === "retenue") return "Retenue";\n          return null;\n        }\n\n        function normalizeYmd(v) {\n          const s = String(v ?? "").trim();\n          const m = s.match(/^(\\d{4}-\\d{2}-\\d{2})/);\n          return m ? m[1] : "";\n        }\n\n        function extractDatesFromSavedItem(it) {\n          // 1) array\n          if (Array.isArray(it?.dates)) {\n            return it.dates.map(normalizeYmd).filter(Boolean);\n          }\n\n          // 2) JSON string (common: \'["2026-01-01","2026-01-02"]\')\n          const s1 = typeof it?.dates === "string" ? it.dates.trim() : "";\n          if (s1.startsWith("[") && s1.endsWith("]")) {\n            try {\n              const arr = JSON.parse(s1);\n              if (Array.isArray(arr)) return arr.map(normalizeYmd).filter(Boolean);\n            } catch (_) {}\n          }\n\n          // 3) csv string (common: \'2026-01-01,2026-01-02\')\n          if (s1.includes("-")) {\n            const csv = s1.split(",").map(normalizeYmd).filter(Boolean);\n            if (csv.length) return csv;\n          }\n\n          // 4) alternate fields\n          const s2 = typeof it?.dates_csv === "string" ? it.dates_csv.trim() : "";\n          if (s2) {\n            const csv = s2.split(",").map(normalizeYmd).filter(Boolean);\n            if (csv.length) return csv;\n          }\n\n          const s3 = typeof it?.dates_json === "string" ? it.dates_json.trim() : "";\n          if (s3.startsWith("[") && s3.endsWith("]")) {\n            try {\n              const arr = JSON.parse(s3);\n              if (Array.isArray(arr)) return arr.map(normalizeYmd).filter(Boolean);\n            } catch (_) {}\n          }\n\n          return [];\n        }\n\n        function parseYmdToDate(ymd) {\n          const m = /^(\\d{4})-(\\d{2})-(\\d{2})$/.exec(String(ymd || "").trim());\n          if (!m) return null;\n          const y = Number(m[1]);\n          const mo = Number(m[2]);\n          const da = Number(m[3]);\n          const dt = new Date(Date.UTC(y, mo - 1, da));\n          if (Number.isNaN(dt.getTime())) return null;\n          return dt;\n        }\n\n        function renderSavedPanel(items) {\n          const savedPanel = getSavedPanel();\n          if (!savedPanel) return;\n\n          const rows = Array.isArray(items) ? items : [];\n\n          // Title block (template-like)\n          const head = `\n            <div class="ms-saved-wrap">\n              <div class="ms-saved-hero">Dates d’intérêt</div>\n            </div>\n          `;\n\n          if (rows.length === 0) {\n            savedPanel.innerHTML =\n              head +\n              `<div class="ms-saved-wrap"><div class="ms-saved-empty">Aucun enregistrement pour le moment.</div></div>`;\n            return;\n          }\n\n          // Helpers (local to saved list)\n          function fmtShortFr(ymd) {\n            // ymd is "YYYY-MM-DD"\n            const d = parseYmdToDate(ymd);\n            if (!d) return ymd;\n            const day = String(d.getUTCDate()).padStart(2, "0");\n            const month = new Intl.DateTimeFormat("fr-FR", { month: "short" }).format(d);\n            const m = month ? (month.charAt(0).toUpperCase() + month.slice(1)) : "";\n            return `${m} ${day}`; // ex: "Jan 21"\n          }\n\n          function datesSummary(datesArr) {\n            const dates = Array.isArray(datesArr) ? datesArr : [];\n            const shown = dates.slice(0, 3).map(fmtShortFr);\n            const rest = Math.max(0, dates.length - shown.length);\n            return {\n              text: shown.join(" · ") + (rest > 0 ? ` · +${rest}` : ""),\n              first: dates[0] ? fmtShortFr(dates[0]) : "",\n            };\n          }\n\n          savedPanel.innerHTML =\n            head +\n            `\n            <div class="ms-saved-wrap">\n              <div class="ms-saved-list">\n                ${rows\n                  .map((it) => {\n                    const id = it?.saved_item_id ? String(it.saved_item_id) : "";\n                    const title = it?.title ? String(it.title) : "Sans titre";\n                    const stage = stageLabel(it?.stage) || "—";\n                    const desc = it?.description ? String(it.description) : "";\n\n                    function short10Words(s) {\n                      const words = String(s || "").trim().split(/\\s+/).filter(Boolean);\n                      if (words.length <= 10) return words.join(" ");\n                      return words.slice(0, 10).join(" ") + "…";\n                    }\n\n                    function extractDates(it) {\n                      return extractDatesFromSavedItem(it);\n                    }\n\n                    const dates = extractDates(it);\n                    const datesCsv = dates.join(",");\n                    const count = Number(it?.number_of_dates || dates.length || 0) || 0;\n\n                    const ds = datesSummary(dates);\n\n                    // Left subline:\n                    // - show date(s) summary\n                    // - then a muted description (or stage hint if no description)\n                    const hint = desc ? short10Words(desc) : "";\n                    const hintSafe = hint ? escapeHtml(hint) : "";\n                    \n                    return `\n                      <div class="ms-saved-row ms-saved-tr"\n                        data-id="${escapeHtml(id)}"\n                        data-dates="${escapeHtml(datesCsv)}"\n                        data-title="${escapeHtml(title)}"\n                        data-stage="${escapeHtml(String(it?.stage || ""))}"\n                        data-desc="${escapeHtml(desc)}">\n                        <div class="ms-saved-left">\n                          <div class="ms-saved-title2">${escapeHtml(title)}</div>\n                          <div class="ms-saved-subline">\n                            <span class="ms-saved-datesline">${escapeHtml(ds.text || "")}</span>\n                            ${hintSafe ? `<span class="ms-saved-sep">|</span><span class="ms-saved-desc">${hintSafe}</span>` : ""}\n                          </div>\n                        </div>\n\n                        <div class="ms-saved-right">\n                          <div class="ms-saved-kpis">\n                            <div class="ms-kpi">\n                              <div class="ms-kpi-label">Étape</div>\n                              <div class="ms-kpi-value">${escapeHtml(stage)}</div>\n                            </div>\n                            <div class="ms-kpi">\n                              <div class="ms-kpi-label">Days</div>\n                              <div class="ms-kpi-value">${escapeHtml(String(count))}</div>\n                            </div>\n                          </div>\n\n                          <div class="ms-saved-actions c-actions">\n                            <button type="button" class="ms-btn-row ms-consult">Consulter</button>\n                            <button type="button" class="ms-btn-row ms-edit">Modifier</button>\n                            <button type="button" class="ms-btn-row ms-delete">Effacer</button>\n                          </div>\n                        </div>\n                      </div>\n                    `;\n                  })\n                  .join("")}\n              </div>\n            </div>\n          `;\n\n          // Wire buttons (unchanged)\n          savedPanel.querySelectorAll(".ms-saved-tr").forEach((rowEl) => {\n            const editBtn = rowEl.querySelector(".ms-edit");\n            const id = (rowEl.getAttribute("data-id") || "").trim();\n            const rawDates = (rowEl.getAttribute("data-dates") || "").trim();\n            const consultBtn = rowEl.querySelector(".ms-consult");\n\n            if (editBtn) {\n              editBtn.addEventListener("click", () => {\n                const id = (rowEl.getAttribute("data-id") || "").trim();\n                const title = rowEl.getAttribute("data-title") || "";\n                const stageRaw = (rowEl.getAttribute("data-stage") || "").trim(); // expects option/exploration/prevalidation/retenue\n                const desc = rowEl.getAttribute("data-desc") || "";\n                const rawDates = (rowEl.getAttribute("data-dates") || "").trim();\n\n                // Pre-fill modal fields\n                if (modalTitle) modalTitle.value = title;\n                if (modalStage) modalStage.value = stageRaw || "";\n                if (modalDesc) modalDesc.value = desc;\n\n                // Store which saved_item_id we are editing (must happen before rendering)\n                MS.editingId = id;\n                MS.editingDates = (rawDates || "")\n                  .split(",")\n                  .map(normalizeYmd)\n                  .filter(Boolean);\n\n                // Render date chips (edit mode = removable)\n                renderModalDateChipsEdit();\n\n                // Switch modal wording to edit mode ---\n                const modalHeading = document.getElementById("ms-save-title");\n                if (modalHeading) modalHeading.textContent = "Modifier cette liste";\n                if (modalSubmit) modalSubmit.textContent = "Mettre à jour";\n\n                // Open modal\n                if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n                modalBackdrop.hidden = false;\n                modalBackdrop.setAttribute("aria-hidden", "false");\n              });\n            }\n\n            const deleteBtn = rowEl.querySelector(".ms-delete");\n\n            if (consultBtn) {\n              consultBtn.addEventListener("click", () => {\n                const nextDates = rawDates\n                  .split(",")\n                  .map((s) => normalizeYmd(s))\n                  .filter(Boolean)\n                  .slice(0, 7);\n\n                if (!nextDates.length) {\n                  alert("Impossible de consulter : cet enregistrement ne contient pas ses dates (API /saved-items/list).");\n                  return;\n                }\n\n                const next = new URLSearchParams();\n                next.set("selected_dates", nextDates.join(","));\n                next.set("selected_date", nextDates[0]);\n                window.location.href = "/app/insightevent/days?" + next.toString();\n              });\n            }\n\n            if (deleteBtn) {\n              deleteBtn.addEventListener("click", async () => {\n                if (!id) return;\n                deleteBtn.disabled = true;\n\n                try {\n                  const res = await fetch("/api/saved-items/delete", {\n                    method: "POST",\n                    headers: { "content-type": "application/json", "accept": "application/json" },\n                    body: JSON.stringify({ saved_item_id: id }),\n                  });\n\n                  const ct = (res.headers.get("content-type") || "").toLowerCase();\n                  const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n                  if (!res.ok || !json?.ok) {\n                    throw new Error(json?.error || `Erreur API (${res.status})`);\n                  }\n\n                  await loadSavedItems();\n                } catch (e) {\n                  alert(e?.message || "Erreur.");\n                } finally {\n                  deleteBtn.disabled = false;\n                }\n              });\n            }\n          });\n        }\n\n        // Modal wiring\n        if (modalClose) modalClose.addEventListener("click", closeSaveModal);\n        if (modalCancel) modalCancel.addEventListener("click", closeSaveModal);\n        if (modalBackdrop) {\n          modalBackdrop.addEventListener("click", (e) => {\n            if (e.target === modalBackdrop) closeSaveModal();\n          });\n          document.addEventListener("keydown", (e) => {\n            if (e.key === "Escape" && !modalBackdrop.hidden) closeSaveModal();\n          });\n        }\n        if (modalSubmit) modalSubmit.addEventListener("click", saveCurrentSelection);\n\n        // ✅ INSERT THIS BLOCK RIGHT HERE (immediately after the line above)\n        if (modalDates) {\n          modalDates.addEventListener("click", (e) => {\n            const chip = e?.target?.closest?.(".ms-chip-date.removable[data-date]");\n            if (!chip) return;\n            const d = chip.getAttribute("data-date") || "";\n            removeDraftDate(d);\n          });\n        }\n\n        function escapeHtml(v) {\n          return String(v ?? "")\n            .replace(/&/g, "&amp;")\n            .replace(/</g, "&lt;")\n            .replace(/>/g, "&gt;")\n            .replace(/"/g, "&quot;")\n            .replace(/\'/g, "&#039;");\n        }\n\n        function renderModalDateChipsCreate(arr) {\n          if (!modalDates) return;\n          const dates = Array.isArray(arr) ? arr.map(normalizeYmd).filter(Boolean) : [];\n          modalDates.innerHTML = dates\n            .map(\n              (d) =>\n                `<button type="button" class="ms-chip-date removable" data-date="${escapeHtml(d)}">${escapeHtml(d)}</button>`\n            )\n            .join("");\n        }\n\n        function renderModalDateChipsEdit() {\n          if (!modalDates) return;\n\n          const dates = Array.isArray(MS.editingDates) ? MS.editingDates.map(normalizeYmd).filter(Boolean) : [];\n\n          modalDates.innerHTML = dates\n            .map(d => `<button type="button" class="ms-chip-date removable" data-date="${escapeHtml(d)}">${escapeHtml(d)}</button>`)\n            .join("");\n\n          // delegate inside modalDates (safe re-render)\n          modalDates.querySelectorAll("button[data-date]").forEach((btn) => {\n            btn.addEventListener("click", () => {\n              const d = (btn.getAttribute("data-date") || "").trim();\n              if (!d) return;\n\n              // remove locally (no backend write yet)\n              MS.editingDates = (Array.isArray(MS.editingDates) ? MS.editingDates : [])\n                .map(normalizeYmd)\n                .filter(Boolean)\n                .filter(x => x !== d);\n\n              // prevent empty list\n              if (MS.editingDates.length === 0) {\n                MS.editingDates = [d]; // keep at least one\n                showSaveError("Au moins une date est requise.");\n                return;\n              }\n\n              // clear errors if any\n              if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n\n              renderModalDateChipsEdit();\n            });\n          });\n        }\n\n        function escapeHtml(v) {\n          return String(v ?? "")\n            .replace(/&/g, "&amp;")\n            .replace(/</g, "&lt;")\n            .replace(/>/g, "&gt;")\n            .replace(/"/g, "&quot;")\n            .replace(/\'/g, "&#039;");\n        }\n\n        function renderModalDateChips(datesArr) {\n          if (!modalDates) return;\n          const arr = Array.isArray(datesArr) ? datesArr : [];\n          modalDates.innerHTML = arr\n            .map((d) => {\n              return `<span class="ms-chip-date removable" data-date="${escapeHtml(d)}">${escapeHtml(d)}</span>`;\n            })\n            .join("");\n        }\n\n        function removeDraftDate(d) {\n          const ymd = String(d || "").trim();\n          if (!ymd) return;\n\n          // Never allow empty list (otherwise Saved item becomes invalid)\n          if (MS.draftDates.length <= 1) {\n            alert("Vous devez garder au moins 1 date.");\n            return;\n          }\n\n          const ok = window.confirm(`Retirer ${ymd} de cette liste ?`);\n          if (!ok) return;\n\n          MS.draftDates = MS.draftDates.filter((x) => x !== ymd);\n\n          // Keep selectedDates in sync if we’re in selection mode\n          // (selectedDates is a const array, but mutable)\n          const idx = selectedDates.indexOf(ymd);\n          if (idx >= 0) selectedDates.splice(idx, 1);\n\n          // If selectedDate was removed, pick first remaining\n          if (selectedDate === ymd) {\n            selectedDate = MS.draftDates[0] || "";\n            if (selectedDate) params.set("selected_date", selectedDate);\n            else params.delete("selected_date");\n          }\n\n          // Sync URL selected_dates (if present)\n          if (selectedDates.length > 0) params.set("selected_dates", selectedDates.join(","));\n          else params.delete("selected_dates");\n\n          window.history.replaceState({}, "", "?" + params.toString());\n\n          renderModalDateChipsCreate(MS.draftDates);\n        }\n\n        function renderEmptyState() {\n          const pills = getPillsContainer();\n          if (pills) pills.innerHTML = "";\n\n          if (container) {\n            container.innerHTML = `\n              <div class="text-sm text-gray-600">\n                Aucun jour sélectionné. Retournez au mois pour choisir jusqu’à 7 dates.\n              </div>\n            `;\n          }\n        }\n\n        function medalBadge(medal) {\n          const m = (medal || "").toString();\n          if (!m) return "";\n          return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs border border-gray-200 bg-gray-50">${escapeHtml(m)}</span>`;\n        }\n\n        function renderPills(dayRowsByDate) {\n          const pillsContainer = getPillsContainer();\n          if (!pillsContainer) return;\n\n          ensureSelectedDaysStyles();\n\n          if (!selectedDates.length) {\n            pillsContainer.innerHTML = "";\n            return;\n          }\n\n          pillsContainer.innerHTML = `\n            <div class="ms-pills-row" role="list">\n              ${selectedDates\n                .map((d) => {\n                  const isActive = d === selectedDate;\n                  const hasData = dayRowsByDate && dayRowsByDate.has(d);\n                  return `\n                    <button type="button"\n                      class="ms-pill ${isActive ? "is-active" : ""}"\n                      data-date="${escapeHtml(d)}"\n                      ${hasData ? "" : "disabled"}\n                      aria-pressed="${isActive ? "true" : "false"}">\n                      ${escapeHtml(d)}\n                    </button>\n                  `;\n                })\n                .join("")}\n            </div>\n          `;\n\n          pillsContainer.querySelectorAll("button[data-date]").forEach((btn) => {\n            btn.addEventListener("click", () => {\n              const d = btn.getAttribute("data-date");\n              if (!d || d === selectedDate) return;\n\n              selectedDate = d;\n              params.set("selected_date", d);\n              window.history.replaceState({}, "", "?" + params.toString());\n\n              renderPills(dayRowsByDate);\n              renderFocusedDay(dayRowsByDate, MS.pointsCles);\n            });\n          });\n        }\n\n        function renderKeyFacts(keyFacts) {\n          const arr = Array.isArray(keyFacts) ? keyFacts : [];\n          if (arr.length === 0) return "";\n          const items = arr\n            .map(x => `<li class="text-sm text-gray-700">${escapeHtml(x)}</li>`)\n            .join("");\n          return `<ul class="list-disc pl-5 space-y-1">${items}</ul>`;\n        }\n\n        function renderPointsCles(pointsCles) {\n          const txt = (typeof pointsCles?.text === "string" ? pointsCles.text.trim() : "");\n\n          if (!txt) {\n            return `\n              <div class="border rounded-lg p-4">\n                <div class="text-sm text-gray-500">Points clés indisponibles.</div>\n              </div>\n            `;\n          }\n\n          return `\n            <div class="border rounded-lg p-4">\n              <div class="text-sm text-gray-400 mb-2">Points clés</div>\n              <p class="ms-takeaway preline">${escapeHtml(txt)}</p>\n            </div>\n          `;\n        }\n\n        function renderPanel(title, bodyHtml) {\n          return `\n            <div class="border rounded-lg p-4">\n              <div class="text-sm font-medium mb-2">${escapeHtml(title)}</div>\n              ${bodyHtml}\n            </div>\n          `;\n        }\n\n        function renderFocusedDay(dayRowsByDate, pointsCles) {\n          if (!container) return;\n\n          ensureSelectedDaysStyles();\n\n          const row = dayRowsByDate.get(selectedDate);\n          if (!row) {\n            container.innerHTML = `\n              <div class="text-sm text-gray-600">\n                Aucune donnée trouvée pour ${escapeHtml(selectedDate)}.\n              </div>\n            `;\n            return;\n          }\n\n          // ------------------------------\n          // Carousel DOM refs (AFTER innerHTML; scoped to container)\n          // ------------------------------\n          const stripEl = container.querySelector("#ms-carousel-strip");\n          const slotLeftEl = container.querySelector("#ms-slot-left");\n          const slotMidEl = container.querySelector("#ms-slot-mid");\n          const slotRightEl = container.querySelector("#ms-slot-right");\n\n          const getSlotDate = (slotEl) => {\n            const card = slotEl ? slotEl.querySelector(".ms-c-card.preview[data-date]") : null;\n            return card ? String(card.getAttribute("data-date") || "").trim() : "";\n          };\n\n          // ------------------------------\n          // Meta (Month / Week / DOW / Day number)\n          // ------------------------------\n          const meta = buildMetaForDate(selectedDate);\n\n          // ------------------------------\n          // Meaning line: compare score among selected days\n          // ------------------------------\n          const meaningText = (() => {\n            const scores = (Array.isArray(selectedDates) ? selectedDates : [])\n              .map((d) => {\n                const r = dayRowsByDate.get(d);\n                const s = r && typeof r.opportunity_score_final_local === "number" ? r.opportunity_score_final_local : null;\n                return s;\n              })\n              .filter((v) => v !== null);\n\n            const currentScore = typeof row.opportunity_score_final_local === "number" ? row.opportunity_score_final_local : null;\n            if (currentScore === null || scores.length <= 1) return "";\n\n            const max = Math.max(...scores);\n            const min = Math.min(...scores);\n\n            if (currentScore === max && currentScore !== min) return "Score le plus élevé parmi les jours sélectionnés";\n            if (currentScore === min && currentScore !== max) return "Score inférieur aux autres jours sélectionnés";\n            return "Score intermédiaire parmi les jours sélectionnés";\n          })();\n\n          // ------------------------------\n          // Context tags (MAX 3): daytype, vacation/holiday, commercial (first)\n          // ------------------------------\n          const ctxTags = (() => {\n            const tags = [];\n\n            // Convert unknown payloads (string | number | object | array) into safe human text\n            const tagText = (v) => {\n              if (v == null) return "";\n              if (typeof v === "string") return v.trim();\n              if (typeof v === "number" || typeof v === "boolean") return String(v);\n\n              if (Array.isArray(v)) {\n                // take first meaningful string from array\n                for (const it of v) {\n                  const t = tagText(it);\n                  if (t) return t;\n                }\n                return "";\n              }\n\n              if (typeof v === "object") {\n                // common “label/name/title” fields; extend if your structs differ\n                const o = v;\n                return (\n                  tagText(o.label) ||\n                  tagText(o.name) ||\n                  tagText(o.title) ||\n                  tagText(o.event_label) ||\n                  tagText(o.event_name) ||\n                  tagText(o.holiday_name) ||\n                  tagText(o.vacation_name) ||\n                  ""\n                );\n              }\n\n              return "";\n            };\n\n            // 1) daytype\n            if (meta.isWeekend === true) tags.push({ kind: "daytype", label: "Week-end" });\n            if (meta.isWeekend === false) tags.push({ kind: "daytype", label: "Semaine" });\n\n            // 2) vacation OR holiday (never both)\n            const vac = tagText(row.vacation_name);\n            const hol = tagText(row.holiday_name);\n            if (vac) tags.push({ kind: "break", label: vac });\n            else if (hol) tags.push({ kind: "break", label: hol });\n\n            // 3) commercial event (first non-empty only)\n            const ceRaw = row.commercial_events;\n            const ceArr = Array.isArray(ceRaw) ? ceRaw : (ceRaw ? [ceRaw] : []);\n            const firstCe = ceArr.map(tagText).find(Boolean);\n            if (firstCe) tags.push({ kind: "commercial", label: firstCe });\n\n            return tags.slice(0, 3);\n          })();\n\n          // ------------------------------\n          // Carousel model: 3 slots (prev / active / next) in ONE row\n          // ------------------------------\n          const dates = Array.isArray(selectedDates) ? selectedDates.slice() : [];\n          const n = dates.length;\n\n          const clampIdx = (i) => Math.max(0, Math.min(n - 1, i));\n          const modIdx = (i) => ((i % n) + n) % n;\n\n          let activeIdx = Math.max(0, dates.indexOf(selectedDate));\n          if (activeIdx === -1) activeIdx = 0;\n\n          const leftIdx = n >= 3 ? modIdx(activeIdx - 1) : (n === 2 ? (activeIdx === 0 ? null : 0) : null);\n          const rightIdx = n >= 3 ? modIdx(activeIdx + 1) : (n === 2 ? (activeIdx === 0 ? 1 : null) : null);\n\n          const cardHTML = (dateStr, kind) => {\n            if (!dateStr) return `<div class="ms-c-ghost" aria-hidden="true"></div>`;\n            const r = dayRowsByDate.get(dateStr);\n            const m = buildMetaForDate(dateStr);\n\n            const marker = r?.opportunity_medal ?? "";\n            const scoreInt =\n              typeof r?.opportunity_score_final_local === "number"\n                ? Math.round(r.opportunity_score_final_local)\n                : null;\n\n            const cls = kind === "active" ? "ms-c-card active" : "ms-c-card preview";\n            const onclick = kind === "active" ? "" : ` data-date="${escapeHtml(dateStr)}"`;\n\n            return `\n              <div class="${cls}"${onclick} role="button" tabindex="0" aria-label="${escapeHtml(dateStr)}">\n                <div class="ms-c-dow">${escapeHtml(m.dow3)}</div>\n                <div class="ms-c-daynum">${escapeHtml(m.dayNum2)}</div>\n                <div class="ms-c-marker">${escapeHtml(marker)}</div>\n                <div class="ms-c-pill"><span class="ms-chip">OPPORTUNITÉ</span></div>\n                <div class="ms-c-score">\n                  <span>${scoreInt != null ? escapeHtml(scoreInt) : ""}</span><span class="muted">${scoreInt != null ? "/100" : ""}</span>\n                </div>\n              </div>\n            `;\n          };\n\n          // ------------------------------\n          // Sections (single column; fixed order)\n          // ------------------------------\n          const pointsClesHtml = renderPointsClesHexLike(pointsCles);\n          const alertesHtml = renderAlertesHexLike(row);\n          const concurrenceHtml = renderConcurrenceHexLike(row);\n          const meteoHtml = renderMeteoHexLike(row);\n\n          container.innerHTML = `\n            <div class="ms-days-wrap">\n              <div id="ms-selected-dates-bar" style="margin-bottom:12px;"></div>\n              <div class="ms-top-wrap">\n                <div class="ms-top-month">${escapeHtml(meta.monthYear)}</div>\n                <div class="ms-top-week">${escapeHtml(meta.weekLabel)}</div>\n              </div>\n\n              <div class="ms-carousel-viewport">\n                <div class="ms-carousel-strip" id="ms-carousel-strip">\n                  <div class="ms-slot left"  id="ms-slot-left">${cardHTML(leftIdx != null ? dates[leftIdx] : null, "preview")}</div>\n                  <div class="ms-slot mid"   id="ms-slot-mid">${cardHTML(dates[activeIdx], "active")}</div>\n                  <div class="ms-slot right" id="ms-slot-right">${cardHTML(rightIdx != null ? dates[rightIdx] : null, "preview")}</div>\n                </div>\n              </div>\n\n              <div class="ms-analyse-wrap">\n                <div class="ms-analyse-line"><div class="ms-analyse-label">ANALYSE DU JOUR</div></div>\n                <div class="ms-analyse-meaning">${escapeHtml(meaningText)}</div>\n                <div class="ms-context-tags ${ctxTags.length === 3 ? "ms-ctx--3" : ""}">\n                  ${ctxTags.map((t) => `\n                    <div class="ms-ctx-tag">\n                      <span class="ms-ctx-ico">${ctxIconSVG(t.kind)}</span>\n                      <span>${escapeHtml(t.label)}</span>\n                    </div>\n                  `).join("")}\n                </div>\n              </div>\n\n              <div class="ms-panels">\n                ${pointsClesHtml}\n                ${alertesHtml}\n                ${concurrenceHtml}\n                ${meteoHtml}\n              </div>\n            </div>\n          `;\n\n          // Wire carousel preview clicks → animate axis rotation first, then rerender\n          function rotateCarousel(dir) {\n            const stripEl = container.querySelector("#ms-carousel-strip");\n            const slotLeftEl = container.querySelector("#ms-slot-left");\n            const slotMidEl = container.querySelector("#ms-slot-mid");\n            const slotRightEl = container.querySelector("#ms-slot-right");\n\n            if (!stripEl || !slotLeftEl || !slotMidEl || !slotRightEl) return;\n            if (MS.carouselAnimating) return;\n\n            const nextDate = dir === "left" ? getSlotDate(slotLeftEl) : getSlotDate(slotRightEl);\n            if (!nextDate || nextDate === selectedDate) return;\n\n            MS.carouselAnimating = true;\n            stripEl.classList.add("is-animating");\n\n            // Swap slot classes to trigger CSS transition (parallel “flow”)\n            if (dir === "left") {\n              slotLeftEl.classList.remove("left"); slotLeftEl.classList.add("mid");\n              slotMidEl.classList.remove("mid"); slotMidEl.classList.add("right");\n              slotRightEl.classList.remove("right"); slotRightEl.classList.add("left");\n            } else {\n              slotRightEl.classList.remove("right"); slotRightEl.classList.add("mid");\n              slotMidEl.classList.remove("mid"); slotMidEl.classList.add("left");\n              slotLeftEl.classList.remove("left"); slotLeftEl.classList.add("right");\n            }\n\n            const done = () => {\n              stripEl.classList.remove("is-animating");\n              MS.carouselAnimating = false;\n\n              selectedDate = nextDate;\n              params.set("selected_date", nextDate);\n              window.history.replaceState({}, "", "?" + params.toString());\n\n              renderPills(dayRowsByDate);\n              renderFocusedDay(dayRowsByDate, MS.pointsCles);\n            };\n\n            // More reliable: listen on the MID slot (it always transitions)\n            slotMidEl.addEventListener("transitionend", done, { once: true });\n          }\n\n          // Stable binding: delegate from container (container persists; innerHTML changes)\n          container.onclick = (e) => {\n            const card = e?.target?.closest?.(".ms-carousel-strip .ms-c-card.preview[data-date]");\n            if (!card) return;\n\n            const slot = card.closest(".ms-slot");\n            if (!slot) return;\n\n            if (slot.classList.contains("left")) rotateCarousel("left");\n            else if (slot.classList.contains("right")) rotateCarousel("right");\n          };\n\n          container.onkeydown = (e) => {\n            if (e.key !== "Enter" && e.key !== " ") return;\n\n            const card = e?.target?.closest?.(".ms-carousel-strip .ms-c-card.preview[data-date]");\n            if (!card) return;\n\n            const slot = card.closest(".ms-slot");\n            if (!slot) return;\n\n            e.preventDefault();\n\n            if (slot.classList.contains("left")) rotateCarousel("left");\n            else if (slot.classList.contains("right")) rotateCarousel("right");\n          };\n\n          // ------------------------------\n          // Local helpers (pure UI; no semantic changes)\n          // ------------------------------\n          function renderPointsClesHexLike(pc) {\n            const txt = pc?.text ? String(pc.text) : "";\n            if (!txt.trim()) {\n              return sectionHex("Points clés", "sparkle", `<div class="ms-muted">Points clés indisponibles.</div>`, "");\n            }\n\n            // IMPORTANT: preserve line breaks from deterministic renderer\n            const body = `\n              <div class="ms-takeaway" style="white-space:pre-line;">${escapeHtml(txt)}</div>\n            `;\n\n            return sectionHex("Points clés", "sparkle", body, "");\n          }\n\n          function renderAlertesHexLike(r) {\n            const major = r.is_major_realization_risk_flag === true;\n            const driver = r.major_realization_risk_driver ? String(r.major_realization_risk_driver) : "";\n            const lvl = typeof r.alert_level_max === "number" ? Math.round(r.alert_level_max) : null;\n\n            const wxLabel = (l) => {\n              if (l == null || l <= 0) return null;\n              return { 1: "niveau 1 (surveillance)", 2: "niveau 2 (attention)", 3: "niveau 3 (alerte)", 4: "niveau 4 (alerte forte)" }[l] || `niveau ${l}`;\n            };\n\n            const wx = wxLabel(lvl);\n            const takeaway = major\n              ? (driver ? `Point de vigilance : ${driver}.` : "Point de vigilance : un risque majeur est signalé.")\n              : `Aucune alerte majeure. Mobilité : non disponible. ${wx ? `Météo : ${wx}.` : "Météo : aucune alerte."}`;\n\n            const bullets = [\n              major\n                ? (driver ? `Point de vigilance : ${driver}.` : "Point de vigilance : un risque majeur est signalé.")\n                : null,\n              "Alertes mobilité (train/métro) : non disponibles pour l’instant.",\n              wx ? `Alerte météo : ${wx}.` : "Pas d’alerte météo à signaler.",\n            ].filter(Boolean);\n\n            return sectionHex(\n              "Alertes",\n              "alert",\n              `<div class="ms-takeaway">${escapeHtml(takeaway)}</div>`,\n              `<ul class="ms-ul">${bullets.map((x) => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`\n            );\n          }\n\n          function renderConcurrenceHexLike(r) {\n            const all =\n              (Array.isArray(r?.top_events_500m) && r.top_events_500m.length ? r.top_events_500m :\n              Array.isArray(r?.top_events_5km)  && r.top_events_5km.length  ? r.top_events_5km  :\n              Array.isArray(r?.top_events_10km) && r.top_events_10km.length ? r.top_events_10km :\n              Array.isArray(r?.top_events_50km) ? r.top_events_50km : []);\n\n            const total50 = Number(r?.events_within_50km_count ?? 0);\n\n            if (all.length === 0 && total50 === 0) {\n              return sectionHex(\n                "Concurrence événementielle",\n                "calendar",\n                `<div class="ms-takeaway">Aucune concurrence significative détectée.</div>`,\n                ""\n              );\n            }\n\n            // ---- context: client industry (trusted semantic field) ----\n            const clientIndustry =\n              MS?.pointsCles?.location_context?.client_industry_code || null;\n\n            // ---- helpers ----\n            const fmtDistance = (m) => {\n              const v = Number(m);\n              if (!Number.isFinite(v)) return "";\n              if (v < 1000) return `${Math.round(v)} m`;\n              return `${(v / 1000).toFixed(1)} km`;\n            };\n\n            const shortText = (s, max = 120) => {\n              const t = String(s || "").replace(/\\s+/g, " ").trim();\n              if (!t) return "";\n              return t.length > max ? t.slice(0, max).trim() + "…" : t;\n            };\n\n            // City / place label:\n            // - prefer explicit name fields if present\n            // - never display pure numeric codes (ex: "9")\n            // - if cities_with_events is numeric, ignore it\n            const cityLabel = (e) => {\n              const pickFirstText = (arr) =>\n                (Array.isArray(arr) ? arr : [])\n                  .map((x) => String(x ?? "").trim())\n                  .find((x) => x && !/^\\d+$/.test(x)) || "";\n\n              // 1) explicit human-readable fields (most reliable)\n              const direct =\n                String(e?.city_name ?? "").trim() ||\n                String(e?.city ?? "").trim() ||\n                String(e?.commune_name ?? "").trim() ||\n                String(e?.location_city ?? "").trim() ||\n                String(e?.venue_city ?? "").trim();\n\n              if (direct && !/^\\d+$/.test(direct)) return direct;\n\n              // 2) cities_with_events (but it might be ids/codes)\n              const raw = e?.cities_with_events;\n\n              // array -> take first non-numeric token\n              if (Array.isArray(raw)) {\n                return pickFirstText(raw);\n              }\n\n              // string -> split, take first non-numeric token\n              const s = String(raw ?? "").trim();\n              if (!s) return "";\n\n              const token =\n                s\n                  .split(/[,;|]/)\n                  .map((x) => x.trim())\n                  .find((x) => x && !/^\\d+$/.test(x)) || "";\n\n              return token;\n            };\n\n            // ---- 1) same-industry first ----\n            let picked = all.filter(\n              (e) => clientIndustry && e?.industry_code === clientIndustry\n            );\n\n            // ---- 2) fallback: priority_rank (national > regional > local) ----\n            if (picked.length === 0) {\n              picked = [...all].sort((a, b) => {\n                const pa = Number(a?.keyword_priority_rank ?? 0);\n                const pb = Number(b?.keyword_priority_rank ?? 0);\n                if (pb !== pa) return pb - pa;\n\n                const ra = Number(a?.radius_precedence ?? 9);\n                const rb = Number(b?.radius_precedence ?? 9);\n                if (ra !== rb) return ra - rb;\n\n                return Number(a?.distance_m ?? 0) - Number(b?.distance_m ?? 0);\n              });\n            }\n\n            // ---- 3) enforce limits (max 3, min 1) ----\n            const shown = picked.slice(0, 3);\n            if (shown.length === 0 && all.length > 0) {\n              shown.push(all[0]);\n            }\n\n            // ---- rendering ----\n            const takeaway =\n              shown.length > 1\n                ? "Concurrence événementielle active à proximité."\n                : "Concurrence événementielle détectée.";\n\n            const list = `\n              <ul class="ms-ul">\n                ${shown\n                  .map((e) => {\n                    const title = e?.event_label || "Événement";\n                    const dist = fmtDistance(e?.distance_m);\n                    const city = cityLabel(e);\n                    const desc = shortText(\n                      e?.description ||\n                      e?.longDescription ||\n                      e?.summary ||\n                      e?.subtitle ||\n                      e?.program ||\n                      e?.keywords,\n                      120\n                    );\n\n                    const industryBadge =\n                      clientIndustry && e?.industry_code === clientIndustry\n                        ? `<span class="ms-muted">· même secteur</span>`\n                        : "";\n\n                    const where =\n                      (city && dist) ? `${city} — ${dist}` :\n                      (city) ? city :\n                      (dist) ? dist :\n                      "";\n\n                    return `\n                      <li>\n                        <span>${escapeHtml(title)}</span>\n                        ${where ? ` <span class="ms-muted">— ${escapeHtml(where)}</span>` : ""}\n                        ${industryBadge}\n                        ${desc ? `<div class="ms-muted">${escapeHtml(desc)}</div>` : ""}\n                      </li>\n                    `;\n                  })\n                  .join("")}\n              </ul>\n            `;\n\n            return sectionHex(\n              "Concurrence événementielle",\n              "calendar",\n              `<div class="ms-takeaway">${escapeHtml(takeaway)}</div>`,\n              list\n            );\n          }\n\n          function renderMeteoHexLike(r) {\n            const wx = r.weather_label_fr ? String(r.weather_label_fr) : "";\n            const tmin = r.temperature_2m_min != null ? Math.round(Number(r.temperature_2m_min)) : null;\n            const tmax = r.temperature_2m_max != null ? Math.round(Number(r.temperature_2m_max)) : null;\n\n            const pp = r.precipitation_probability_max_pct != null ? Math.round(Number(r.precipitation_probability_max_pct)) : null;\n            const wind = r.wind_speed_10m_max != null ? Math.round(Number(r.wind_speed_10m_max)) : null;\n\n            const parts = [];\n            if (wx) parts.push(wx);\n            if (tmin != null || tmax != null) {\n              if (tmin != null && tmax != null) parts.push(`${Math.min(tmin,tmax)}–${Math.max(tmin,tmax)}°C`);\n              else if (tmin != null) parts.push(`min ${tmin}°C`);\n              else parts.push(`max ${tmax}°C`);\n            }\n            if (pp != null) parts.push(`pluie ${pp}%`);\n            if (wind != null) parts.push(`vent ${wind} km/h`);\n\n            const takeaway = parts.length ? `Météo : ${parts.join(", ")}.` : "Météo : non disponible.";\n\n            const bullets = [];\n            if (wx) bullets.push(`Temps : ${wx}.`);\n            if (pp != null) bullets.push(`Pluie : ${pp}% (probabilité max).`);\n            if (wind != null) bullets.push(`Vent : ${wind} km/h (max).`);\n            if (tmin != null && tmax != null) bullets.push(`Température : ${Math.min(tmin,tmax)}°C à ${Math.max(tmin,tmax)}°C.`);\n\n            return sectionHex(\n              "Météo / Faisabilité",\n              "sun",\n              `<div class="ms-takeaway">${escapeHtml(takeaway)}</div>`,\n              bullets.length ? `<ul class="ms-ul">${bullets.slice(0, 4).map((x) => `<li>${escapeHtml(x)}</li>`).join("")}</ul>` : ""\n            );\n          }\n\n          function sectionHex(title, iconKind, headHtml, belowHtml) {\n            const below = belowHtml && String(belowHtml).trim()\n              ? `<div class="ms-below">${belowHtml}</div>`\n              : "";\n\n            const kind = String(iconKind || "").toLowerCase().replace(/[^a-z0-9_-]/g, "");\n            const kindClass = kind ? ` ms-section--${kind}` : "";\n\n            return `\n              <div class="ms-section${kindClass}">\n                <div class="ms-kicker">${escapeHtml(title)}</div>\n                <div class="ms-card">\n                  <div class="ms-head">\n                    <div class="ms-ico">${sectionIconSVG(iconKind)}</div>\n                    <div class="ms-head-content">${headHtml}</div>\n                  </div>\n                  ${below}\n                </div>\n              </div>\n            `;\n          }\n\n          function buildMetaForDate(ymd) {\n            const d = parseYmdToDate(ymd);\n            if (!d) {\n              return { monthYear: "", weekLabel: "", dow3: "", dayNum2: "", isWeekend: null };\n            }\n\n            const dow3 = ["LUN", "MAR", "MER", "JEU", "VEN", "SAM", "DIM"][((d.getDay() + 6) % 7)];\n            const dayNum2 = String(d.getDate()).padStart(2, "0");\n\n            const monthYearRaw = new Intl.DateTimeFormat("fr-FR", { month: "long", year: "numeric" }).format(d);\n            const monthYear = monthYearRaw ? monthYearRaw.charAt(0).toUpperCase() + monthYearRaw.slice(1) : "";\n\n            const week = isoWeekNumber(d);\n            const weekLabel = `SEMAINE ${week}`;\n\n            const isWeekend = ((d.getDay() === 0) || (d.getDay() === 6));\n\n            return { monthYear, weekLabel, dow3, dayNum2, isWeekend };\n          }\n\n          function parseYmdToDate(ymd) {\n            const m = /^(\\d{4})-(\\d{2})-(\\d{2})$/.exec(String(ymd || "").trim());\n            if (!m) return null;\n            const y = Number(m[1]);\n            const mo = Number(m[2]);\n            const da = Number(m[3]);\n            const dt = new Date(Date.UTC(y, mo - 1, da));\n            if (Number.isNaN(dt.getTime())) return null;\n            return dt;\n          }\n\n          function isoWeekNumber(dateUtc) {\n            // dateUtc is a Date built in UTC; compute ISO week in UTC to avoid TZ drift.\n            const d = new Date(Date.UTC(dateUtc.getUTCFullYear(), dateUtc.getUTCMonth(), dateUtc.getUTCDate()));\n            // Thursday in current week decides the year.\n            const day = d.getUTCDay() || 7;\n            d.setUTCDate(d.getUTCDate() + 4 - day);\n            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\n            return weekNo;\n          }\n\n          function sectionIconSVG(kind) {\n            // Matches the Hex set (alert/info/calendar/sun/sparkle); no external deps.\n            const icons = {\n              alert: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 9v4" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M12 17h.01" stroke="#111827" stroke-width="3" stroke-linecap="round"/>\n                <path d="M10.3 4.3l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.7-2.7l-8-14a2 2 0 0 0-3.4 0z" stroke="#111827" stroke-width="1.6"/>\n              </svg>`,\n              info: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" stroke="#111827" stroke-width="1.6"/>\n                <path d="M12 10v7" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M12 7h.01" stroke="#111827" stroke-width="3" stroke-linecap="round"/>\n              </svg>`,\n              calendar: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M7 2v3M17 2v3" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M3.5 9h17" stroke="#111827" stroke-width="1.6"/>\n                <path d="M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z" stroke="#111827" stroke-width="1.6"/>\n              </svg>`,\n              sun: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" stroke="#111827" stroke-width="1.6"/>\n                <path d="M12 2v2M12 20v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M2 12h2M20 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"\n                      stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n              </svg>`,\n              sparkle: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 2l1.2 5.1L18 9l-4.8 1.9L12 16l-1.2-5.1L6 9l4.8-1.9L12 2z" stroke="#111827" stroke-width="1.6"/>\n              </svg>`,\n            };\n            return icons[kind] || icons.info;\n          }\n\n          function ctxIconSVG(kind) {\n            if (kind === "daytype") {\n              return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M4 7h16M4 12h16M4 17h16" stroke="#6b7280" stroke-width="1.8" stroke-linecap="round"/>\n                <path d="M7 4v16M12 4v16M17 4v16" stroke="#6b7280" stroke-width="1.2" stroke-linecap="round" opacity="0.55"/>\n              </svg>`;\n            }\n            if (kind === "break") {\n              return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 3c-4.8 0-8.7 3.5-9.5 8.1h19C20.7 6.5 16.8 3 12 3z" stroke="#6b7280" stroke-width="1.6" stroke-linejoin="round"/>\n                <path d="M12 11v7a2 2 0 0 1-4 0" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M6.2 11c.7 1.2 2 2 3.5 2s2.8-.8 3.5-2c.7 1.2 2 2 3.5 2s2.8-.8 3.5-2" stroke="#6b7280" stroke-width="1.2" stroke-linecap="round" opacity="0.65"/>\n              </svg>`;\n            }\n            return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n              <path d="M20 12v6a2 2 0 0 1-2 2H8l-4-4V6a2 2 0 0 1 2-2h6" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>\n              <path d="M16 3h5v5" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>\n              <path d="M21 3l-8 8" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/>\n            </svg>`;\n          }\n        }\n\n        async function fetchDays() {\n          if (!container) return null;\n\n          const loc = String(LOCATION_ID || "").trim();\n          if (!loc) {\n            container.innerHTML = \'<div class="text-sm text-red-600">Erreur: location_id manquant.</div>\';\n            return null;\n          }\n\n          if (!Array.isArray(selectedDates) || selectedDates.length === 0) {\n            return { days: [], points_cles: null };\n          }\n\n          const qs = new URLSearchParams();\n          qs.set("location_id", loc);\n          qs.set("selected_dates", selectedDates.join(","));\n\n          const apiUrl = "/api/insight/days?" + qs.toString();\n\n          const controller = new AbortController();\n          const timeout = setTimeout(() => controller.abort(), 15000);\n\n          try {\n            const res = await fetch(apiUrl, {\n              method: "GET",\n              headers: { Accept: "application/json" },\n              signal: controller.signal,\n              cache: "no-store",\n            });\n\n            if (!res.ok) {\n              const text = await res.text().catch(() => "");\n              throw new Error("API error " + res.status + (text ? " :: " + text.slice(0, 200) : ""));\n            }\n\n            const ct = (res.headers.get("content-type") || "").toLowerCase();\n            if (!ct.includes("application/json")) {\n              const text = await res.text().catch(() => "");\n              throw new Error("API returned non-JSON" + (text ? " :: " + text.slice(0, 200) : ""));\n            }\n\n            return await res.json();\n          } finally {\n            clearTimeout(timeout);\n          }\n        }\n\n        async function fetchSavedItems() {\n          // IMPORTANT: use your existing real endpoint.\n          // Your screenshot shows you already have: src/pages/api/saved-items/list (POST).\n          const res = await fetch("/api/saved-items/list", {\n            method: "POST",\n            headers: { "content-type": "application/json", "accept": "application/json" },\n            body: JSON.stringify({ limit: 50, offset: 0, stage: null }),\n            cache: "no-store",\n          });\n\n          const ct = (res.headers.get("content-type") || "").toLowerCase();\n          const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n          if (!res.ok || !json?.ok) return [];\n          return Array.isArray(json.items) ? json.items : [];\n        }\n\n        async function loadSavedItems() {\n          const savedPanel = getSavedPanel();\n          if (!savedPanel) return;\n          savedPanel.innerHTML = `<div class="text-gray-400 text-sm">Chargement…</div>`;\n          const items = await fetchSavedItems().catch(() => []);\n          renderSavedPanel(items);\n        }\n\n        async function fetchSavedItemById(saved_item_id) {\n          const res = await fetch("/api/saved-items/get", {\n            method: "POST",\n            headers: { "content-type": "application/json", accept: "application/json" },\n            body: JSON.stringify({ saved_item_id }),\n            cache: "no-store",\n          });\n\n          const ct = (res.headers.get("content-type") || "").toLowerCase();\n          const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n          if (!res.ok || !json?.ok || !json?.item) {\n            const msg = json?.error || `Erreur get (${res.status})`;\n            throw new Error(msg);\n          }\n\n          return json.item;\n        }\n\n        function maybeResolveSavedItemId() {\n          // Only run if we have a saved_item_id in the URL\n          if (!savedItemId) return false;\n\n          // If you already have selected_dates, no need to resolve/redirect.\n          if (Array.isArray(selectedDates) && selectedDates.length > 0) return false;\n\n          // Kick off async resolver; return true to stop the rest of the page from running.\n          (async () => {\n            try {\n              // Render a minimal loading state (no new UI, just reuse existing)\n              setLayoutMode("detail");\n              if (container) {\n                container.style.display = "";\n                container.innerHTML = `<div class="text-gray-400 text-sm">Chargement…</div>`;\n              }\n\n              const item = await fetchSavedItemById(savedItemId);\n\n              const dates = extractDatesFromSavedItem(item)\n                .map(normalizeYmd)\n                .filter(Boolean)\n                .slice(0, 7);\n\n              if (!dates.length) {\n                throw new Error("Cet enregistrement ne contient aucune date.");\n              }\n\n              // Canonical redirect to selection mode (keeps UX stable + uses your existing flow)\n              const next = new URLSearchParams(params);\n              next.delete("saved_item_id"); // IMPORTANT: avoids resolver loops\n              next.set("selected_dates", dates.join(","));\n              next.set("selected_date", dates[0]);\n\n              window.location.replace("/app/insightevent/days?" + next.toString());\n            } catch (e) {\n              // If get fails, fall back to list mode + show list (and optionally error)\n              console.error(e);\n\n              setLayoutMode("list");\n              await loadSavedItems().catch(() => {});\n\n              if (container) {\n                container.style.display = "";\n                container.innerHTML =\n                  `<div class="text-sm text-red-600">Impossible d’ouvrir cet enregistrement.</div>` +\n                  `<div class="mt-2 text-xs text-gray-500 break-words">${escapeHtml(e?.message || "Erreur.")}</div>`;\n              }\n            }\n          })();\n\n          return true;\n        }\n\n        // --------------------\n        // saved_item_id resolver → canonical redirect\n        // --------------------\n        if (maybeResolveSavedItemId()) return;\n\n        // --------------------\n        // LIST MODE (no selection)\n        // --------------------\n        if (!Array.isArray(selectedDates) || selectedDates.length === 0) {\n          setLayoutMode("list");\n\n          // Do NOT render empty state yet. Decide after we know if saved items exist.\n          (async () => {\n            const savedPanel = getSavedPanel();\n            if (savedPanel) savedPanel.innerHTML = `<div class="text-gray-400 text-sm">Chargement…</div>`;\n\n            const items = await fetchSavedItems().catch(() => []);\n            renderSavedPanel(items);\n\n            // Main column behavior depends on whether items exist\n            if (Array.isArray(items) && items.length > 0) {\n              if (pillsContainer) pillsContainer.innerHTML = "";\n\n              if (container) {\n                container.innerHTML = "";\n                container.style.display = "none";\n              }\n            } else {\n              if (container) container.style.display = ""; // restore if previously hidden\n              renderEmptyState();\n            }\n          })();\n\n          return;\n        }\n\n        // If we do have selected days: hide saved panel (no overlap with selected-days UX).\n        setLayoutMode("detail");\n\n        if (container) container.style.display = "";\n\n        (async function init() {\n          try {\n            const data = await fetchDays();\n            if (!data) {\n              // fetchDays already rendered the error state.\n              return;\n            }\n\n            const daysArr = Array.isArray(data.days) ? data.days : [];\n            const byDate = new Map();\n\n            for (const r of daysArr) {\n              const d = (r && r.date != null ? String(r.date) : "").trim();\n              if (d) byDate.set(d, r);\n            }\n\n            MS.pointsCles = data.points_cles ?? null;\n\n            if ((!selectedDate || !byDate.has(selectedDate)) && selectedDates.length > 0) {\n              const firstFound = selectedDates.find((d) => byDate.has(d));\n              if (firstFound) {\n                selectedDate = firstFound;\n                params.set("selected_date", selectedDate);\n                window.history.replaceState({}, "", "?" + params.toString());\n              }\n            }\n\n            renderPills(byDate);\n            renderFocusedDay(byDate, MS.pointsCles);\n          } catch (e) {\n            if (container) {\n              const msg =\n                e && typeof e.message === "string" && e.message.trim()\n                  ? e.message\n                  : "Erreur de chargement.";\n              container.innerHTML =\n                \'<div class="text-sm text-red-600">Erreur de chargement.</div>\' +\n                \'<div class="mt-2 text-xs text-gray-500 break-words">\' +\n                escapeHtml(msg) +\n                "</div>";\n            }\n            console.error(e);\n          }\n        })();\n      })();\n    })();<\/script> '], [" ", '<div class="ms-container px-6 pt-6 w-full max-w-none"> <style id="ms-selected-days-style">  \n  /* add near your inline styles */\n  .ms-grid--split { grid-template-columns: minmax(0,1fr) 360px; }\n  .ms-grid--single { grid-template-columns: minmax(0,1fr); }\n\n  /* ---------- List mode layout fix (Saved list must NOT live in 360px aside) ---------- */\n  .ms-days-grid.ms-list-mode { grid-template-columns: 1fr !important; }\n  .ms-days-grid.ms-list-mode > aside { width: 100%; }\n  .ms-days-grid.ms-list-mode #main-col { display: none; }\n\n  /* =========================\n   Days grid (split vs single)\n   ========================= */\n  .ms-days-grid{\n    display:grid;\n    grid-template-columns: 1fr;\n    gap: 24px;\n    align-items:start;\n  }\n\n  @media (min-width: 1024px){\n    .ms-days-grid.ms-grid--split{\n      grid-template-columns: minmax(0,1fr) 360px;\n    }\n    .ms-days-grid.ms-grid--single{\n      grid-template-columns: minmax(0,1fr);\n    }\n  }\n\n  /* =========================\n   Selected Days (core view)\n   ========================= */\n\n  .ms-days-wrap{ width:100%; max-width:620px; margin:0 auto; padding:16px 16px 32px 16px; }\n  .ms-top-wrap{ text-align:center; }\n  .ms-top-month{ font-size:28px; line-height:1.08; font-weight:500; letter-spacing:-0.01em; margin:10px 0 6px 0; color:#111827; }\n  .ms-top-week{ font-size:12px; letter-spacing:0.22em; text-transform:uppercase; color:rgba(17,24,39,0.55); margin:0 0 28px 0; font-weight:500; }\n\n  /* --- Carousel (3 cards: left / mid / right) --- */\n  .ms-carousel-viewport{\n    overflow:visible;\n    display:flex;\n    justify-content:center;\n    margin-top:8px;\n    margin-bottom:28px;\n    width:100vw;\n    margin-left:calc(50% - 50vw);\n    margin-right:calc(50% - 50vw);\n  }\n\n  .ms-carousel-strip{ position:relative; width:666px; height:330px; transform-style:preserve-3d; }\n  .ms-carousel-strip.is-animating{ pointer-events:none; }\n\n  .ms-slot{\n    position:absolute;\n    top:0;\n    width:210px;\n    height:330px;\n    transition:left 520ms cubic-bezier(0.22,1,0.36,1),\n              transform 520ms cubic-bezier(0.22,1,0.36,1),\n              opacity 520ms cubic-bezier(0.22,1,0.36,1);\n    will-change:left,transform,opacity;\n  }\n\n  .ms-slot.left{\n    left:0px;\n    transform: translateX(14px) scale(0.92);\n    opacity:0.62;\n    z-index:1;\n  }\n  .ms-slot.mid{\n    left:228px;\n    transform: translateX(0px) scale(1.00);\n    opacity:1.00;\n    z-index:3;\n  }\n  .ms-slot.right{\n    left:456px;\n    transform: translateX(-14px) scale(0.92);\n    opacity:0.62;\n    z-index:1;\n  }\n\n  .ms-c-ghost{ width:210px; height:330px; border-radius:34px; visibility:hidden; }\n\n  .ms-c-card{\n    width:210px; height:330px; border-radius:34px; position:relative;\n    display:flex; flex-direction:column; align-items:center;\n    padding:22px 20px;\n    user-select:none;\n    -webkit-font-smoothing:antialiased;\n  }\n  .ms-c-card.active{ background:#fff; border:3px solid #000; box-shadow:0 14px 40px rgba(17,24,39,0.20); }\n  .ms-c-card.preview{ background:#fff; border:1px solid #eef2f7; box-shadow:0 10px 24px rgba(17,24,39,0.08); cursor:pointer; }\n\n  .ms-c-dow{ font-size:12px; letter-spacing:0.16em; text-transform:uppercase; margin-top:4px; font-weight:400; }\n  .ms-c-daynum{ font-size:26px; font-weight:500; margin-top:8px; line-height:1; }\n\n  .ms-c-marker{\n    margin-top:18px;\n    line-height:1;\n    font-weight:400;\n    letter-spacing:-0.02em;\n    flex:1 1 auto;\n    display:flex;\n    align-items:center;\n    justify-content:center;\n  }\n  .ms-c-card.active .ms-c-marker{ font-size:92px; }\n  .ms-c-card.preview .ms-c-marker{ font-size:44px; }\n\n  .ms-c-pill{ margin-top:auto; margin-bottom:10px; }\n  .ms-chip{\n    display:inline-flex; align-items:center; justify-content:center;\n    padding:7px 14px; border-radius:12px;\n    font-size:12px; letter-spacing:0.14em; text-transform:uppercase; font-weight:500;\n    background:#f3f4f6; border:1px solid #e5e7eb; color:#111827;\n  }\n\n  .ms-chip-date{\n    display:inline-flex;\n    align-items:center;\n    justify-content:center;\n    padding:6px 10px;\n    border-radius:12px;\n    font-size:12px;\n    border:1px solid #e5e7eb;\n    background:#f9fafb;\n    color:#111827;\n  }\n\n  .ms-chip-date.removable {\n    position: relative;\n    padding-right: 22px;\n    cursor: pointer;\n  }\n\n  .ms-chip-date.removable::after {\n    content: "×";\n    position: absolute;\n    right: 6px;\n    top: 50%;\n    transform: translateY(-50%);\n    font-size: 12px;\n    opacity: 0.6;\n  }\n\n  .ms-c-score{ font-size:20px; font-weight:500; letter-spacing:0.01em; margin-bottom:4px; line-height:1; color:#111827; }\n  .ms-c-score .muted{ opacity:0.55; font-weight:400; font-size:18px; }\n\n  .ms-c-card.preview .ms-c-dow,\n  .ms-c-card.preview .ms-c-daynum,\n  .ms-c-card.preview .ms-c-marker,\n  .ms-c-card.preview .ms-c-score{ color:#9ca3af; }\n\n  /* --- Analysis block --- */\n  .ms-analyse-wrap{ margin-top:0px; margin-bottom:10px; text-align:center; }\n  .ms-analyse-line{ display:flex; align-items:center; gap:14px; justify-content:center; margin-top:6px; }\n  .ms-analyse-line:before,\n  .ms-analyse-line:after{ content:""; height:1px; background:rgba(17,24,39,0.18); flex:1 1 auto; max-width:220px; }\n  .ms-analyse-label{ font-size:12px; letter-spacing:0.10em; text-transform:uppercase; color:rgba(17,24,39,0.55); font-weight:500; }\n  .ms-analyse-meaning{ margin-top:10px; font-size:16px; font-style:italic; color:#111827; font-weight:500; min-height:1.2em; }\n\n  /* --- Context tags --- */\n  .ms-context-tags{ margin-top:14px; display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }\n  .ms-ctx-tag{\n    display:inline-flex; align-items:center; gap:10px;\n    padding:10px 14px;\n    border-radius:14px;\n    border:1px solid #e5e7eb;\n    background:#f3f4f6;\n    color:rgba(17,24,39,0.55);\n    font-size:14px;\n    font-weight:500;\n    line-height:1;\n    white-space:nowrap;\n  }\n  .ms-ctx-ico{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto; }\n  \n  /* --- Panels (Points clés / Alertes / Concurrence / Météo) --- */\n  .ms-panels{\n    padding-top:12px;\n    display:flex;\n    flex-direction:column;\n    gap:16px;\n  }\n  .ms-section{ width:100%; margin-top:0; }\n\n  .ms-kicker{\n    display:block;\n    font-size:12px;\n    font-weight:500;\n    letter-spacing:0.08em;\n    text-transform:uppercase;\n    color:rgba(17,24,39,0.45);\n    line-height:1.1;\n    margin:0 0 16px 0;\n  }\n  .ms-card{\n    background:#ffffff;\n    border:1px solid #eef2f7;\n    border-radius:22px;\n    padding:26px 26px;\n    font-size:14px;\n    line-height:1.55;\n    color:#111827;\n  }\n  .ms-head{ display:flex; gap:14px; align-items:center; }\n\n  /* Points clés: icon aligns to top of multi-line content */\n  .ms-section--sparkle .ms-head { align-items: flex-start; }\n  .ms-section--sparkle .ms-ico { margin-top: 2px; }\n\n  .ms-ico{\n    width:42px; height:42px;\n    border-radius:14px;\n    border:1px solid #f1f5f9;\n    background:#ffffff;\n    display:flex;\n    align-items:center;\n    justify-content:center;\n    flex:0 0 auto;\n  }\n  .ms-head-content{ flex:1; min-width:0; }\n  /* Deterministic renderer output (new): preserve \\\\n line breaks */\n  .ms-takeaway.preline{ white-space: pre-line; }\n  .ms-below{ margin-left:56px; margin-top:14px; }\n\n  .ms-ul{ list-style:disc !important; padding-left:18px !important; margin:0 !important; }\n  .ms-ul li{ margin:8px 0 !important; }\n  .ms-muted{ color:#6b7280; font-size:14px; }\n  .ms-caveat{ margin-top:12px; color:#6b7280; font-size:12.5px; line-height:1.4; font-style:italic; }\n\n  /* --- Selected dates pills bar --- */\n  .ms-pills-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }\n  .ms-pill{\n    border:1px solid rgba(17,24,39,0.12);\n    background:rgba(17,24,39,0.06);\n    border-radius:12px;\n    padding:8px 10px;\n    font:inherit;\n    color:#111827;\n    cursor:pointer;\n  }\n  .ms-pill.is-active{ outline:2px solid #111827; }\n  .ms-pill:disabled{ opacity:0.45; cursor:not-allowed; }\n  \n  /* ---------- Saved panel + pills (already used by your markup) ---------- */\n  .ms-pills-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }\n  .ms-pill{\n    border:1px solid rgba(17,24,39,0.12);\n    background:rgba(17,24,39,0.06);\n    border-radius:12px;\n    padding:8px 10px;\n    font:inherit;\n    color:#111827;\n    cursor:pointer;\n  }\n  .ms-pill.is-active{ outline:2px solid #111827; }\n  .ms-pill:disabled{ opacity:0.45; cursor:not-allowed; }\n\n  /* ---------- Saved list (template-like rows) ---------- */\n  .ms-saved-wrap{ width:100%; max-width:1080px; margin:0 auto; padding-top:6px; }\n\n  .ms-saved-hero{\n    font-size:24px;\n    line-height:1.05;\n    font-weight:500;\n    letter-spacing:-0.02em;\n    margin:10px 0 18px 0;\n    color:#111827;\n  }\n\n  .ms-saved-list{\n    border-top:1px solid #eef2f7;\n  }\n\n  .ms-saved-row{\n    display:flex;\n    align-items:center;\n    justify-content:space-between;\n    gap:18px;\n    padding:18px 0;\n    border-bottom:1px solid #eef2f7;\n  }\n\n  .ms-saved-left{ min-width:0; flex:1 1 auto; display:flex; flex-direction:column; gap:6px; }\n  .ms-saved-title2{\n    font-size:20px;\n    font-weight:400;\n    color:#111827;\n    line-height:1.15;\n    white-space:nowrap;\n    overflow:hidden;\n    text-overflow:ellipsis;\n  }\n\n  .ms-saved-subline{\n    display:flex;\n    align-items:center;\n    gap:10px;\n    min-width:0;\n    color:#6b7280;\n    font-size:14px;\n    line-height:1.3;\n  }\n\n  .ms-saved-datesline{\n    color:#111827;\n    font-weight:400;\n    white-space:nowrap;\n  }\n\n  .ms-saved-sep{ opacity:0.4; }\n\n  .ms-saved-desc{\n    white-space:nowrap;\n    overflow:hidden;\n    text-overflow:ellipsis;\n    color:#9ca3af;\n    font-weight:400;\n    min-width:0;\n  }\n\n  .ms-saved-right{\n    flex:0 0 auto;\n    display:flex;\n    align-items:center;\n    gap:14px;\n  }\n\n  .ms-saved-kpis{\n    display:flex;\n    align-items:center;\n    gap:14px;\n  }\n\n  .ms-kpi{\n    display:flex;\n    flex-direction:column;\n    gap:4px;\n    min-width:72px;\n  }\n\n  .ms-kpi-label{\n    font-size:11px;\n    letter-spacing:0.10em;\n    text-transform:uppercase;\n    color:rgba(15, 15, 16, 0.45);\n    font-weight:500;\n    line-height:1;\n  }\n\n  .ms-kpi-value{\n    font-size:14px;\n    color:#6b7280;\n    font-weight:500;\n    line-height:1.1;\n  }\n\n  .ms-saved-actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end; }\n\n  /* ---------- Modal (critical: prevents flash + keeps centered overlay) ---------- */\n  .ms-modal-backdrop{\n    position:fixed; inset:0;\n    background:rgba(17,24,39,0.45);\n    display:flex;\n    align-items:center;\n    justify-content:center;\n    padding:18px;\n    z-index:9999;\n  }\n  .ms-modal-backdrop[hidden]{ display:none !important; }\n\n  .ms-modal{\n    width:100%;\n    max-width:560px;\n    background:#fff;\n    border-radius:22px;\n    border:1px solid #eef2f7;\n    box-shadow:0 22px 60px rgba(17,24,39,0.22);\n    overflow:hidden;\n  }\n  .ms-modal-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; padding:18px 18px 0 18px; }\n  .ms-modal-title{ font-size:16px; font-weight:700; color:#111827; }\n  .ms-modal-sub{ margin-top:4px; font-size:13px; color:#6b7280; }\n  .ms-modal-x{ border:1px solid #eef2f7; background:#fff; border-radius:12px; padding:6px 10px; cursor:pointer; }\n\n  .ms-modal-body{ padding:14px 18px 16px 18px; display:flex; flex-direction:column; gap:12px; }\n  .ms-field{ display:block; }\n  .ms-label{ font-size:12px; font-weight:600; color:rgba(17,24,39,0.55); letter-spacing:0.08em; text-transform:uppercase; margin-bottom:6px; }\n  .ms-input{ width:100%; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; font:inherit; background:#fff; }\n  .ms-textarea{ width:100%; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; font:inherit; background:#fff; }\n  .ms-datechips{ display:flex; flex-wrap:wrap; gap:6px; }\n  .ms-error{ margin-top:2px; color:#b91c1c; font-size:13px; }\n\n  .ms-modal-actions{ padding:0 18px 18px 18px; display:flex; gap:10px; justify-content:flex-end; }\n  .ms-btn{ border-radius:14px; padding:10px 14px; font:inherit; cursor:pointer; }\n  .ms-btn.ghost{ border:1px solid rgba(17,24,39,0.14); background:rgba(17,24,39,0.06); color:#111827; }\n  .ms-btn.solid{ border:1px solid #111827; background:#111827; color:#fff; }\n  .ms-btn:disabled{ opacity:0.55; cursor:not-allowed; }\n</style> <!-- Header / breadcrumb placeholder --> <div class="mb-4"></div> <div id="days-grid" class="ms-days-grid ms-grid--split"> <!-- Main --> <div id="main-col"> <!-- Focused day container --> <div id="day-content"', ' class="min-h-[120px]"> <div class="text-gray-400 text-sm">Chargement…</div> </div> </div> <!-- Saved panel --> <aside> <div id="saved-panel"></div> </aside> </div> <!-- Save modal (hidden by default) --> <div id="ms-save-modal" class="ms-modal-backdrop" aria-hidden="true" hidden> <div class="ms-modal" role="dialog" aria-modal="true" aria-labelledby="ms-save-title"> <div class="ms-modal-head"> <div> <div id="ms-save-title" class="ms-modal-title">Enregistrer ces jours</div> <div class="ms-modal-sub">Vous pourrez les retrouver dans “Enregistrés”.</div> </div> <button type="button" id="ms-save-close" class="ms-modal-x" aria-label="Fermer">✕</button> </div> <div class="ms-modal-body"> <label class="ms-field"> <div class="ms-label">Titre</div> <input id="ms-save-title-input" class="ms-input" type="text" placeholder="Ex: Week-end de Pâques" maxlength="120"> </label> <label class="ms-field"> <div class="ms-label">Étape</div> <select id="ms-save-stage" class="ms-input"> <option value="">—</option> <option value="option">Option</option> <option value="exploration">Exploration</option> <option value="prevalidation">Pré-validation</option> <option value="retenue">Retenue</option> </select> </label> <label class="ms-field"> <div class="ms-label">Description (optionnel)</div> <textarea id="ms-save-desc" class="ms-textarea" rows="3" placeholder="Contrainte, intuition, note interne…"></textarea> </label> <div class="ms-field"> <div class="ms-label">Dates</div> <div id="ms-save-dates" class="ms-datechips"></div> </div> <div id="ms-save-error" class="ms-error" style="display:none;"></div> </div> <div class="ms-modal-actions"> <button type="button" id="ms-save-cancel" class="ms-btn ghost">Annuler</button> <button type="button" id="ms-save-submit" class="ms-btn solid">Enregistrer</button> </div> </div> </div> </div> <div style="height:120px;"></div> ', "  <script>(function(){", '\n      (function () {\n        // ---- SERVER TRUTH (injected by Astro via define:vars) ----\n        const LOCATION_ID = (typeof location_id === "string" ? location_id : "").trim();\n\n        const params = new URLSearchParams(window.location.search);\n\n        const selectedDatesRaw = params.get("selected_dates") || "";\n        let selectedDate = (params.get("selected_date") || "").trim();\n\n        const selectedDates = selectedDatesRaw\n          .split(",")\n          .map(s => s.trim())\n          .filter(Boolean)\n          .slice(0, 7);\n\n        const savedItemId = (params.get("saved_item_id") || "").trim();\n\n        // Canonicalize selected_date if missing but we do have selected_dates\n        if (!selectedDate && selectedDates.length > 0) {\n          selectedDate = selectedDates[0];\n          params.set("selected_date", selectedDate);\n          window.history.replaceState({}, "", "?" + params.toString());\n        }\n\n        function getPillsContainer() {\n          // created by renderFocusedDay() via innerHTML\n          return document.getElementById("ms-selected-dates-bar");\n        }\n\n        function getSavedPanel() {\n          return document.getElementById("saved-panel");\n        }\n\n        function setLayoutMode(mode) {\n          const grid = document.getElementById("days-grid");\n          const panel = getSavedPanel();\n          const aside = panel ? panel.closest("aside") : null;\n          const mainCol = document.getElementById("main-col");\n          if (!grid || !aside || !mainCol) return;\n\n          if (mode === "list") {\n            // LIST MODE: saved list uses full width; main hidden\n            aside.style.display = "";\n            mainCol.style.display = "none";\n\n            grid.classList.remove("ms-grid--split");\n            grid.classList.add("ms-grid--single");\n            grid.classList.add("ms-list-mode");\n          } else {\n            // DETAIL MODE: selected day view; saved panel hidden\n            mainCol.style.display = "";\n            aside.style.display = "none";\n\n            grid.classList.remove("ms-list-mode");\n            grid.classList.remove("ms-grid--split");\n            grid.classList.add("ms-grid--single");\n          }\n        }\n\n        const container = document.getElementById("day-content");\n\n        function ensureSelectedDaysStyles() {\n          // Styles are now server-rendered via <style is:inline id="ms-selected-days-style">.\n          // Keep this function only because other code calls it.\n          return;\n        }\n\n        const modalBackdrop = document.getElementById("ms-save-modal");\n        const modalClose = document.getElementById("ms-save-close");\n        const modalCancel = document.getElementById("ms-save-cancel");\n        const modalSubmit = document.getElementById("ms-save-submit");\n        const modalTitle = document.getElementById("ms-save-title-input");\n        const modalStage = document.getElementById("ms-save-stage");\n        const modalDesc = document.getElementById("ms-save-desc");\n        const modalDates = document.getElementById("ms-save-dates");\n        const modalError = document.getElementById("ms-save-error");\n\n        // ---- Single global namespace (minimum “production-grade” state) ----\n        const MS = (window.__MS_DAYS__ ||= {});\n        MS.editingId ||= "";\n        MS.editingDates ||= [];\n        MS.pointsCles ||= null;\n        MS.draftDates ||= [];\n\n        // Allow BottomBar to open modal without tight coupling\n        window.addEventListener("ms:open-save-modal", () => {\n          if (Array.isArray(selectedDates) && selectedDates.length > 0) openSaveModal();\n        });\n\n        // EXTRA SAFETY: also bind the BottomBar button directly (no reliance on CustomEvent)\n        const saveActionBtn = document.getElementById("cta-save");\n        if (saveActionBtn) {\n          saveActionBtn.addEventListener("click", () => {\n            if (Array.isArray(selectedDates) && selectedDates.length > 0) openSaveModal();\n          });\n        }\n\n        function openSaveModal() {\n          ensureSelectedDaysStyles();\n          if (!modalBackdrop) return;\n\n          // Ensure create mode wording + clear edit state ---\n          MS.editingId = "";\n          MS.editingDates = [];\n          \n          const modalHeading = document.getElementById("ms-save-title");\n          if (modalHeading) modalHeading.textContent = "Enregistrer ces jours";\n          if (modalSubmit) modalSubmit.textContent = "Enregistrer";\n\n          // HARD RESET (avoid stale edit values leaking into create)\n          if (modalStage) modalStage.value = "";\n          if (modalDesc) modalDesc.value = "";\n          if (modalTitle) modalTitle.value = "";\n\n          // default title suggestion (create mode only)\n          if (modalTitle && !String(modalTitle.value || "").trim()) {\n            modalTitle.value = selectedDates.length ? \\`Sélection \\${selectedDates[0]}…\\` : "";\n          }\n\n          // render date chips (create mode = read-only)\n          MS.draftDates = (Array.isArray(selectedDates) ? selectedDates : [])\n            .map(normalizeYmd)\n            .filter(Boolean)\n            .slice(0, 7);\n\n          renderModalDateChipsCreate(MS.draftDates);\n\n          if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n          \n          modalBackdrop.hidden = false;\n          modalBackdrop.setAttribute("aria-hidden", "false");\n\n          // focus\n          setTimeout(() => { try { modalTitle && modalTitle.focus(); } catch(_) {} }, 0);\n        }\n\n        function closeSaveModal() {\n          if (!modalBackdrop) return;\n          modalBackdrop.hidden = true;\n          modalBackdrop.setAttribute("aria-hidden", "true");\n\n          // avoid stale removable chips/state\n          MS.editingId = "";\n          MS.editingDates = [];\n        }\n\n        function showSaveError(msg) {\n          if (!modalError) return;\n          modalError.textContent = msg || "Erreur.";\n          modalError.style.display = "block";\n        }\n\n        async function saveCurrentSelection() {\n          if (MS.isSaving) return;\n          MS.isSaving = true;\n          \n          const editingId = String(MS.editingId || "").trim();\n          const isEdit = Boolean(editingId);\n\n          const loc = String(LOCATION_ID || "").trim();\n          if (!loc) return showSaveError("location_id manquant.");\n\n          const title = String(modalTitle?.value || "").trim();\n          if (!title) return showSaveError("Le titre est requis.");\n\n          if (!isEdit && !selectedDates.length) {\n            return showSaveError("Aucune date sélectionnée.");\n          }\n\n          const url = isEdit ? "/api/saved-items/update" : "/api/saved-items/create";\n\n          const payload = isEdit\n            ? {\n                saved_item_id: editingId,\n                title,\n                description: String(modalDesc?.value || "").trim() || null,\n                stage: String(modalStage?.value || "").trim() || null,\n                dates: (Array.isArray(MS.editingDates) ? MS.editingDates : []).map(normalizeYmd).filter(Boolean).slice(0, 7),\n              }\n            : {\n                location_id: loc,\n                title,\n                description: String(modalDesc?.value || "").trim() || null,\n                stage: String(modalStage?.value || "").trim() || null,\n                dates: (Array.isArray(MS.draftDates) ? MS.draftDates : []).map(normalizeYmd).filter(Boolean).slice(0, 7),\n              };\n\n          if (modalSubmit) modalSubmit.disabled = true;\n\n          try {\n            const res = await fetch(url, {\n              method: "POST",\n              headers: { "content-type": "application/json", accept: "application/json" },\n              body: JSON.stringify(payload),\n              cache: "no-store",\n            });\n\n            const ct = (res.headers.get("content-type") || "").toLowerCase();\n            const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n            if (!res.ok || !json?.ok) {\n              throw new Error(json?.error || \\`Erreur API (\\${res.status})\\`);\n            }\n\n            // reset edit state\n            MS.editingId = "";\n            MS.editingDates = [];\n\n            closeSaveModal();\n\n            const newId = (!isEdit && json?.saved_item_id) ? String(json.saved_item_id).trim() : "";\n            if (newId) {\n              // Canonical permalink: shareable, stable, no selected_dates required\n              const next = new URL(window.location.origin + "/app/insightevent/days");\n              next.searchParams.set("saved_item_id", newId);\n              window.location.assign(next.toString());\n              return;\n            }\n\n            // Fallback: refresh list\n            await loadSavedItems();\n\n          } catch (e) {\n            showSaveError(e?.message || "Erreur.");\n          } finally {\n            MS.isSaving = false;\n            if (modalSubmit) modalSubmit.disabled = false;\n          }\n        }\n\n        function stageLabel(s) {\n          const v = String(s || "").toLowerCase();\n          if (v === "option") return "Option";\n          if (v === "exploration") return "Exploration";\n          if (v === "prevalidation") return "Pré-validation";\n          if (v === "retenue") return "Retenue";\n          return null;\n        }\n\n        function normalizeYmd(v) {\n          const s = String(v ?? "").trim();\n          const m = s.match(/^(\\\\d{4}-\\\\d{2}-\\\\d{2})/);\n          return m ? m[1] : "";\n        }\n\n        function extractDatesFromSavedItem(it) {\n          // 1) array\n          if (Array.isArray(it?.dates)) {\n            return it.dates.map(normalizeYmd).filter(Boolean);\n          }\n\n          // 2) JSON string (common: \'["2026-01-01","2026-01-02"]\')\n          const s1 = typeof it?.dates === "string" ? it.dates.trim() : "";\n          if (s1.startsWith("[") && s1.endsWith("]")) {\n            try {\n              const arr = JSON.parse(s1);\n              if (Array.isArray(arr)) return arr.map(normalizeYmd).filter(Boolean);\n            } catch (_) {}\n          }\n\n          // 3) csv string (common: \'2026-01-01,2026-01-02\')\n          if (s1.includes("-")) {\n            const csv = s1.split(",").map(normalizeYmd).filter(Boolean);\n            if (csv.length) return csv;\n          }\n\n          // 4) alternate fields\n          const s2 = typeof it?.dates_csv === "string" ? it.dates_csv.trim() : "";\n          if (s2) {\n            const csv = s2.split(",").map(normalizeYmd).filter(Boolean);\n            if (csv.length) return csv;\n          }\n\n          const s3 = typeof it?.dates_json === "string" ? it.dates_json.trim() : "";\n          if (s3.startsWith("[") && s3.endsWith("]")) {\n            try {\n              const arr = JSON.parse(s3);\n              if (Array.isArray(arr)) return arr.map(normalizeYmd).filter(Boolean);\n            } catch (_) {}\n          }\n\n          return [];\n        }\n\n        function parseYmdToDate(ymd) {\n          const m = /^(\\\\d{4})-(\\\\d{2})-(\\\\d{2})$/.exec(String(ymd || "").trim());\n          if (!m) return null;\n          const y = Number(m[1]);\n          const mo = Number(m[2]);\n          const da = Number(m[3]);\n          const dt = new Date(Date.UTC(y, mo - 1, da));\n          if (Number.isNaN(dt.getTime())) return null;\n          return dt;\n        }\n\n        function renderSavedPanel(items) {\n          const savedPanel = getSavedPanel();\n          if (!savedPanel) return;\n\n          const rows = Array.isArray(items) ? items : [];\n\n          // Title block (template-like)\n          const head = \\`\n            <div class="ms-saved-wrap">\n              <div class="ms-saved-hero">Dates d’intérêt</div>\n            </div>\n          \\`;\n\n          if (rows.length === 0) {\n            savedPanel.innerHTML =\n              head +\n              \\`<div class="ms-saved-wrap"><div class="ms-saved-empty">Aucun enregistrement pour le moment.</div></div>\\`;\n            return;\n          }\n\n          // Helpers (local to saved list)\n          function fmtShortFr(ymd) {\n            // ymd is "YYYY-MM-DD"\n            const d = parseYmdToDate(ymd);\n            if (!d) return ymd;\n            const day = String(d.getUTCDate()).padStart(2, "0");\n            const month = new Intl.DateTimeFormat("fr-FR", { month: "short" }).format(d);\n            const m = month ? (month.charAt(0).toUpperCase() + month.slice(1)) : "";\n            return \\`\\${m} \\${day}\\`; // ex: "Jan 21"\n          }\n\n          function datesSummary(datesArr) {\n            const dates = Array.isArray(datesArr) ? datesArr : [];\n            const shown = dates.slice(0, 3).map(fmtShortFr);\n            const rest = Math.max(0, dates.length - shown.length);\n            return {\n              text: shown.join(" · ") + (rest > 0 ? \\` · +\\${rest}\\` : ""),\n              first: dates[0] ? fmtShortFr(dates[0]) : "",\n            };\n          }\n\n          savedPanel.innerHTML =\n            head +\n            \\`\n            <div class="ms-saved-wrap">\n              <div class="ms-saved-list">\n                \\${rows\n                  .map((it) => {\n                    const id = it?.saved_item_id ? String(it.saved_item_id) : "";\n                    const title = it?.title ? String(it.title) : "Sans titre";\n                    const stage = stageLabel(it?.stage) || "—";\n                    const desc = it?.description ? String(it.description) : "";\n\n                    function short10Words(s) {\n                      const words = String(s || "").trim().split(/\\\\s+/).filter(Boolean);\n                      if (words.length <= 10) return words.join(" ");\n                      return words.slice(0, 10).join(" ") + "…";\n                    }\n\n                    function extractDates(it) {\n                      return extractDatesFromSavedItem(it);\n                    }\n\n                    const dates = extractDates(it);\n                    const datesCsv = dates.join(",");\n                    const count = Number(it?.number_of_dates || dates.length || 0) || 0;\n\n                    const ds = datesSummary(dates);\n\n                    // Left subline:\n                    // - show date(s) summary\n                    // - then a muted description (or stage hint if no description)\n                    const hint = desc ? short10Words(desc) : "";\n                    const hintSafe = hint ? escapeHtml(hint) : "";\n                    \n                    return \\`\n                      <div class="ms-saved-row ms-saved-tr"\n                        data-id="\\${escapeHtml(id)}"\n                        data-dates="\\${escapeHtml(datesCsv)}"\n                        data-title="\\${escapeHtml(title)}"\n                        data-stage="\\${escapeHtml(String(it?.stage || ""))}"\n                        data-desc="\\${escapeHtml(desc)}">\n                        <div class="ms-saved-left">\n                          <div class="ms-saved-title2">\\${escapeHtml(title)}</div>\n                          <div class="ms-saved-subline">\n                            <span class="ms-saved-datesline">\\${escapeHtml(ds.text || "")}</span>\n                            \\${hintSafe ? \\`<span class="ms-saved-sep">|</span><span class="ms-saved-desc">\\${hintSafe}</span>\\` : ""}\n                          </div>\n                        </div>\n\n                        <div class="ms-saved-right">\n                          <div class="ms-saved-kpis">\n                            <div class="ms-kpi">\n                              <div class="ms-kpi-label">Étape</div>\n                              <div class="ms-kpi-value">\\${escapeHtml(stage)}</div>\n                            </div>\n                            <div class="ms-kpi">\n                              <div class="ms-kpi-label">Days</div>\n                              <div class="ms-kpi-value">\\${escapeHtml(String(count))}</div>\n                            </div>\n                          </div>\n\n                          <div class="ms-saved-actions c-actions">\n                            <button type="button" class="ms-btn-row ms-consult">Consulter</button>\n                            <button type="button" class="ms-btn-row ms-edit">Modifier</button>\n                            <button type="button" class="ms-btn-row ms-delete">Effacer</button>\n                          </div>\n                        </div>\n                      </div>\n                    \\`;\n                  })\n                  .join("")}\n              </div>\n            </div>\n          \\`;\n\n          // Wire buttons (unchanged)\n          savedPanel.querySelectorAll(".ms-saved-tr").forEach((rowEl) => {\n            const editBtn = rowEl.querySelector(".ms-edit");\n            const id = (rowEl.getAttribute("data-id") || "").trim();\n            const rawDates = (rowEl.getAttribute("data-dates") || "").trim();\n            const consultBtn = rowEl.querySelector(".ms-consult");\n\n            if (editBtn) {\n              editBtn.addEventListener("click", () => {\n                const id = (rowEl.getAttribute("data-id") || "").trim();\n                const title = rowEl.getAttribute("data-title") || "";\n                const stageRaw = (rowEl.getAttribute("data-stage") || "").trim(); // expects option/exploration/prevalidation/retenue\n                const desc = rowEl.getAttribute("data-desc") || "";\n                const rawDates = (rowEl.getAttribute("data-dates") || "").trim();\n\n                // Pre-fill modal fields\n                if (modalTitle) modalTitle.value = title;\n                if (modalStage) modalStage.value = stageRaw || "";\n                if (modalDesc) modalDesc.value = desc;\n\n                // Store which saved_item_id we are editing (must happen before rendering)\n                MS.editingId = id;\n                MS.editingDates = (rawDates || "")\n                  .split(",")\n                  .map(normalizeYmd)\n                  .filter(Boolean);\n\n                // Render date chips (edit mode = removable)\n                renderModalDateChipsEdit();\n\n                // Switch modal wording to edit mode ---\n                const modalHeading = document.getElementById("ms-save-title");\n                if (modalHeading) modalHeading.textContent = "Modifier cette liste";\n                if (modalSubmit) modalSubmit.textContent = "Mettre à jour";\n\n                // Open modal\n                if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n                modalBackdrop.hidden = false;\n                modalBackdrop.setAttribute("aria-hidden", "false");\n              });\n            }\n\n            const deleteBtn = rowEl.querySelector(".ms-delete");\n\n            if (consultBtn) {\n              consultBtn.addEventListener("click", () => {\n                const nextDates = rawDates\n                  .split(",")\n                  .map((s) => normalizeYmd(s))\n                  .filter(Boolean)\n                  .slice(0, 7);\n\n                if (!nextDates.length) {\n                  alert("Impossible de consulter : cet enregistrement ne contient pas ses dates (API /saved-items/list).");\n                  return;\n                }\n\n                const next = new URLSearchParams();\n                next.set("selected_dates", nextDates.join(","));\n                next.set("selected_date", nextDates[0]);\n                window.location.href = "/app/insightevent/days?" + next.toString();\n              });\n            }\n\n            if (deleteBtn) {\n              deleteBtn.addEventListener("click", async () => {\n                if (!id) return;\n                deleteBtn.disabled = true;\n\n                try {\n                  const res = await fetch("/api/saved-items/delete", {\n                    method: "POST",\n                    headers: { "content-type": "application/json", "accept": "application/json" },\n                    body: JSON.stringify({ saved_item_id: id }),\n                  });\n\n                  const ct = (res.headers.get("content-type") || "").toLowerCase();\n                  const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n                  if (!res.ok || !json?.ok) {\n                    throw new Error(json?.error || \\`Erreur API (\\${res.status})\\`);\n                  }\n\n                  await loadSavedItems();\n                } catch (e) {\n                  alert(e?.message || "Erreur.");\n                } finally {\n                  deleteBtn.disabled = false;\n                }\n              });\n            }\n          });\n        }\n\n        // Modal wiring\n        if (modalClose) modalClose.addEventListener("click", closeSaveModal);\n        if (modalCancel) modalCancel.addEventListener("click", closeSaveModal);\n        if (modalBackdrop) {\n          modalBackdrop.addEventListener("click", (e) => {\n            if (e.target === modalBackdrop) closeSaveModal();\n          });\n          document.addEventListener("keydown", (e) => {\n            if (e.key === "Escape" && !modalBackdrop.hidden) closeSaveModal();\n          });\n        }\n        if (modalSubmit) modalSubmit.addEventListener("click", saveCurrentSelection);\n\n        // ✅ INSERT THIS BLOCK RIGHT HERE (immediately after the line above)\n        if (modalDates) {\n          modalDates.addEventListener("click", (e) => {\n            const chip = e?.target?.closest?.(".ms-chip-date.removable[data-date]");\n            if (!chip) return;\n            const d = chip.getAttribute("data-date") || "";\n            removeDraftDate(d);\n          });\n        }\n\n        function escapeHtml(v) {\n          return String(v ?? "")\n            .replace(/&/g, "&amp;")\n            .replace(/</g, "&lt;")\n            .replace(/>/g, "&gt;")\n            .replace(/"/g, "&quot;")\n            .replace(/\'/g, "&#039;");\n        }\n\n        function renderModalDateChipsCreate(arr) {\n          if (!modalDates) return;\n          const dates = Array.isArray(arr) ? arr.map(normalizeYmd).filter(Boolean) : [];\n          modalDates.innerHTML = dates\n            .map(\n              (d) =>\n                \\`<button type="button" class="ms-chip-date removable" data-date="\\${escapeHtml(d)}">\\${escapeHtml(d)}</button>\\`\n            )\n            .join("");\n        }\n\n        function renderModalDateChipsEdit() {\n          if (!modalDates) return;\n\n          const dates = Array.isArray(MS.editingDates) ? MS.editingDates.map(normalizeYmd).filter(Boolean) : [];\n\n          modalDates.innerHTML = dates\n            .map(d => \\`<button type="button" class="ms-chip-date removable" data-date="\\${escapeHtml(d)}">\\${escapeHtml(d)}</button>\\`)\n            .join("");\n\n          // delegate inside modalDates (safe re-render)\n          modalDates.querySelectorAll("button[data-date]").forEach((btn) => {\n            btn.addEventListener("click", () => {\n              const d = (btn.getAttribute("data-date") || "").trim();\n              if (!d) return;\n\n              // remove locally (no backend write yet)\n              MS.editingDates = (Array.isArray(MS.editingDates) ? MS.editingDates : [])\n                .map(normalizeYmd)\n                .filter(Boolean)\n                .filter(x => x !== d);\n\n              // prevent empty list\n              if (MS.editingDates.length === 0) {\n                MS.editingDates = [d]; // keep at least one\n                showSaveError("Au moins une date est requise.");\n                return;\n              }\n\n              // clear errors if any\n              if (modalError) { modalError.style.display = "none"; modalError.textContent = ""; }\n\n              renderModalDateChipsEdit();\n            });\n          });\n        }\n\n        function escapeHtml(v) {\n          return String(v ?? "")\n            .replace(/&/g, "&amp;")\n            .replace(/</g, "&lt;")\n            .replace(/>/g, "&gt;")\n            .replace(/"/g, "&quot;")\n            .replace(/\'/g, "&#039;");\n        }\n\n        function renderModalDateChips(datesArr) {\n          if (!modalDates) return;\n          const arr = Array.isArray(datesArr) ? datesArr : [];\n          modalDates.innerHTML = arr\n            .map((d) => {\n              return \\`<span class="ms-chip-date removable" data-date="\\${escapeHtml(d)}">\\${escapeHtml(d)}</span>\\`;\n            })\n            .join("");\n        }\n\n        function removeDraftDate(d) {\n          const ymd = String(d || "").trim();\n          if (!ymd) return;\n\n          // Never allow empty list (otherwise Saved item becomes invalid)\n          if (MS.draftDates.length <= 1) {\n            alert("Vous devez garder au moins 1 date.");\n            return;\n          }\n\n          const ok = window.confirm(\\`Retirer \\${ymd} de cette liste ?\\`);\n          if (!ok) return;\n\n          MS.draftDates = MS.draftDates.filter((x) => x !== ymd);\n\n          // Keep selectedDates in sync if we’re in selection mode\n          // (selectedDates is a const array, but mutable)\n          const idx = selectedDates.indexOf(ymd);\n          if (idx >= 0) selectedDates.splice(idx, 1);\n\n          // If selectedDate was removed, pick first remaining\n          if (selectedDate === ymd) {\n            selectedDate = MS.draftDates[0] || "";\n            if (selectedDate) params.set("selected_date", selectedDate);\n            else params.delete("selected_date");\n          }\n\n          // Sync URL selected_dates (if present)\n          if (selectedDates.length > 0) params.set("selected_dates", selectedDates.join(","));\n          else params.delete("selected_dates");\n\n          window.history.replaceState({}, "", "?" + params.toString());\n\n          renderModalDateChipsCreate(MS.draftDates);\n        }\n\n        function renderEmptyState() {\n          const pills = getPillsContainer();\n          if (pills) pills.innerHTML = "";\n\n          if (container) {\n            container.innerHTML = \\`\n              <div class="text-sm text-gray-600">\n                Aucun jour sélectionné. Retournez au mois pour choisir jusqu’à 7 dates.\n              </div>\n            \\`;\n          }\n        }\n\n        function medalBadge(medal) {\n          const m = (medal || "").toString();\n          if (!m) return "";\n          return \\`<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs border border-gray-200 bg-gray-50">\\${escapeHtml(m)}</span>\\`;\n        }\n\n        function renderPills(dayRowsByDate) {\n          const pillsContainer = getPillsContainer();\n          if (!pillsContainer) return;\n\n          ensureSelectedDaysStyles();\n\n          if (!selectedDates.length) {\n            pillsContainer.innerHTML = "";\n            return;\n          }\n\n          pillsContainer.innerHTML = \\`\n            <div class="ms-pills-row" role="list">\n              \\${selectedDates\n                .map((d) => {\n                  const isActive = d === selectedDate;\n                  const hasData = dayRowsByDate && dayRowsByDate.has(d);\n                  return \\`\n                    <button type="button"\n                      class="ms-pill \\${isActive ? "is-active" : ""}"\n                      data-date="\\${escapeHtml(d)}"\n                      \\${hasData ? "" : "disabled"}\n                      aria-pressed="\\${isActive ? "true" : "false"}">\n                      \\${escapeHtml(d)}\n                    </button>\n                  \\`;\n                })\n                .join("")}\n            </div>\n          \\`;\n\n          pillsContainer.querySelectorAll("button[data-date]").forEach((btn) => {\n            btn.addEventListener("click", () => {\n              const d = btn.getAttribute("data-date");\n              if (!d || d === selectedDate) return;\n\n              selectedDate = d;\n              params.set("selected_date", d);\n              window.history.replaceState({}, "", "?" + params.toString());\n\n              renderPills(dayRowsByDate);\n              renderFocusedDay(dayRowsByDate, MS.pointsCles);\n            });\n          });\n        }\n\n        function renderKeyFacts(keyFacts) {\n          const arr = Array.isArray(keyFacts) ? keyFacts : [];\n          if (arr.length === 0) return "";\n          const items = arr\n            .map(x => \\`<li class="text-sm text-gray-700">\\${escapeHtml(x)}</li>\\`)\n            .join("");\n          return \\`<ul class="list-disc pl-5 space-y-1">\\${items}</ul>\\`;\n        }\n\n        function renderPointsCles(pointsCles) {\n          const txt = (typeof pointsCles?.text === "string" ? pointsCles.text.trim() : "");\n\n          if (!txt) {\n            return \\`\n              <div class="border rounded-lg p-4">\n                <div class="text-sm text-gray-500">Points clés indisponibles.</div>\n              </div>\n            \\`;\n          }\n\n          return \\`\n            <div class="border rounded-lg p-4">\n              <div class="text-sm text-gray-400 mb-2">Points clés</div>\n              <p class="ms-takeaway preline">\\${escapeHtml(txt)}</p>\n            </div>\n          \\`;\n        }\n\n        function renderPanel(title, bodyHtml) {\n          return \\`\n            <div class="border rounded-lg p-4">\n              <div class="text-sm font-medium mb-2">\\${escapeHtml(title)}</div>\n              \\${bodyHtml}\n            </div>\n          \\`;\n        }\n\n        function renderFocusedDay(dayRowsByDate, pointsCles) {\n          if (!container) return;\n\n          ensureSelectedDaysStyles();\n\n          const row = dayRowsByDate.get(selectedDate);\n          if (!row) {\n            container.innerHTML = \\`\n              <div class="text-sm text-gray-600">\n                Aucune donnée trouvée pour \\${escapeHtml(selectedDate)}.\n              </div>\n            \\`;\n            return;\n          }\n\n          // ------------------------------\n          // Carousel DOM refs (AFTER innerHTML; scoped to container)\n          // ------------------------------\n          const stripEl = container.querySelector("#ms-carousel-strip");\n          const slotLeftEl = container.querySelector("#ms-slot-left");\n          const slotMidEl = container.querySelector("#ms-slot-mid");\n          const slotRightEl = container.querySelector("#ms-slot-right");\n\n          const getSlotDate = (slotEl) => {\n            const card = slotEl ? slotEl.querySelector(".ms-c-card.preview[data-date]") : null;\n            return card ? String(card.getAttribute("data-date") || "").trim() : "";\n          };\n\n          // ------------------------------\n          // Meta (Month / Week / DOW / Day number)\n          // ------------------------------\n          const meta = buildMetaForDate(selectedDate);\n\n          // ------------------------------\n          // Meaning line: compare score among selected days\n          // ------------------------------\n          const meaningText = (() => {\n            const scores = (Array.isArray(selectedDates) ? selectedDates : [])\n              .map((d) => {\n                const r = dayRowsByDate.get(d);\n                const s = r && typeof r.opportunity_score_final_local === "number" ? r.opportunity_score_final_local : null;\n                return s;\n              })\n              .filter((v) => v !== null);\n\n            const currentScore = typeof row.opportunity_score_final_local === "number" ? row.opportunity_score_final_local : null;\n            if (currentScore === null || scores.length <= 1) return "";\n\n            const max = Math.max(...scores);\n            const min = Math.min(...scores);\n\n            if (currentScore === max && currentScore !== min) return "Score le plus élevé parmi les jours sélectionnés";\n            if (currentScore === min && currentScore !== max) return "Score inférieur aux autres jours sélectionnés";\n            return "Score intermédiaire parmi les jours sélectionnés";\n          })();\n\n          // ------------------------------\n          // Context tags (MAX 3): daytype, vacation/holiday, commercial (first)\n          // ------------------------------\n          const ctxTags = (() => {\n            const tags = [];\n\n            // Convert unknown payloads (string | number | object | array) into safe human text\n            const tagText = (v) => {\n              if (v == null) return "";\n              if (typeof v === "string") return v.trim();\n              if (typeof v === "number" || typeof v === "boolean") return String(v);\n\n              if (Array.isArray(v)) {\n                // take first meaningful string from array\n                for (const it of v) {\n                  const t = tagText(it);\n                  if (t) return t;\n                }\n                return "";\n              }\n\n              if (typeof v === "object") {\n                // common “label/name/title” fields; extend if your structs differ\n                const o = v;\n                return (\n                  tagText(o.label) ||\n                  tagText(o.name) ||\n                  tagText(o.title) ||\n                  tagText(o.event_label) ||\n                  tagText(o.event_name) ||\n                  tagText(o.holiday_name) ||\n                  tagText(o.vacation_name) ||\n                  ""\n                );\n              }\n\n              return "";\n            };\n\n            // 1) daytype\n            if (meta.isWeekend === true) tags.push({ kind: "daytype", label: "Week-end" });\n            if (meta.isWeekend === false) tags.push({ kind: "daytype", label: "Semaine" });\n\n            // 2) vacation OR holiday (never both)\n            const vac = tagText(row.vacation_name);\n            const hol = tagText(row.holiday_name);\n            if (vac) tags.push({ kind: "break", label: vac });\n            else if (hol) tags.push({ kind: "break", label: hol });\n\n            // 3) commercial event (first non-empty only)\n            const ceRaw = row.commercial_events;\n            const ceArr = Array.isArray(ceRaw) ? ceRaw : (ceRaw ? [ceRaw] : []);\n            const firstCe = ceArr.map(tagText).find(Boolean);\n            if (firstCe) tags.push({ kind: "commercial", label: firstCe });\n\n            return tags.slice(0, 3);\n          })();\n\n          // ------------------------------\n          // Carousel model: 3 slots (prev / active / next) in ONE row\n          // ------------------------------\n          const dates = Array.isArray(selectedDates) ? selectedDates.slice() : [];\n          const n = dates.length;\n\n          const clampIdx = (i) => Math.max(0, Math.min(n - 1, i));\n          const modIdx = (i) => ((i % n) + n) % n;\n\n          let activeIdx = Math.max(0, dates.indexOf(selectedDate));\n          if (activeIdx === -1) activeIdx = 0;\n\n          const leftIdx = n >= 3 ? modIdx(activeIdx - 1) : (n === 2 ? (activeIdx === 0 ? null : 0) : null);\n          const rightIdx = n >= 3 ? modIdx(activeIdx + 1) : (n === 2 ? (activeIdx === 0 ? 1 : null) : null);\n\n          const cardHTML = (dateStr, kind) => {\n            if (!dateStr) return \\`<div class="ms-c-ghost" aria-hidden="true"></div>\\`;\n            const r = dayRowsByDate.get(dateStr);\n            const m = buildMetaForDate(dateStr);\n\n            const marker = r?.opportunity_medal ?? "";\n            const scoreInt =\n              typeof r?.opportunity_score_final_local === "number"\n                ? Math.round(r.opportunity_score_final_local)\n                : null;\n\n            const cls = kind === "active" ? "ms-c-card active" : "ms-c-card preview";\n            const onclick = kind === "active" ? "" : \\` data-date="\\${escapeHtml(dateStr)}"\\`;\n\n            return \\`\n              <div class="\\${cls}"\\${onclick} role="button" tabindex="0" aria-label="\\${escapeHtml(dateStr)}">\n                <div class="ms-c-dow">\\${escapeHtml(m.dow3)}</div>\n                <div class="ms-c-daynum">\\${escapeHtml(m.dayNum2)}</div>\n                <div class="ms-c-marker">\\${escapeHtml(marker)}</div>\n                <div class="ms-c-pill"><span class="ms-chip">OPPORTUNITÉ</span></div>\n                <div class="ms-c-score">\n                  <span>\\${scoreInt != null ? escapeHtml(scoreInt) : ""}</span><span class="muted">\\${scoreInt != null ? "/100" : ""}</span>\n                </div>\n              </div>\n            \\`;\n          };\n\n          // ------------------------------\n          // Sections (single column; fixed order)\n          // ------------------------------\n          const pointsClesHtml = renderPointsClesHexLike(pointsCles);\n          const alertesHtml = renderAlertesHexLike(row);\n          const concurrenceHtml = renderConcurrenceHexLike(row);\n          const meteoHtml = renderMeteoHexLike(row);\n\n          container.innerHTML = \\`\n            <div class="ms-days-wrap">\n              <div id="ms-selected-dates-bar" style="margin-bottom:12px;"></div>\n              <div class="ms-top-wrap">\n                <div class="ms-top-month">\\${escapeHtml(meta.monthYear)}</div>\n                <div class="ms-top-week">\\${escapeHtml(meta.weekLabel)}</div>\n              </div>\n\n              <div class="ms-carousel-viewport">\n                <div class="ms-carousel-strip" id="ms-carousel-strip">\n                  <div class="ms-slot left"  id="ms-slot-left">\\${cardHTML(leftIdx != null ? dates[leftIdx] : null, "preview")}</div>\n                  <div class="ms-slot mid"   id="ms-slot-mid">\\${cardHTML(dates[activeIdx], "active")}</div>\n                  <div class="ms-slot right" id="ms-slot-right">\\${cardHTML(rightIdx != null ? dates[rightIdx] : null, "preview")}</div>\n                </div>\n              </div>\n\n              <div class="ms-analyse-wrap">\n                <div class="ms-analyse-line"><div class="ms-analyse-label">ANALYSE DU JOUR</div></div>\n                <div class="ms-analyse-meaning">\\${escapeHtml(meaningText)}</div>\n                <div class="ms-context-tags \\${ctxTags.length === 3 ? "ms-ctx--3" : ""}">\n                  \\${ctxTags.map((t) => \\`\n                    <div class="ms-ctx-tag">\n                      <span class="ms-ctx-ico">\\${ctxIconSVG(t.kind)}</span>\n                      <span>\\${escapeHtml(t.label)}</span>\n                    </div>\n                  \\`).join("")}\n                </div>\n              </div>\n\n              <div class="ms-panels">\n                \\${pointsClesHtml}\n                \\${alertesHtml}\n                \\${concurrenceHtml}\n                \\${meteoHtml}\n              </div>\n            </div>\n          \\`;\n\n          // Wire carousel preview clicks → animate axis rotation first, then rerender\n          function rotateCarousel(dir) {\n            const stripEl = container.querySelector("#ms-carousel-strip");\n            const slotLeftEl = container.querySelector("#ms-slot-left");\n            const slotMidEl = container.querySelector("#ms-slot-mid");\n            const slotRightEl = container.querySelector("#ms-slot-right");\n\n            if (!stripEl || !slotLeftEl || !slotMidEl || !slotRightEl) return;\n            if (MS.carouselAnimating) return;\n\n            const nextDate = dir === "left" ? getSlotDate(slotLeftEl) : getSlotDate(slotRightEl);\n            if (!nextDate || nextDate === selectedDate) return;\n\n            MS.carouselAnimating = true;\n            stripEl.classList.add("is-animating");\n\n            // Swap slot classes to trigger CSS transition (parallel “flow”)\n            if (dir === "left") {\n              slotLeftEl.classList.remove("left"); slotLeftEl.classList.add("mid");\n              slotMidEl.classList.remove("mid"); slotMidEl.classList.add("right");\n              slotRightEl.classList.remove("right"); slotRightEl.classList.add("left");\n            } else {\n              slotRightEl.classList.remove("right"); slotRightEl.classList.add("mid");\n              slotMidEl.classList.remove("mid"); slotMidEl.classList.add("left");\n              slotLeftEl.classList.remove("left"); slotLeftEl.classList.add("right");\n            }\n\n            const done = () => {\n              stripEl.classList.remove("is-animating");\n              MS.carouselAnimating = false;\n\n              selectedDate = nextDate;\n              params.set("selected_date", nextDate);\n              window.history.replaceState({}, "", "?" + params.toString());\n\n              renderPills(dayRowsByDate);\n              renderFocusedDay(dayRowsByDate, MS.pointsCles);\n            };\n\n            // More reliable: listen on the MID slot (it always transitions)\n            slotMidEl.addEventListener("transitionend", done, { once: true });\n          }\n\n          // Stable binding: delegate from container (container persists; innerHTML changes)\n          container.onclick = (e) => {\n            const card = e?.target?.closest?.(".ms-carousel-strip .ms-c-card.preview[data-date]");\n            if (!card) return;\n\n            const slot = card.closest(".ms-slot");\n            if (!slot) return;\n\n            if (slot.classList.contains("left")) rotateCarousel("left");\n            else if (slot.classList.contains("right")) rotateCarousel("right");\n          };\n\n          container.onkeydown = (e) => {\n            if (e.key !== "Enter" && e.key !== " ") return;\n\n            const card = e?.target?.closest?.(".ms-carousel-strip .ms-c-card.preview[data-date]");\n            if (!card) return;\n\n            const slot = card.closest(".ms-slot");\n            if (!slot) return;\n\n            e.preventDefault();\n\n            if (slot.classList.contains("left")) rotateCarousel("left");\n            else if (slot.classList.contains("right")) rotateCarousel("right");\n          };\n\n          // ------------------------------\n          // Local helpers (pure UI; no semantic changes)\n          // ------------------------------\n          function renderPointsClesHexLike(pc) {\n            const txt = pc?.text ? String(pc.text) : "";\n            if (!txt.trim()) {\n              return sectionHex("Points clés", "sparkle", \\`<div class="ms-muted">Points clés indisponibles.</div>\\`, "");\n            }\n\n            // IMPORTANT: preserve line breaks from deterministic renderer\n            const body = \\`\n              <div class="ms-takeaway" style="white-space:pre-line;">\\${escapeHtml(txt)}</div>\n            \\`;\n\n            return sectionHex("Points clés", "sparkle", body, "");\n          }\n\n          function renderAlertesHexLike(r) {\n            const major = r.is_major_realization_risk_flag === true;\n            const driver = r.major_realization_risk_driver ? String(r.major_realization_risk_driver) : "";\n            const lvl = typeof r.alert_level_max === "number" ? Math.round(r.alert_level_max) : null;\n\n            const wxLabel = (l) => {\n              if (l == null || l <= 0) return null;\n              return { 1: "niveau 1 (surveillance)", 2: "niveau 2 (attention)", 3: "niveau 3 (alerte)", 4: "niveau 4 (alerte forte)" }[l] || \\`niveau \\${l}\\`;\n            };\n\n            const wx = wxLabel(lvl);\n            const takeaway = major\n              ? (driver ? \\`Point de vigilance : \\${driver}.\\` : "Point de vigilance : un risque majeur est signalé.")\n              : \\`Aucune alerte majeure. Mobilité : non disponible. \\${wx ? \\`Météo : \\${wx}.\\` : "Météo : aucune alerte."}\\`;\n\n            const bullets = [\n              major\n                ? (driver ? \\`Point de vigilance : \\${driver}.\\` : "Point de vigilance : un risque majeur est signalé.")\n                : null,\n              "Alertes mobilité (train/métro) : non disponibles pour l’instant.",\n              wx ? \\`Alerte météo : \\${wx}.\\` : "Pas d’alerte météo à signaler.",\n            ].filter(Boolean);\n\n            return sectionHex(\n              "Alertes",\n              "alert",\n              \\`<div class="ms-takeaway">\\${escapeHtml(takeaway)}</div>\\`,\n              \\`<ul class="ms-ul">\\${bullets.map((x) => \\`<li>\\${escapeHtml(x)}</li>\\`).join("")}</ul>\\`\n            );\n          }\n\n          function renderConcurrenceHexLike(r) {\n            const all =\n              (Array.isArray(r?.top_events_500m) && r.top_events_500m.length ? r.top_events_500m :\n              Array.isArray(r?.top_events_5km)  && r.top_events_5km.length  ? r.top_events_5km  :\n              Array.isArray(r?.top_events_10km) && r.top_events_10km.length ? r.top_events_10km :\n              Array.isArray(r?.top_events_50km) ? r.top_events_50km : []);\n\n            const total50 = Number(r?.events_within_50km_count ?? 0);\n\n            if (all.length === 0 && total50 === 0) {\n              return sectionHex(\n                "Concurrence événementielle",\n                "calendar",\n                \\`<div class="ms-takeaway">Aucune concurrence significative détectée.</div>\\`,\n                ""\n              );\n            }\n\n            // ---- context: client industry (trusted semantic field) ----\n            const clientIndustry =\n              MS?.pointsCles?.location_context?.client_industry_code || null;\n\n            // ---- helpers ----\n            const fmtDistance = (m) => {\n              const v = Number(m);\n              if (!Number.isFinite(v)) return "";\n              if (v < 1000) return \\`\\${Math.round(v)} m\\`;\n              return \\`\\${(v / 1000).toFixed(1)} km\\`;\n            };\n\n            const shortText = (s, max = 120) => {\n              const t = String(s || "").replace(/\\\\s+/g, " ").trim();\n              if (!t) return "";\n              return t.length > max ? t.slice(0, max).trim() + "…" : t;\n            };\n\n            // City / place label:\n            // - prefer explicit name fields if present\n            // - never display pure numeric codes (ex: "9")\n            // - if cities_with_events is numeric, ignore it\n            const cityLabel = (e) => {\n              const pickFirstText = (arr) =>\n                (Array.isArray(arr) ? arr : [])\n                  .map((x) => String(x ?? "").trim())\n                  .find((x) => x && !/^\\\\d+$/.test(x)) || "";\n\n              // 1) explicit human-readable fields (most reliable)\n              const direct =\n                String(e?.city_name ?? "").trim() ||\n                String(e?.city ?? "").trim() ||\n                String(e?.commune_name ?? "").trim() ||\n                String(e?.location_city ?? "").trim() ||\n                String(e?.venue_city ?? "").trim();\n\n              if (direct && !/^\\\\d+$/.test(direct)) return direct;\n\n              // 2) cities_with_events (but it might be ids/codes)\n              const raw = e?.cities_with_events;\n\n              // array -> take first non-numeric token\n              if (Array.isArray(raw)) {\n                return pickFirstText(raw);\n              }\n\n              // string -> split, take first non-numeric token\n              const s = String(raw ?? "").trim();\n              if (!s) return "";\n\n              const token =\n                s\n                  .split(/[,;|]/)\n                  .map((x) => x.trim())\n                  .find((x) => x && !/^\\\\d+$/.test(x)) || "";\n\n              return token;\n            };\n\n            // ---- 1) same-industry first ----\n            let picked = all.filter(\n              (e) => clientIndustry && e?.industry_code === clientIndustry\n            );\n\n            // ---- 2) fallback: priority_rank (national > regional > local) ----\n            if (picked.length === 0) {\n              picked = [...all].sort((a, b) => {\n                const pa = Number(a?.keyword_priority_rank ?? 0);\n                const pb = Number(b?.keyword_priority_rank ?? 0);\n                if (pb !== pa) return pb - pa;\n\n                const ra = Number(a?.radius_precedence ?? 9);\n                const rb = Number(b?.radius_precedence ?? 9);\n                if (ra !== rb) return ra - rb;\n\n                return Number(a?.distance_m ?? 0) - Number(b?.distance_m ?? 0);\n              });\n            }\n\n            // ---- 3) enforce limits (max 3, min 1) ----\n            const shown = picked.slice(0, 3);\n            if (shown.length === 0 && all.length > 0) {\n              shown.push(all[0]);\n            }\n\n            // ---- rendering ----\n            const takeaway =\n              shown.length > 1\n                ? "Concurrence événementielle active à proximité."\n                : "Concurrence événementielle détectée.";\n\n            const list = \\`\n              <ul class="ms-ul">\n                \\${shown\n                  .map((e) => {\n                    const title = e?.event_label || "Événement";\n                    const dist = fmtDistance(e?.distance_m);\n                    const city = cityLabel(e);\n                    const desc = shortText(\n                      e?.description ||\n                      e?.longDescription ||\n                      e?.summary ||\n                      e?.subtitle ||\n                      e?.program ||\n                      e?.keywords,\n                      120\n                    );\n\n                    const industryBadge =\n                      clientIndustry && e?.industry_code === clientIndustry\n                        ? \\`<span class="ms-muted">· même secteur</span>\\`\n                        : "";\n\n                    const where =\n                      (city && dist) ? \\`\\${city} — \\${dist}\\` :\n                      (city) ? city :\n                      (dist) ? dist :\n                      "";\n\n                    return \\`\n                      <li>\n                        <span>\\${escapeHtml(title)}</span>\n                        \\${where ? \\` <span class="ms-muted">— \\${escapeHtml(where)}</span>\\` : ""}\n                        \\${industryBadge}\n                        \\${desc ? \\`<div class="ms-muted">\\${escapeHtml(desc)}</div>\\` : ""}\n                      </li>\n                    \\`;\n                  })\n                  .join("")}\n              </ul>\n            \\`;\n\n            return sectionHex(\n              "Concurrence événementielle",\n              "calendar",\n              \\`<div class="ms-takeaway">\\${escapeHtml(takeaway)}</div>\\`,\n              list\n            );\n          }\n\n          function renderMeteoHexLike(r) {\n            const wx = r.weather_label_fr ? String(r.weather_label_fr) : "";\n            const tmin = r.temperature_2m_min != null ? Math.round(Number(r.temperature_2m_min)) : null;\n            const tmax = r.temperature_2m_max != null ? Math.round(Number(r.temperature_2m_max)) : null;\n\n            const pp = r.precipitation_probability_max_pct != null ? Math.round(Number(r.precipitation_probability_max_pct)) : null;\n            const wind = r.wind_speed_10m_max != null ? Math.round(Number(r.wind_speed_10m_max)) : null;\n\n            const parts = [];\n            if (wx) parts.push(wx);\n            if (tmin != null || tmax != null) {\n              if (tmin != null && tmax != null) parts.push(\\`\\${Math.min(tmin,tmax)}–\\${Math.max(tmin,tmax)}°C\\`);\n              else if (tmin != null) parts.push(\\`min \\${tmin}°C\\`);\n              else parts.push(\\`max \\${tmax}°C\\`);\n            }\n            if (pp != null) parts.push(\\`pluie \\${pp}%\\`);\n            if (wind != null) parts.push(\\`vent \\${wind} km/h\\`);\n\n            const takeaway = parts.length ? \\`Météo : \\${parts.join(", ")}.\\` : "Météo : non disponible.";\n\n            const bullets = [];\n            if (wx) bullets.push(\\`Temps : \\${wx}.\\`);\n            if (pp != null) bullets.push(\\`Pluie : \\${pp}% (probabilité max).\\`);\n            if (wind != null) bullets.push(\\`Vent : \\${wind} km/h (max).\\`);\n            if (tmin != null && tmax != null) bullets.push(\\`Température : \\${Math.min(tmin,tmax)}°C à \\${Math.max(tmin,tmax)}°C.\\`);\n\n            return sectionHex(\n              "Météo / Faisabilité",\n              "sun",\n              \\`<div class="ms-takeaway">\\${escapeHtml(takeaway)}</div>\\`,\n              bullets.length ? \\`<ul class="ms-ul">\\${bullets.slice(0, 4).map((x) => \\`<li>\\${escapeHtml(x)}</li>\\`).join("")}</ul>\\` : ""\n            );\n          }\n\n          function sectionHex(title, iconKind, headHtml, belowHtml) {\n            const below = belowHtml && String(belowHtml).trim()\n              ? \\`<div class="ms-below">\\${belowHtml}</div>\\`\n              : "";\n\n            const kind = String(iconKind || "").toLowerCase().replace(/[^a-z0-9_-]/g, "");\n            const kindClass = kind ? \\` ms-section--\\${kind}\\` : "";\n\n            return \\`\n              <div class="ms-section\\${kindClass}">\n                <div class="ms-kicker">\\${escapeHtml(title)}</div>\n                <div class="ms-card">\n                  <div class="ms-head">\n                    <div class="ms-ico">\\${sectionIconSVG(iconKind)}</div>\n                    <div class="ms-head-content">\\${headHtml}</div>\n                  </div>\n                  \\${below}\n                </div>\n              </div>\n            \\`;\n          }\n\n          function buildMetaForDate(ymd) {\n            const d = parseYmdToDate(ymd);\n            if (!d) {\n              return { monthYear: "", weekLabel: "", dow3: "", dayNum2: "", isWeekend: null };\n            }\n\n            const dow3 = ["LUN", "MAR", "MER", "JEU", "VEN", "SAM", "DIM"][((d.getDay() + 6) % 7)];\n            const dayNum2 = String(d.getDate()).padStart(2, "0");\n\n            const monthYearRaw = new Intl.DateTimeFormat("fr-FR", { month: "long", year: "numeric" }).format(d);\n            const monthYear = monthYearRaw ? monthYearRaw.charAt(0).toUpperCase() + monthYearRaw.slice(1) : "";\n\n            const week = isoWeekNumber(d);\n            const weekLabel = \\`SEMAINE \\${week}\\`;\n\n            const isWeekend = ((d.getDay() === 0) || (d.getDay() === 6));\n\n            return { monthYear, weekLabel, dow3, dayNum2, isWeekend };\n          }\n\n          function parseYmdToDate(ymd) {\n            const m = /^(\\\\d{4})-(\\\\d{2})-(\\\\d{2})$/.exec(String(ymd || "").trim());\n            if (!m) return null;\n            const y = Number(m[1]);\n            const mo = Number(m[2]);\n            const da = Number(m[3]);\n            const dt = new Date(Date.UTC(y, mo - 1, da));\n            if (Number.isNaN(dt.getTime())) return null;\n            return dt;\n          }\n\n          function isoWeekNumber(dateUtc) {\n            // dateUtc is a Date built in UTC; compute ISO week in UTC to avoid TZ drift.\n            const d = new Date(Date.UTC(dateUtc.getUTCFullYear(), dateUtc.getUTCMonth(), dateUtc.getUTCDate()));\n            // Thursday in current week decides the year.\n            const day = d.getUTCDay() || 7;\n            d.setUTCDate(d.getUTCDate() + 4 - day);\n            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\n            return weekNo;\n          }\n\n          function sectionIconSVG(kind) {\n            // Matches the Hex set (alert/info/calendar/sun/sparkle); no external deps.\n            const icons = {\n              alert: \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 9v4" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M12 17h.01" stroke="#111827" stroke-width="3" stroke-linecap="round"/>\n                <path d="M10.3 4.3l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.7-2.7l-8-14a2 2 0 0 0-3.4 0z" stroke="#111827" stroke-width="1.6"/>\n              </svg>\\`,\n              info: \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" stroke="#111827" stroke-width="1.6"/>\n                <path d="M12 10v7" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M12 7h.01" stroke="#111827" stroke-width="3" stroke-linecap="round"/>\n              </svg>\\`,\n              calendar: \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M7 2v3M17 2v3" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M3.5 9h17" stroke="#111827" stroke-width="1.6"/>\n                <path d="M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z" stroke="#111827" stroke-width="1.6"/>\n              </svg>\\`,\n              sun: \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" stroke="#111827" stroke-width="1.6"/>\n                <path d="M12 2v2M12 20v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M2 12h2M20 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"\n                      stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>\n              </svg>\\`,\n              sparkle: \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 2l1.2 5.1L18 9l-4.8 1.9L12 16l-1.2-5.1L6 9l4.8-1.9L12 2z" stroke="#111827" stroke-width="1.6"/>\n              </svg>\\`,\n            };\n            return icons[kind] || icons.info;\n          }\n\n          function ctxIconSVG(kind) {\n            if (kind === "daytype") {\n              return \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M4 7h16M4 12h16M4 17h16" stroke="#6b7280" stroke-width="1.8" stroke-linecap="round"/>\n                <path d="M7 4v16M12 4v16M17 4v16" stroke="#6b7280" stroke-width="1.2" stroke-linecap="round" opacity="0.55"/>\n              </svg>\\`;\n            }\n            if (kind === "break") {\n              return \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                <path d="M12 3c-4.8 0-8.7 3.5-9.5 8.1h19C20.7 6.5 16.8 3 12 3z" stroke="#6b7280" stroke-width="1.6" stroke-linejoin="round"/>\n                <path d="M12 11v7a2 2 0 0 1-4 0" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/>\n                <path d="M6.2 11c.7 1.2 2 2 3.5 2s2.8-.8 3.5-2c.7 1.2 2 2 3.5 2s2.8-.8 3.5-2" stroke="#6b7280" stroke-width="1.2" stroke-linecap="round" opacity="0.65"/>\n              </svg>\\`;\n            }\n            return \\`<svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n              <path d="M20 12v6a2 2 0 0 1-2 2H8l-4-4V6a2 2 0 0 1 2-2h6" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>\n              <path d="M16 3h5v5" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>\n              <path d="M21 3l-8 8" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round"/>\n            </svg>\\`;\n          }\n        }\n\n        async function fetchDays() {\n          if (!container) return null;\n\n          const loc = String(LOCATION_ID || "").trim();\n          if (!loc) {\n            container.innerHTML = \'<div class="text-sm text-red-600">Erreur: location_id manquant.</div>\';\n            return null;\n          }\n\n          if (!Array.isArray(selectedDates) || selectedDates.length === 0) {\n            return { days: [], points_cles: null };\n          }\n\n          const qs = new URLSearchParams();\n          qs.set("location_id", loc);\n          qs.set("selected_dates", selectedDates.join(","));\n\n          const apiUrl = "/api/insight/days?" + qs.toString();\n\n          const controller = new AbortController();\n          const timeout = setTimeout(() => controller.abort(), 15000);\n\n          try {\n            const res = await fetch(apiUrl, {\n              method: "GET",\n              headers: { Accept: "application/json" },\n              signal: controller.signal,\n              cache: "no-store",\n            });\n\n            if (!res.ok) {\n              const text = await res.text().catch(() => "");\n              throw new Error("API error " + res.status + (text ? " :: " + text.slice(0, 200) : ""));\n            }\n\n            const ct = (res.headers.get("content-type") || "").toLowerCase();\n            if (!ct.includes("application/json")) {\n              const text = await res.text().catch(() => "");\n              throw new Error("API returned non-JSON" + (text ? " :: " + text.slice(0, 200) : ""));\n            }\n\n            return await res.json();\n          } finally {\n            clearTimeout(timeout);\n          }\n        }\n\n        async function fetchSavedItems() {\n          // IMPORTANT: use your existing real endpoint.\n          // Your screenshot shows you already have: src/pages/api/saved-items/list (POST).\n          const res = await fetch("/api/saved-items/list", {\n            method: "POST",\n            headers: { "content-type": "application/json", "accept": "application/json" },\n            body: JSON.stringify({ limit: 50, offset: 0, stage: null }),\n            cache: "no-store",\n          });\n\n          const ct = (res.headers.get("content-type") || "").toLowerCase();\n          const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n          if (!res.ok || !json?.ok) return [];\n          return Array.isArray(json.items) ? json.items : [];\n        }\n\n        async function loadSavedItems() {\n          const savedPanel = getSavedPanel();\n          if (!savedPanel) return;\n          savedPanel.innerHTML = \\`<div class="text-gray-400 text-sm">Chargement…</div>\\`;\n          const items = await fetchSavedItems().catch(() => []);\n          renderSavedPanel(items);\n        }\n\n        async function fetchSavedItemById(saved_item_id) {\n          const res = await fetch("/api/saved-items/get", {\n            method: "POST",\n            headers: { "content-type": "application/json", accept: "application/json" },\n            body: JSON.stringify({ saved_item_id }),\n            cache: "no-store",\n          });\n\n          const ct = (res.headers.get("content-type") || "").toLowerCase();\n          const json = ct.includes("application/json") ? await res.json().catch(() => null) : null;\n\n          if (!res.ok || !json?.ok || !json?.item) {\n            const msg = json?.error || \\`Erreur get (\\${res.status})\\`;\n            throw new Error(msg);\n          }\n\n          return json.item;\n        }\n\n        function maybeResolveSavedItemId() {\n          // Only run if we have a saved_item_id in the URL\n          if (!savedItemId) return false;\n\n          // If you already have selected_dates, no need to resolve/redirect.\n          if (Array.isArray(selectedDates) && selectedDates.length > 0) return false;\n\n          // Kick off async resolver; return true to stop the rest of the page from running.\n          (async () => {\n            try {\n              // Render a minimal loading state (no new UI, just reuse existing)\n              setLayoutMode("detail");\n              if (container) {\n                container.style.display = "";\n                container.innerHTML = \\`<div class="text-gray-400 text-sm">Chargement…</div>\\`;\n              }\n\n              const item = await fetchSavedItemById(savedItemId);\n\n              const dates = extractDatesFromSavedItem(item)\n                .map(normalizeYmd)\n                .filter(Boolean)\n                .slice(0, 7);\n\n              if (!dates.length) {\n                throw new Error("Cet enregistrement ne contient aucune date.");\n              }\n\n              // Canonical redirect to selection mode (keeps UX stable + uses your existing flow)\n              const next = new URLSearchParams(params);\n              next.delete("saved_item_id"); // IMPORTANT: avoids resolver loops\n              next.set("selected_dates", dates.join(","));\n              next.set("selected_date", dates[0]);\n\n              window.location.replace("/app/insightevent/days?" + next.toString());\n            } catch (e) {\n              // If get fails, fall back to list mode + show list (and optionally error)\n              console.error(e);\n\n              setLayoutMode("list");\n              await loadSavedItems().catch(() => {});\n\n              if (container) {\n                container.style.display = "";\n                container.innerHTML =\n                  \\`<div class="text-sm text-red-600">Impossible d’ouvrir cet enregistrement.</div>\\` +\n                  \\`<div class="mt-2 text-xs text-gray-500 break-words">\\${escapeHtml(e?.message || "Erreur.")}</div>\\`;\n              }\n            }\n          })();\n\n          return true;\n        }\n\n        // --------------------\n        // saved_item_id resolver → canonical redirect\n        // --------------------\n        if (maybeResolveSavedItemId()) return;\n\n        // --------------------\n        // LIST MODE (no selection)\n        // --------------------\n        if (!Array.isArray(selectedDates) || selectedDates.length === 0) {\n          setLayoutMode("list");\n\n          // Do NOT render empty state yet. Decide after we know if saved items exist.\n          (async () => {\n            const savedPanel = getSavedPanel();\n            if (savedPanel) savedPanel.innerHTML = \\`<div class="text-gray-400 text-sm">Chargement…</div>\\`;\n\n            const items = await fetchSavedItems().catch(() => []);\n            renderSavedPanel(items);\n\n            // Main column behavior depends on whether items exist\n            if (Array.isArray(items) && items.length > 0) {\n              if (pillsContainer) pillsContainer.innerHTML = "";\n\n              if (container) {\n                container.innerHTML = "";\n                container.style.display = "none";\n              }\n            } else {\n              if (container) container.style.display = ""; // restore if previously hidden\n              renderEmptyState();\n            }\n          })();\n\n          return;\n        }\n\n        // If we do have selected days: hide saved panel (no overlap with selected-days UX).\n        setLayoutMode("detail");\n\n        if (container) container.style.display = "";\n\n        (async function init() {\n          try {\n            const data = await fetchDays();\n            if (!data) {\n              // fetchDays already rendered the error state.\n              return;\n            }\n\n            const daysArr = Array.isArray(data.days) ? data.days : [];\n            const byDate = new Map();\n\n            for (const r of daysArr) {\n              const d = (r && r.date != null ? String(r.date) : "").trim();\n              if (d) byDate.set(d, r);\n            }\n\n            MS.pointsCles = data.points_cles ?? null;\n\n            if ((!selectedDate || !byDate.has(selectedDate)) && selectedDates.length > 0) {\n              const firstFound = selectedDates.find((d) => byDate.has(d));\n              if (firstFound) {\n                selectedDate = firstFound;\n                params.set("selected_date", selectedDate);\n                window.history.replaceState({}, "", "?" + params.toString());\n              }\n            }\n\n            renderPills(byDate);\n            renderFocusedDay(byDate, MS.pointsCles);\n          } catch (e) {\n            if (container) {\n              const msg =\n                e && typeof e.message === "string" && e.message.trim()\n                  ? e.message\n                  : "Erreur de chargement.";\n              container.innerHTML =\n                \'<div class="text-sm text-red-600">Erreur de chargement.</div>\' +\n                \'<div class="mt-2 text-xs text-gray-500 break-words">\' +\n                escapeHtml(msg) +\n                "</div>";\n            }\n            console.error(e);\n          }\n        })();\n      })();\n    })();<\/script> '])), maybeRenderHead(), addAttribute(location_id, "data-location-id"), renderComponent($$result3, "InsightBottomBar", $$InsightBottomBar, { "active": "days", "showActions": show_actions }), defineScriptVars({ location_id })) })} ` })}`;
}, "/Users/julendeajuriaguerra/Documents/Muse_Square/Muse_Square_Website/muse-square/src/pages/app/insightevent/days.astro", void 0);
const $$file = "/Users/julendeajuriaguerra/Documents/Muse_Square/Muse_Square_Website/muse-square/src/pages/app/insightevent/days.astro";
const $$url = "/app/insightevent/days";
const _page = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({
  __proto__: null,
  default: $$Days,
  file: $$file,
  prerender,
  url: $$url
}, Symbol.toStringTag, { value: "Module" }));
const page = () => _page;
export {
  page,
  renderers
};
