/* empty css                                          */
import { e as createAstro, f as createComponent, k as renderComponent, r as renderTemplate, l as defineScriptVars, m as maybeRenderHead } from "../../../chunks/astro/server_C4zwJFjj.mjs";
import "piccolore";
import { a as $$SignedOut, b as $$SignedIn, $ as $$BaseLayout } from "../../../chunks/BaseLayout_B7lVY6IF.mjs";
import { $ as $$InsightBottomBar } from "../../../chunks/InsightBottomBar_CMpl7VY1.mjs";
/* empty css                                       */
import { renderers } from "../../../renderers.mjs";
var __freeze = Object.freeze;
var __defProp = Object.defineProperty;
var __template = (cooked, raw) => __freeze(__defProp(cooked, "raw", { value: __freeze(raw || cooked.slice()) }));
var _a, _b;
const $$Astro = createAstro("http://localhost:4322");
const prerender = false;
const $$Month = createComponent(async ($$result, $$props, $$slots) => {
  const Astro2 = $$result.createAstro($$Astro, $$props, $$slots);
  Astro2.self = $$Month;
  function ymdUtcToday() {
    const now = /* @__PURE__ */ new Date();
    const y = now.getUTCFullYear();
    const m = String(now.getUTCMonth() + 1).padStart(2, "0");
    const d = String(now.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
  const u = new URL(Astro2.request.url);
  if (!u.searchParams.get("window_start_date")) {
    const base = u.searchParams.get("selected_date") || u.searchParams.get("anchor_date") || ymdUtcToday();
    u.searchParams.set("window_start_date", base);
    u.searchParams.set("selected_date", base);
    u.searchParams.set("anchor_date", base);
    return Astro2.redirect(u.pathname + u.search, 302);
  }
  const location_id = Astro2.locals && typeof Astro2.locals.location_id === "string" && Astro2.locals.location_id.trim() ? Astro2.locals.location_id.trim() : null;
  return renderTemplate`${renderComponent($$result, "SignedOut", $$SignedOut, {}, { "default": async ($$result2) => renderTemplate(_a || (_a = __template([' <script>\n    window.location.href = "/sign-in";\n  <\/script> ']))) })} ${renderComponent($$result, "SignedIn", $$SignedIn, {}, { "default": async ($$result2) => renderTemplate` ${renderComponent($$result2, "BaseLayout", $$BaseLayout, { "title": "Insight Event ‚Äî Mois", "hideSurveyCta": true, "hideFooter": true }, { "default": async ($$result3) => renderTemplate(_b || (_b = __template([" ", `<div id="ie-30d-root" data-role="ie-30d-root"> <main id="ie-30d-main" data-role="ie-30d-main"> <header id="ie-30d-header" data-role="ie-30d-header"> <nav id="ie-breadcrumb" aria-label="Breadcrumb"> <span class="ie-breadcrumb-root">Insight Event</span> <span class="ie-breadcrumb-sep">/</span> <span class="ie-breadcrumb-current" id="ie-breadcrumb-current">Mois</span> </nav> </header> <section id="ie-30d-top3" data-role="ie-30d-top3"> <div id="ie-30d-top3-header"> <div id="ie-30d-top3-title">TOP 3 JOURS</div> <div id="ie-30d-top3-subtitle">Bas√© sur score d'opportunit√©</div> </div> <div id="ie-30d-top3-cards" data-role="ie-30d-top3-cards"> <!-- TOP3_ANCHOR --> </div> </section> <section id="ie-30d-takeaway" data-role="ie-30d-takeaway"> <div id="ie-30d-takeaway-header" data-role="ie-30d-takeaway-header"> <div id="ie-30d-takeaway-title" data-role="ie-30d-takeaway-title"> <span aria-hidden="true">‚ú¶</span> <span>Points cl√©s</span> </div> <div>Insight IA</div> </div> <div id="ie-30d-takeaway-card" data-role="ie-30d-takeaway-card"> <p id="ie-30d-takeaway-text" data-role="ie-30d-takeaway-text"><!-- TAKEAWAY_ANCHOR --></p> </div> </section> <!-- =========================
        R√âGLAGES AVANC√âS (v1) ‚Äî Contraintes m√©tier
        Placement: directly under Top 3 cards (affects recommendations only)
        ========================= --> <section id="ie-30d-constraints" data-role="ie-30d-constraints" aria-label="R√©glages avanc√©s"> <details id="ie-constraints-details"> <summary id="ie-constraints-summary" class="ie-section-header ie-filters-header"> <span class="ie-filters-icon" aria-hidden="true">‚öôÔ∏é</span> <span class="ie-section-title">Filtres</span> </summary> <div id="ie-constraints-body"> <div id="ie-constraints-row"> <div class="ms-chip-grid" role="group" aria-label="Contraintes m√©tier"> <button type="button" class="ms-chip" data-checkbox="ie-filter-publicHoliday"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Jours f√©ri√©s</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-schoolHoliday"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Vacances scolaires</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-promoDays"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Jours promo</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-competition"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Forte concurrence</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-badWeather"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Fortes intemp√©ries</span> </button> <!-- optional spacer so row 2 aligns perfectly under col 3 --> <span class="ms-chip-spacer" aria-hidden="true"></span> </div> <!-- hidden inputs: JS reads these by id --> <input id="ie-filter-publicHoliday" type="checkbox" hidden> <input id="ie-filter-schoolHoliday" type="checkbox" hidden> <input id="ie-filter-promoDays" type="checkbox" hidden> <input id="ie-filter-competition" type="checkbox" hidden> <input id="ie-filter-badWeather" type="checkbox" hidden> </div> </div> </details> </section> <section id="ie-30d-calendar-section" data-role="ie-30d-calendar-section"> <div id="ie-30d-calendar-header"> <div>CALENDRIER</div> <div></div> </div> <div id="ie-30d-calendar-card"> <div id="ie-30d-month-header" data-role="ie-30d-month-header" data-window-start=""> <button id="ie-30d-month-prev" class="ie-30d-month-nav" type="button" aria-label="Mois pr√©c√©dent">‚Äπ</button> <h2 id="ie-30d-display-label" data-role="ie-30d-display-label"></h2> <button id="ie-30d-month-next" class="ie-30d-month-nav" type="button" aria-label="Mois suivant">‚Ä∫</button> </div> <div id="ie-30d-calendar" data-role="ie-30d-calendar"> <div id="ie-30d-weekdays" data-role="ie-30d-weekdays"> <div class="ie-30d-weekday">Lun</div> <div class="ie-30d-weekday">Mar</div> <div class="ie-30d-weekday">Mer</div> <div class="ie-30d-weekday">Jeu</div> <div class="ie-30d-weekday">Ven</div> <div class="ie-30d-weekday">Sam</div> <div class="ie-30d-weekday">Dim</div> </div> <div id="ie-30d-grid" data-role="ie-30d-grid"> <!-- GRID_ANCHOR --> </div> </div> </div> </section> <!-- Month intro overlay (client-only, v1: localStorage) --> <div id="ms-month-intro" class="ms-month-intro hidden" role="dialog" aria-modal="true" aria-labelledby="ms-month-intro-title"> <div class="ms-month-intro__card"> <div class="ms-month-intro__icon" aria-hidden="true">üóìÔ∏è</div> <h2 id="ms-month-intro-title" class="ms-month-intro__title">
Comment utiliser le calendrier
</h2> <ul class="ms-month-intro__list"> <li><strong>A, B et C</strong> indiquent si un jour est plus ou moins favorable pour votre √©v√®nement.</li> <li>Les signes <strong>"+"</strong> et <strong>"‚àí"</strong> pr√©cisent si le jour est meilleur ou l√©g√®rement en dessous de la moyenne.</li> <li><strong>Cliquez sur 1 √† 7 jours</strong> pour voir le d√©tail de chaque journ√©e.</li> </ul> <button type="button" class="ms-month-intro__cta" id="ms-month-intro-dismiss">
NE PLUS AFFICHER
</button> </div> </div> <script>
          (function () {
            const KEY = "ms_month_intro_dismissed_v1";

            const root = document.getElementById("ms-month-intro");
            if (!root) return;

            const dismissBtn = document.getElementById("ms-month-intro-dismiss");
            const backdrop = root.querySelector(".ms-month-intro__backdrop");

            const hide = () => {
              root.classList.add("hidden");
              root.setAttribute("aria-hidden", "true");
              document.documentElement.style.overflow = "";
              document.body.style.overflow = "";
            };

            const show = () => {
              root.classList.remove("hidden");
              root.removeAttribute("aria-hidden");
              document.documentElement.style.overflow = "hidden";
              document.body.style.overflow = "hidden";
            };

            // Show only if user did not dismiss
            try {
              const dismissed = window.localStorage.getItem(KEY) === "1";
              if (!dismissed) show();
              else hide();
            } catch (_) {
              // If storage blocked, default to showing once per page load
              show();
            }

            const dismissForever = () => {
              try { window.localStorage.setItem(KEY, "1"); } catch (_) {}
              hide();
            };

            if (dismissBtn) dismissBtn.addEventListener("click", dismissForever);

            // Optional niceties (safe + standard UX):
            // click outside closes (WITHOUT saving preference)
            if (backdrop) backdrop.addEventListener("click", hide);

            // Escape closes (WITHOUT saving preference)
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && !root.classList.contains("hidden")) hide();
            });
          })();
        <\/script> </main> <div id="ie-30d-bottom-bar" data-role="ie-30d-bottom-bar"> <div id="ie-30d-bottom-inner"> <div id="ie-30d-selected-wrap"> <div id="ie-30d-selected-row"> <div id="ie-30d-selected-title">CHOIX (0/7)</div> <div id="ie-30d-selected-pills" aria-label="Selected days"></div> <div id="ie-30d-selected-hint" style="display:none;">Maximum 7 jours</div> </div> </div> <button id="ie-30d-view-details" data-role="ie-30d-view-details" type="button">Voir ‚Üí</button> </div> </div> `, "  <script>(function(){", '\n    console.log("[IE] Month UI (Astro) loaded");\n    console.log("[IE][DBG] month.astro inline script: BUILD_ID=2026-01-30-AAA", Date.now());\n\n    // ---- HARD RUNTIME PROBE (must prove script is executing + handlers bind + clicks fire) ----\n    window.addEventListener("error", (ev) => {\n      try {\n        console.error("[IE][window.error]", ev?.message, ev?.filename, ev?.lineno, ev?.colno, ev?.error);\n      } catch (_) {}\n    });\n\n    window.addEventListener("unhandledrejection", (ev) => {\n      try {\n        console.error("[IE][unhandledrejection]", ev?.reason);\n      } catch (_) {}\n    });\n\n    console.log("[IE] Script reached: after global error hooks");\n\n    // --- Pills -> hidden checkbox bridge (must run after DOM is present) ---\n    function bindConstraintChips(){\n      document.querySelectorAll(".ms-chip").forEach((chip) => {\n        const id = chip.getAttribute("data-checkbox");\n        const input = id ? document.getElementById(id) : null;\n        if (!(input instanceof HTMLInputElement)) return;\n\n        const sync = () => chip.classList.toggle("is-active", input.checked === true);\n        sync();\n\n        chip.addEventListener("click", () => {\n          input.checked = !input.checked;\n          input.dispatchEvent(new Event("change", { bubbles: true }));\n          sync();\n        });\n      });\n    }\n\n    if (document.readyState === "loading") {\n      document.addEventListener("DOMContentLoaded", bindConstraintChips, { once: true });\n    } else {\n      bindConstraintChips();\n    }\n\n    // -----------------------------\n    // Constraints UI -> predicates\n    // -----------------------------\n    function readConstraintFilters(){\n      const get = (id) => {\n        const el = document.getElementById(id);\n        return el instanceof HTMLInputElement ? el.checked === true : false;\n      };\n\n      return {\n        publicHoliday: get("ie-filter-publicHoliday"),\n        schoolHoliday: get("ie-filter-schoolHoliday"),\n        promoDays: get("ie-filter-promoDays"),\n        competition: get("ie-filter-competition"),\n        badWeather: get("ie-filter-badWeather"),\n      };\n    }\n\n    // -----------------------------\n    // Apply constraints to grid UI\n    // - greys constrained days\n    // - never hides them\n    // -----------------------------\n    async function updateGridConstraints(){\n      const out = await loadMonthData();\n      if (!out || !Array.isArray(out.days)) return;\n\n      const filters = readConstraintFilters();\n\n      // Map by YYYY-MM-DD\n      const semanticByDate = new Map(\n        out.days\n          .map((r) => ({ ...r, date: asYmd(r?.date) }))\n          .filter((r) => typeof r.date === "string" && r.date.length === 10)\n          .map((r) => [r.date, r])\n      );\n\n      document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {\n        const ymd = btn.getAttribute("data-date");\n        if (!ymd) return;\n\n        const semantic = semanticByDate.get(ymd);\n        // If spillover/no semantic, don\'t constrain (keep existing spillover styling)\n        if (!semantic) {\n          btn.classList.remove("ie-30d-constrained");\n          return;\n        }\n\n        const constrained = isConstrainedDay(semantic, filters);\n        btn.classList.toggle("ie-30d-constrained", constrained);\n        btn.setAttribute("aria-disabled", constrained ? "true" : "false");\n      });\n    }\n\n    // --- Hidden inputs -> refresh grid constraints on any change (keyboard/programmatic) ---\n    [\n      "ie-filter-publicHoliday",\n      "ie-filter-schoolHoliday",\n      "ie-filter-promoDays",\n      "ie-filter-competition",\n      "ie-filter-badWeather",\n    ].forEach((id) => {\n      const el = document.getElementById(id);\n      if (el instanceof HTMLInputElement) {\n        el.addEventListener("change", () => {\n          try { updateGridConstraints(); } catch (_) {}\n        });\n      }\n    });\n\n    // ---- END PROBE ----\n  \n    function asYmd(v){\n      if (!v) return null;\n      if (typeof v === "string") return v.slice(0, 10);\n      if (v instanceof Date) return v.toISOString().slice(0, 10);\n\n      if (typeof v === "object") {\n        if (typeof v.value === "string") return v.value.slice(0, 10);\n        if (typeof v.toJSON === "function") {\n          const j = v.toJSON();\n          if (typeof j === "string") return j.slice(0, 10);\n        }\n      }\n\n      return null;\n    }\n\n    // =========================================================\n    // Business constraints (v1) ‚Äî single source of truth predicate\n    // Meaning: when a constraint toggle is ON, matching days are EXCLUDED\n    // from recommendation logic (top days, KPI counts, ranked lists),\n    // but remain visible in the grid.\n    // Pure + deterministic: no side effects, no external dependencies.\n    // =========================================================\n    function isConstrainedDay(day, filters){\n      // Defensive: if bad inputs, never constrain\n      if (!day || typeof day !== "object") return false;\n      if (!filters || typeof filters !== "object") return false;\n\n      // ---- Local helpers (keep all constants inside this function) ----\n      const asBool = (v) => v === true;\n      const asNum = (v) => {\n        const n = Number(v);\n        return Number.isFinite(n) ? n : null;\n      };\n\n      // Threshold constants (v1 defaults; live only here)\n      const RAIN_PROB_PCT_MIN = 60;   // precip_probability_max_pct >= 60\n      const WIND_KMH_MIN = 40;        // wind_speed_10m_max >= 40\n      const COMPETITION_EVENTS_MIN = 50; // events_within_10km_count >= 50\n\n      // ---- Match rules (truth-based field names from your sample) ----\n      // 1) Jours f√©ri√©s\n      if (asBool(filters.publicHoliday)) {\n        if (day.is_public_holiday_fr_flag === true) return true;\n      }\n\n      // 2) Vacances scolaires\n      if (asBool(filters.schoolHoliday)) {\n        if (day.is_school_holiday_flag === true) return true;\n      }\n\n      // 3) Jours promo\n      if (asBool(filters.promoDays)) {\n        // adjust the field name to your schema:\n        // - you logged: is_commercial_event_flag_region: true\n        if (day.is_commercial_event_flag_region === true) return true;\n\n        // optionally: if you also have names list:\n        // if (Array.isArray(day.commercial_event_names_region) && day.commercial_event_names_region.length) return true;\n      }\n\n      // 4) Bad weather = rain OR strong wind (v1)\n      if (asBool(filters.badWeather)) {\n        const p = asNum(day.precip_probability_max_pct);\n        const w = asNum(day.wind_speed_10m_max);\n        if ((p !== null && p >= RAIN_PROB_PCT_MIN) || (w !== null && w >= WIND_KMH_MIN)) return true;\n      }\n\n      // 5) Forte concurrence\n      if (asBool(filters.competition)) {\n        const c = asNum(day.events_within_10km_count);\n        if (c !== null && c >= COMPETITION_EVENTS_MIN) return true;\n      }\n\n      return false;\n    }\n\n    function weatherIconSrc(code){\n      const c = Number(code);\n      if (!Number.isFinite(c)) return "";\n\n      // WMO weather interpretation groups (Open-Meteo style)\n      if (c === 0) return "/icons/weather/weather_sunny.svg";\n      if (c === 1 || c === 2 || c === 3) return "/icons/weather/weather_cloudy.svg";\n      if (c === 45 || c === 48) return "/icons/weather/weather_cloudy.svg";\n\n      // drizzle / rain\n      if ((c >= 51 && c <= 57) || (c >= 61 && c <= 67)) return "/icons/weather/weather_rain.svg";\n\n      // snow\n      if (c >= 71 && c <= 77) return "/icons/weather/weather_snow.svg";\n\n      // rain showers\n      if (c >= 80 && c <= 82) return "/icons/weather/weather_rain-showers.svg";\n\n      // thunderstorm\n      if (c >= 95 && c <= 99) return "/icons/weather/weather_rain-showers.svg";\n\n      return "/icons/weather/weather_cloudy.svg";\n    }\n\n    async function loadMonthTop3() {\n      const out = await loadMonthData();\n      if (!out) return;\n\n      bindMonthMeta(out);\n\n      const topDays = out.window?.top_days;\n      if (!Array.isArray(topDays) || topDays.length === 0) return;\n\n      const root = document.getElementById("ie-30d-top3-cards");\n      if (!root) return;\n\n      // ---- Render TOP 3 from effective dataset ----\n      function renderTop3() {\n        const filters = readConstraintFilters();\n        const effectiveTopDays = topDays.filter((d) => !isConstrainedDay(d, filters));\n\n        root.innerHTML = "";\n\n        // If everything gets excluded, we render nothing (v1 minimal, no extra UI)\n        if (effectiveTopDays.length === 0) return;\n\n        effectiveTopDays.slice(0, 3).forEach((d, idx) => {\n          const ymd = asYmd(d?.date);\n          if (!ymd) return;\n\n          const parts = ymd.split("-").map(Number);\n          const m = parts[1];\n          const day = parts[2];\n          if (!Number.isFinite(m) || !Number.isFinite(day)) return;\n\n          const month = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][m - 1];\n\n          const score =\n            Number.isFinite(d?.opportunity_score_final_local)\n              ? d.opportunity_score_final_local\n              : "";\n\n          const medal =\n            typeof d?.opportunity_medal === "string" && d.opportunity_medal.length\n              ? `<div class="ie-top3-badge">${d.opportunity_medal}</div>`\n              : "";\n\n          const el = document.createElement("div");\n          el.className = "ie-top3-card";\n\n          el.innerHTML = `\n            <div class="ie-top3-toprow">\n              <div class="ie-top3-rank">#${idx + 1}</div>\n              <div class="ie-top3-month">${month}</div>\n            </div>\n            <div class="ie-top3-day">${day}</div>\n            <div class="ie-top3-score">${score}</div>\n            ${medal}\n          `;\n\n          root.appendChild(el);\n        });\n      }\n\n      // Initial render\n      renderTop3();\n\n      // Bind change handlers once (avoid duplicate listeners on hot reload / re-entry)\n      if (!window.__ie_month_constraints_bound) {\n        window.__ie_month_constraints_bound = true;\n\n        const ids = [\n          "ie-filter-publicHoliday",\n          "ie-filter-schoolHoliday",\n          "ie-filter-promoDays",\n          "ie-filter-badWeather",     \n          "ie-filter-competition",\n        ];\n\n        ids.forEach((id) => {\n          const el = document.getElementById(id);\n          if (el instanceof HTMLInputElement) {\n            el.addEventListener("change", () => {\n              try {\n                renderTop3();\n              } catch (_) {}\n            });\n          }\n        });\n      }\n    }\n\n    async function loadMonthGrid() {\n      const out = await loadMonthData();\n      if (!out) return;\n\n      bindMonthMeta(out);\n\n      const rawDays = out.days;\n      const windowStart = asYmd(out.window?.window_start_date);\n      if (!Array.isArray(rawDays) || !windowStart) return;\n\n      const days = rawDays\n        .map((r) => ({ ...r, date: asYmd(r?.date) }))\n        .filter((r) => typeof r.date === "string" && r.date.length === 10);\n      \n      // DEV-ONLY schema probe (truth for implementing business constraints)\n      try {\n        const host = String(window.location.hostname || "");\n        const isLocalhost = host === "localhost" || host === "127.0.0.1";\n        const isDebug = new URL(window.location.href).searchParams.get("debug") === "1";\n        const isDev = isLocalhost || isDebug;\n\n        if (isDev && !window.__ie_month_day_schema_logged) {\n          window.__ie_month_day_schema_logged = true;\n          const sample = days && days.length ? days[0] : null;\n          console.log("[IE][month] days.length:", Array.isArray(days) ? days.length : null);\n          console.log("[IE][month] sample day:", sample);\n          console.log("[IE][month] sample day keys:", sample && typeof sample === "object" ? Object.keys(sample) : null);\n        }\n      } catch (_) {}\n\n      const grid = document.getElementById("ie-30d-grid");\n      if (!grid) return;\n\n      const monthHeader = document.getElementById("ie-30d-month-header");\n      if (monthHeader) monthHeader.setAttribute("data-window-start", windowStart);\n\n      grid.innerHTML = "";\n\n      function ymdToUtcDate(s) {\n        const [y, m, d] = s.split("-").map(Number);\n        return new Date(Date.UTC(y, m - 1, d));\n      }\n\n      function toYmd(dt) {\n        const y = dt.getUTCFullYear();\n        const m = String(dt.getUTCMonth() + 1).padStart(2, "0");\n        const d = String(dt.getUTCDate()).padStart(2, "0");\n        return `${y}-${m}-${d}`;\n      }\n\n      const semanticByDate = new Map(days.map((d) => [d.date, d]));\n\n      window.__ie_month_semanticByDate = semanticByDate;\n\n      const start = ymdToUtcDate(windowStart);\n      start.setUTCDate(start.getUTCDate() - ((start.getUTCDay() + 6) % 7)); // Monday\n\n      for (let i = 0; i < 42; i++) {\n        const dt = new Date(start);\n        dt.setUTCDate(start.getUTCDate() + i);\n        const ymd = toYmd(dt);\n\n        const semantic = semanticByDate.get(ymd);\n\n        const btn = document.createElement("button");\n        btn.className = "ie-30d-day";\n        btn.setAttribute("data-date", ymd);\n\n        if (!semantic) btn.classList.add("ie-spillover");\n\n        const iconSrc = semantic ? weatherIconSrc(semantic.weather_code) : "";\n\n        btn.innerHTML = `\n          <div class="ie-30d-daynum">${dt.getUTCDate()}</div>\n          ${semantic?.opportunity_medal ? `<div class="ie-30d-medal">${semantic.opportunity_medal}</div>` : ""}\n          ${iconSrc ? `\n            <div class="ie-30d-weather">\n              <img src="${iconSrc}" alt="" />\n            </div>\n          ` : ""}\n        `;\n\n        grid.appendChild(btn);\n      }\n\n      try { updateGridConstraints(); } catch (_) {}\n    }\n\n    let __monthCache = null;\n    let __monthCachePromise = null;\n\n    async function loadMonthData() {\n      if (__monthCache) return __monthCache;\n      if (__monthCachePromise) return __monthCachePromise;\n\n      __monthCachePromise = (async () => {\n        try {\n          const url = "/api/insight/month" + window.location.search;\n\n          const rid = crypto.randomUUID();\n          console.log("[MONTH UI] fetching month api", { rid, url });\n\n          const res = await fetch(url, {\n            headers: {\n              accept: "application/json",\n              "x-request-id": rid,\n            },\n          });\n\n          if (!res.ok) return null;\n\n          const out = await res.json();\n          if (!out || out.ok !== true) return null;\n\n          __monthCache = out;\n          return out;\n        } catch (_) {\n          return null;\n        }\n      })();\n\n      return __monthCachePromise;\n    }\n\n    function bindMonthMeta(out) {\n      const labelEl = document.getElementById("ie-30d-display-label");\n      const takeawayEl = document.getElementById("ie-30d-takeaway-text");\n\n      const keyTakeaway =\n        (typeof out?.ai_points_cles_text === "string" && out.ai_points_cles_text.trim())\n          ? out.ai_points_cles_text\n          : out?.window?.key_takeaway;\n\n      const startYmd = asYmd(out?.window?.window_start_date);\n      const endYmd = asYmd(out?.window?.window_end_date);\n\n      const MONTHS_FR = ["JAN","F√âV","MAR","AVR","MAI","JUN","JUL","AO√õ","SEP","OCT","NOV","D√âC"];\n\n      function fmtRange(ymd){\n        if (!ymd) return null;\n        const parts = String(ymd).split("-");\n        if (parts.length !== 3) return null;\n\n        const y = parseInt(parts[0], 10);\n        const m = parseInt(parts[1], 10);\n        const d = parseInt(parts[2], 10);\n\n        if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;\n        if (m < 1 || m > 12) return null;\n\n        return `${String(d)} ${MONTHS_FR[m - 1]} ${String(y)}`;\n      }\n\n      const startLabel = fmtRange(startYmd);\n      const endLabel = fmtRange(endYmd);\n\n      if (labelEl && startLabel && endLabel) {\n        labelEl.textContent = `${startLabel} - ${endLabel}`;\n      }\n\n      if (takeawayEl && typeof keyTakeaway === "string") {\n        takeawayEl.textContent = keyTakeaway;\n      }\n    }\n\n    (async function bootstrapMonth() {\n      await loadMonthTop3();\n      await loadMonthGrid();\n      await updateGridConstraints(); // <-- apply initial state\n    })();\n\n    function goPrompt(){ window.location.href = "/app/insightevent/prompt"; }\n    function goMonth(){ window.location.href = "/app/insightevent/month" + window.location.search; }\n    function goDay(){ window.location.href = "/app/insightevent/days" + window.location.search; }\n\n    const MAX_DAYS = 7;\n\n    function parseSelectedDates(url){\n        const raw = url.searchParams.get("selected_dates") || "";\n        const parts = raw.split(",").map(s => s.trim()).filter(Boolean);\n        const out = [];\n        const seen = new Set();\n        for(const d of parts){\n        if(!seen.has(d)){\n            out.push(d);\n            seen.add(d);\n        }\n        }\n        return out;\n    }\n\n    function setSelectedDates(url, dates){\n        if(dates.length === 0){\n        url.searchParams.delete("selected_dates");\n        } else {\n        url.searchParams.set("selected_dates", dates.join(","));\n        }\n    }\n\n    function fmtPill(yyyy_mm_dd){\n        const parts = yyyy_mm_dd.split("-");\n        if(parts.length !== 3) return yyyy_mm_dd;\n        const m = parseInt(parts[1], 10);\n        const d = parseInt(parts[2], 10);\n        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];\n        if(!Number.isFinite(m) || !Number.isFinite(d) || m < 1 || m > 12) return yyyy_mm_dd;\n        return `${months[m-1]} ${String(d)}`;\n    }\n\n    const titleEl = document.getElementById("ie-30d-selected-title");\n    const hintEl  = document.getElementById("ie-30d-selected-hint");\n    const pillsEl = document.getElementById("ie-30d-selected-pills");\n    const barEl   = document.getElementById("ie-30d-bottom-bar");\n\n    // -----------------------------\n    // Action bar pills: click to remove\n    // (event delegation so it survives re-render)\n    // -----------------------------\n    if (pillsEl) {\n      pillsEl.addEventListener("click", (e) => {\n        const tgt = e.target;\n        if (!(tgt instanceof Element)) return;\n\n        const pill = tgt.closest(".ie-pill");\n        if (!pill) return;\n\n        const d = pill.getAttribute("data-date");\n        if (!d) return;\n\n        const idx = selected.indexOf(d);\n        if (idx < 0) return;\n\n        // Remove from selection\n        selected.splice(idx, 1);\n\n        // Persist to URL (same pipeline as grid)\n        const nextUrl = new URL(window.location.href);\n        setSelectedDates(nextUrl, selected);\n        window.history.replaceState({}, "", nextUrl.toString());\n\n        // Re-render UI\n        renderSelected(selected);\n        applyNavState();\n      });\n    }\n\n    function flashMaxHint(){\n        if(!hintEl) return;\n        hintEl.style.display = "block";\n        window.clearTimeout(flashMaxHint._t);\n        flashMaxHint._t = window.setTimeout(() => {\n        hintEl.style.display = "none";\n        }, 1200);\n    }\n    flashMaxHint._t = null;\n\n    function renderSelected(dates){\n        if(titleEl){\n        titleEl.textContent = `CHOIX (${dates.length}/${MAX_DAYS})`;\n        }\n        if(!pillsEl) return;\n\n        pillsEl.innerHTML = dates.map(d => (\n        `<span class="ie-pill" data-date="${d}">${fmtPill(d)}</span>`\n        )).join("");\n\n        document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {\n        const d = btn.getAttribute("data-date");\n        if(!d) return;\n        const isSelected = dates.includes(d);\n        btn.classList.toggle("ie-30d-selected-day", isSelected);\n\n        if (btn.classList.contains("ie-spillover") && isSelected) {\n            btn.classList.add("ie-30d-spillover-selected");\n        } else {\n            btn.classList.remove("ie-30d-spillover-selected");\n        }\n        });\n    }\n\n    const url = new URL(window.location.href);\n    let selected = parseSelectedDates(url);\n    renderSelected(selected);\n\n    function applyNavState(){\n      const voirBtn = document.getElementById("ie-30d-view-details");\n\n      const hasSelection = (Array.isArray(selected) && selected.length > 0);\n\n      // Show action bar only when there is at least one selected day\n      if (barEl) {\n        barEl.style.display = hasSelection ? "flex" : "none";\n      }\n\n      if(voirBtn && voirBtn.tagName === "BUTTON"){\n        voirBtn.disabled = !hasSelection;\n        voirBtn.style.opacity = hasSelection ? "1" : "0.45";\n        voirBtn.style.cursor  = hasSelection ? "pointer" : "default";\n        voirBtn.setAttribute("aria-disabled", hasSelection ? "false" : "true");\n      }\n    }\n\n    applyNavState();\n\n    function keepQuery(path){\n      const cur = new URL(window.location.href);\n      const u = new URL(path, window.location.origin);\n\n      const keys = ["location_id", "anchor_date", "selected_date", "selected_dates", "q"];\n      for (const k of keys) {\n        const v = cur.searchParams.get(k);\n        if (v && v.trim()) u.searchParams.set(k, v);\n      }\n      return u.pathname + u.search;\n    }\n\n    function goDaysFromSelection(){\n      if(!Array.isArray(selected) || selected.length === 0) return;\n\n      const u = new URL(window.location.href);\n      u.searchParams.set("selected_dates", selected.join(","));\n      if(!u.searchParams.get("selected_date")) u.searchParams.set("selected_date", selected[0]);\n\n      window.location.href = "/app/insightevent/days" + u.search;\n    }\n\n    const voirBtn = document.getElementById("ie-30d-view-details");\n    if (voirBtn) voirBtn.addEventListener("click", (e) => {\n      e.preventDefault(); e.stopPropagation();\n      goDaysFromSelection();\n    }, true);\n\n    const grid = document.getElementById("ie-30d-grid");\n    if(grid){\n        grid.addEventListener("click", (e) => {\n        const tgt = e.target;\n        if(!(tgt instanceof Element)) return;\n        const btn = tgt.closest(".ie-30d-day");\n        if(!btn) return;\n\n        const d = btn.getAttribute("data-date");\n        if(!d) return;\n\n        const idx = selected.indexOf(d);\n        if(idx >= 0){\n            selected.splice(idx, 1);\n        } else {\n            if(selected.length >= MAX_DAYS){\n            flashMaxHint();\n            return;\n            }\n            selected.push(d);\n        }\n\n        const nextUrl = new URL(window.location.href);\n        setSelectedDates(nextUrl, selected);\n        window.history.replaceState({}, "", nextUrl.toString());\n        renderSelected(selected);\n        applyNavState();\n        });\n    }\n\n    const header = document.getElementById("ie-30d-month-header");\n    const prevBtn = document.getElementById("ie-30d-month-prev");\n    const nextBtn = document.getElementById("ie-30d-month-next");\n\n    if(header && prevBtn && nextBtn){\n        function ymd(dt){\n        const yy = dt.getUTCFullYear();\n        const mm = String(dt.getUTCMonth() + 1).padStart(2, "0");\n        const dd = String(dt.getUTCDate()).padStart(2, "0");\n        return `${yy}-${mm}-${dd}`;\n        }\n\n        function parseYmdToUtcDate(s){\n        if(!s) return null;\n        const parts = String(s).split("-");\n        if(parts.length !== 3) return null;\n        const y = parseInt(parts[0], 10);\n        const m = parseInt(parts[1], 10) - 1;\n        const d = parseInt(parts[2], 10);\n        if(!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;\n        return new Date(Date.UTC(y, m, d));\n        }\n\n        function go(deltaDays){\n        const u = new URL(window.location.href);        \n        const wsParam = u.searchParams.get("window_start_date"); // NEW (from prompt)\n        const wsAttr  = header.getAttribute("data-window-start");\n\n        const sd = u.searchParams.get("selected_date");\n        const ad = u.searchParams.get("anchor_date");\n\n        const base =\n          parseYmdToUtcDate(wsParam) ||\n          parseYmdToUtcDate(sd) ||\n          parseYmdToUtcDate(ad) ||\n          parseYmdToUtcDate(wsAttr);        \n        if(!base){\n            return;\n        }\n\n        const next = new Date(base.getTime());\n        next.setUTCDate(next.getUTCDate() + deltaDays);\n\n        const nextStr = ymd(next);\n\n        u.searchParams.set("window_start_date", nextStr); // NEW canonical for month\n        u.searchParams.set("selected_date", nextStr);      // keep for backward compat\n        u.searchParams.set("anchor_date", nextStr);        // keep for backward compat\n\n        window.location.href = "/app/insightevent/month" + u.search;\n        }\n\n        prevBtn.addEventListener("click", () => go(-42));\n        nextBtn.addEventListener("click", () => go(+42));\n    }\n    })();<\/script> </div> '], [" ", `<div id="ie-30d-root" data-role="ie-30d-root"> <main id="ie-30d-main" data-role="ie-30d-main"> <header id="ie-30d-header" data-role="ie-30d-header"> <nav id="ie-breadcrumb" aria-label="Breadcrumb"> <span class="ie-breadcrumb-root">Insight Event</span> <span class="ie-breadcrumb-sep">/</span> <span class="ie-breadcrumb-current" id="ie-breadcrumb-current">Mois</span> </nav> </header> <section id="ie-30d-top3" data-role="ie-30d-top3"> <div id="ie-30d-top3-header"> <div id="ie-30d-top3-title">TOP 3 JOURS</div> <div id="ie-30d-top3-subtitle">Bas√© sur score d'opportunit√©</div> </div> <div id="ie-30d-top3-cards" data-role="ie-30d-top3-cards"> <!-- TOP3_ANCHOR --> </div> </section> <section id="ie-30d-takeaway" data-role="ie-30d-takeaway"> <div id="ie-30d-takeaway-header" data-role="ie-30d-takeaway-header"> <div id="ie-30d-takeaway-title" data-role="ie-30d-takeaway-title"> <span aria-hidden="true">‚ú¶</span> <span>Points cl√©s</span> </div> <div>Insight IA</div> </div> <div id="ie-30d-takeaway-card" data-role="ie-30d-takeaway-card"> <p id="ie-30d-takeaway-text" data-role="ie-30d-takeaway-text"><!-- TAKEAWAY_ANCHOR --></p> </div> </section> <!-- =========================
        R√âGLAGES AVANC√âS (v1) ‚Äî Contraintes m√©tier
        Placement: directly under Top 3 cards (affects recommendations only)
        ========================= --> <section id="ie-30d-constraints" data-role="ie-30d-constraints" aria-label="R√©glages avanc√©s"> <details id="ie-constraints-details"> <summary id="ie-constraints-summary" class="ie-section-header ie-filters-header"> <span class="ie-filters-icon" aria-hidden="true">‚öôÔ∏é</span> <span class="ie-section-title">Filtres</span> </summary> <div id="ie-constraints-body"> <div id="ie-constraints-row"> <div class="ms-chip-grid" role="group" aria-label="Contraintes m√©tier"> <button type="button" class="ms-chip" data-checkbox="ie-filter-publicHoliday"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Jours f√©ri√©s</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-schoolHoliday"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Vacances scolaires</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-promoDays"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Jours promo</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-competition"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Forte concurrence</span> </button> <button type="button" class="ms-chip" data-checkbox="ie-filter-badWeather"> <span class="ms-chip__check" aria-hidden="true"></span> <span class="ms-chip__label">Fortes intemp√©ries</span> </button> <!-- optional spacer so row 2 aligns perfectly under col 3 --> <span class="ms-chip-spacer" aria-hidden="true"></span> </div> <!-- hidden inputs: JS reads these by id --> <input id="ie-filter-publicHoliday" type="checkbox" hidden> <input id="ie-filter-schoolHoliday" type="checkbox" hidden> <input id="ie-filter-promoDays" type="checkbox" hidden> <input id="ie-filter-competition" type="checkbox" hidden> <input id="ie-filter-badWeather" type="checkbox" hidden> </div> </div> </details> </section> <section id="ie-30d-calendar-section" data-role="ie-30d-calendar-section"> <div id="ie-30d-calendar-header"> <div>CALENDRIER</div> <div></div> </div> <div id="ie-30d-calendar-card"> <div id="ie-30d-month-header" data-role="ie-30d-month-header" data-window-start=""> <button id="ie-30d-month-prev" class="ie-30d-month-nav" type="button" aria-label="Mois pr√©c√©dent">‚Äπ</button> <h2 id="ie-30d-display-label" data-role="ie-30d-display-label"></h2> <button id="ie-30d-month-next" class="ie-30d-month-nav" type="button" aria-label="Mois suivant">‚Ä∫</button> </div> <div id="ie-30d-calendar" data-role="ie-30d-calendar"> <div id="ie-30d-weekdays" data-role="ie-30d-weekdays"> <div class="ie-30d-weekday">Lun</div> <div class="ie-30d-weekday">Mar</div> <div class="ie-30d-weekday">Mer</div> <div class="ie-30d-weekday">Jeu</div> <div class="ie-30d-weekday">Ven</div> <div class="ie-30d-weekday">Sam</div> <div class="ie-30d-weekday">Dim</div> </div> <div id="ie-30d-grid" data-role="ie-30d-grid"> <!-- GRID_ANCHOR --> </div> </div> </div> </section> <!-- Month intro overlay (client-only, v1: localStorage) --> <div id="ms-month-intro" class="ms-month-intro hidden" role="dialog" aria-modal="true" aria-labelledby="ms-month-intro-title"> <div class="ms-month-intro__card"> <div class="ms-month-intro__icon" aria-hidden="true">üóìÔ∏è</div> <h2 id="ms-month-intro-title" class="ms-month-intro__title">
Comment utiliser le calendrier
</h2> <ul class="ms-month-intro__list"> <li><strong>A, B et C</strong> indiquent si un jour est plus ou moins favorable pour votre √©v√®nement.</li> <li>Les signes <strong>"+"</strong> et <strong>"‚àí"</strong> pr√©cisent si le jour est meilleur ou l√©g√®rement en dessous de la moyenne.</li> <li><strong>Cliquez sur 1 √† 7 jours</strong> pour voir le d√©tail de chaque journ√©e.</li> </ul> <button type="button" class="ms-month-intro__cta" id="ms-month-intro-dismiss">
NE PLUS AFFICHER
</button> </div> </div> <script>
          (function () {
            const KEY = "ms_month_intro_dismissed_v1";

            const root = document.getElementById("ms-month-intro");
            if (!root) return;

            const dismissBtn = document.getElementById("ms-month-intro-dismiss");
            const backdrop = root.querySelector(".ms-month-intro__backdrop");

            const hide = () => {
              root.classList.add("hidden");
              root.setAttribute("aria-hidden", "true");
              document.documentElement.style.overflow = "";
              document.body.style.overflow = "";
            };

            const show = () => {
              root.classList.remove("hidden");
              root.removeAttribute("aria-hidden");
              document.documentElement.style.overflow = "hidden";
              document.body.style.overflow = "hidden";
            };

            // Show only if user did not dismiss
            try {
              const dismissed = window.localStorage.getItem(KEY) === "1";
              if (!dismissed) show();
              else hide();
            } catch (_) {
              // If storage blocked, default to showing once per page load
              show();
            }

            const dismissForever = () => {
              try { window.localStorage.setItem(KEY, "1"); } catch (_) {}
              hide();
            };

            if (dismissBtn) dismissBtn.addEventListener("click", dismissForever);

            // Optional niceties (safe + standard UX):
            // click outside closes (WITHOUT saving preference)
            if (backdrop) backdrop.addEventListener("click", hide);

            // Escape closes (WITHOUT saving preference)
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && !root.classList.contains("hidden")) hide();
            });
          })();
        <\/script> </main> <div id="ie-30d-bottom-bar" data-role="ie-30d-bottom-bar"> <div id="ie-30d-bottom-inner"> <div id="ie-30d-selected-wrap"> <div id="ie-30d-selected-row"> <div id="ie-30d-selected-title">CHOIX (0/7)</div> <div id="ie-30d-selected-pills" aria-label="Selected days"></div> <div id="ie-30d-selected-hint" style="display:none;">Maximum 7 jours</div> </div> </div> <button id="ie-30d-view-details" data-role="ie-30d-view-details" type="button">Voir ‚Üí</button> </div> </div> `, "  <script>(function(){", '\n    console.log("[IE] Month UI (Astro) loaded");\n    console.log("[IE][DBG] month.astro inline script: BUILD_ID=2026-01-30-AAA", Date.now());\n\n    // ---- HARD RUNTIME PROBE (must prove script is executing + handlers bind + clicks fire) ----\n    window.addEventListener("error", (ev) => {\n      try {\n        console.error("[IE][window.error]", ev?.message, ev?.filename, ev?.lineno, ev?.colno, ev?.error);\n      } catch (_) {}\n    });\n\n    window.addEventListener("unhandledrejection", (ev) => {\n      try {\n        console.error("[IE][unhandledrejection]", ev?.reason);\n      } catch (_) {}\n    });\n\n    console.log("[IE] Script reached: after global error hooks");\n\n    // --- Pills -> hidden checkbox bridge (must run after DOM is present) ---\n    function bindConstraintChips(){\n      document.querySelectorAll(".ms-chip").forEach((chip) => {\n        const id = chip.getAttribute("data-checkbox");\n        const input = id ? document.getElementById(id) : null;\n        if (!(input instanceof HTMLInputElement)) return;\n\n        const sync = () => chip.classList.toggle("is-active", input.checked === true);\n        sync();\n\n        chip.addEventListener("click", () => {\n          input.checked = !input.checked;\n          input.dispatchEvent(new Event("change", { bubbles: true }));\n          sync();\n        });\n      });\n    }\n\n    if (document.readyState === "loading") {\n      document.addEventListener("DOMContentLoaded", bindConstraintChips, { once: true });\n    } else {\n      bindConstraintChips();\n    }\n\n    // -----------------------------\n    // Constraints UI -> predicates\n    // -----------------------------\n    function readConstraintFilters(){\n      const get = (id) => {\n        const el = document.getElementById(id);\n        return el instanceof HTMLInputElement ? el.checked === true : false;\n      };\n\n      return {\n        publicHoliday: get("ie-filter-publicHoliday"),\n        schoolHoliday: get("ie-filter-schoolHoliday"),\n        promoDays: get("ie-filter-promoDays"),\n        competition: get("ie-filter-competition"),\n        badWeather: get("ie-filter-badWeather"),\n      };\n    }\n\n    // -----------------------------\n    // Apply constraints to grid UI\n    // - greys constrained days\n    // - never hides them\n    // -----------------------------\n    async function updateGridConstraints(){\n      const out = await loadMonthData();\n      if (!out || !Array.isArray(out.days)) return;\n\n      const filters = readConstraintFilters();\n\n      // Map by YYYY-MM-DD\n      const semanticByDate = new Map(\n        out.days\n          .map((r) => ({ ...r, date: asYmd(r?.date) }))\n          .filter((r) => typeof r.date === "string" && r.date.length === 10)\n          .map((r) => [r.date, r])\n      );\n\n      document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {\n        const ymd = btn.getAttribute("data-date");\n        if (!ymd) return;\n\n        const semantic = semanticByDate.get(ymd);\n        // If spillover/no semantic, don\'t constrain (keep existing spillover styling)\n        if (!semantic) {\n          btn.classList.remove("ie-30d-constrained");\n          return;\n        }\n\n        const constrained = isConstrainedDay(semantic, filters);\n        btn.classList.toggle("ie-30d-constrained", constrained);\n        btn.setAttribute("aria-disabled", constrained ? "true" : "false");\n      });\n    }\n\n    // --- Hidden inputs -> refresh grid constraints on any change (keyboard/programmatic) ---\n    [\n      "ie-filter-publicHoliday",\n      "ie-filter-schoolHoliday",\n      "ie-filter-promoDays",\n      "ie-filter-competition",\n      "ie-filter-badWeather",\n    ].forEach((id) => {\n      const el = document.getElementById(id);\n      if (el instanceof HTMLInputElement) {\n        el.addEventListener("change", () => {\n          try { updateGridConstraints(); } catch (_) {}\n        });\n      }\n    });\n\n    // ---- END PROBE ----\n  \n    function asYmd(v){\n      if (!v) return null;\n      if (typeof v === "string") return v.slice(0, 10);\n      if (v instanceof Date) return v.toISOString().slice(0, 10);\n\n      if (typeof v === "object") {\n        if (typeof v.value === "string") return v.value.slice(0, 10);\n        if (typeof v.toJSON === "function") {\n          const j = v.toJSON();\n          if (typeof j === "string") return j.slice(0, 10);\n        }\n      }\n\n      return null;\n    }\n\n    // =========================================================\n    // Business constraints (v1) ‚Äî single source of truth predicate\n    // Meaning: when a constraint toggle is ON, matching days are EXCLUDED\n    // from recommendation logic (top days, KPI counts, ranked lists),\n    // but remain visible in the grid.\n    // Pure + deterministic: no side effects, no external dependencies.\n    // =========================================================\n    function isConstrainedDay(day, filters){\n      // Defensive: if bad inputs, never constrain\n      if (!day || typeof day !== "object") return false;\n      if (!filters || typeof filters !== "object") return false;\n\n      // ---- Local helpers (keep all constants inside this function) ----\n      const asBool = (v) => v === true;\n      const asNum = (v) => {\n        const n = Number(v);\n        return Number.isFinite(n) ? n : null;\n      };\n\n      // Threshold constants (v1 defaults; live only here)\n      const RAIN_PROB_PCT_MIN = 60;   // precip_probability_max_pct >= 60\n      const WIND_KMH_MIN = 40;        // wind_speed_10m_max >= 40\n      const COMPETITION_EVENTS_MIN = 50; // events_within_10km_count >= 50\n\n      // ---- Match rules (truth-based field names from your sample) ----\n      // 1) Jours f√©ri√©s\n      if (asBool(filters.publicHoliday)) {\n        if (day.is_public_holiday_fr_flag === true) return true;\n      }\n\n      // 2) Vacances scolaires\n      if (asBool(filters.schoolHoliday)) {\n        if (day.is_school_holiday_flag === true) return true;\n      }\n\n      // 3) Jours promo\n      if (asBool(filters.promoDays)) {\n        // adjust the field name to your schema:\n        // - you logged: is_commercial_event_flag_region: true\n        if (day.is_commercial_event_flag_region === true) return true;\n\n        // optionally: if you also have names list:\n        // if (Array.isArray(day.commercial_event_names_region) && day.commercial_event_names_region.length) return true;\n      }\n\n      // 4) Bad weather = rain OR strong wind (v1)\n      if (asBool(filters.badWeather)) {\n        const p = asNum(day.precip_probability_max_pct);\n        const w = asNum(day.wind_speed_10m_max);\n        if ((p !== null && p >= RAIN_PROB_PCT_MIN) || (w !== null && w >= WIND_KMH_MIN)) return true;\n      }\n\n      // 5) Forte concurrence\n      if (asBool(filters.competition)) {\n        const c = asNum(day.events_within_10km_count);\n        if (c !== null && c >= COMPETITION_EVENTS_MIN) return true;\n      }\n\n      return false;\n    }\n\n    function weatherIconSrc(code){\n      const c = Number(code);\n      if (!Number.isFinite(c)) return "";\n\n      // WMO weather interpretation groups (Open-Meteo style)\n      if (c === 0) return "/icons/weather/weather_sunny.svg";\n      if (c === 1 || c === 2 || c === 3) return "/icons/weather/weather_cloudy.svg";\n      if (c === 45 || c === 48) return "/icons/weather/weather_cloudy.svg";\n\n      // drizzle / rain\n      if ((c >= 51 && c <= 57) || (c >= 61 && c <= 67)) return "/icons/weather/weather_rain.svg";\n\n      // snow\n      if (c >= 71 && c <= 77) return "/icons/weather/weather_snow.svg";\n\n      // rain showers\n      if (c >= 80 && c <= 82) return "/icons/weather/weather_rain-showers.svg";\n\n      // thunderstorm\n      if (c >= 95 && c <= 99) return "/icons/weather/weather_rain-showers.svg";\n\n      return "/icons/weather/weather_cloudy.svg";\n    }\n\n    async function loadMonthTop3() {\n      const out = await loadMonthData();\n      if (!out) return;\n\n      bindMonthMeta(out);\n\n      const topDays = out.window?.top_days;\n      if (!Array.isArray(topDays) || topDays.length === 0) return;\n\n      const root = document.getElementById("ie-30d-top3-cards");\n      if (!root) return;\n\n      // ---- Render TOP 3 from effective dataset ----\n      function renderTop3() {\n        const filters = readConstraintFilters();\n        const effectiveTopDays = topDays.filter((d) => !isConstrainedDay(d, filters));\n\n        root.innerHTML = "";\n\n        // If everything gets excluded, we render nothing (v1 minimal, no extra UI)\n        if (effectiveTopDays.length === 0) return;\n\n        effectiveTopDays.slice(0, 3).forEach((d, idx) => {\n          const ymd = asYmd(d?.date);\n          if (!ymd) return;\n\n          const parts = ymd.split("-").map(Number);\n          const m = parts[1];\n          const day = parts[2];\n          if (!Number.isFinite(m) || !Number.isFinite(day)) return;\n\n          const month = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][m - 1];\n\n          const score =\n            Number.isFinite(d?.opportunity_score_final_local)\n              ? d.opportunity_score_final_local\n              : "";\n\n          const medal =\n            typeof d?.opportunity_medal === "string" && d.opportunity_medal.length\n              ? \\`<div class="ie-top3-badge">\\${d.opportunity_medal}</div>\\`\n              : "";\n\n          const el = document.createElement("div");\n          el.className = "ie-top3-card";\n\n          el.innerHTML = \\`\n            <div class="ie-top3-toprow">\n              <div class="ie-top3-rank">#\\${idx + 1}</div>\n              <div class="ie-top3-month">\\${month}</div>\n            </div>\n            <div class="ie-top3-day">\\${day}</div>\n            <div class="ie-top3-score">\\${score}</div>\n            \\${medal}\n          \\`;\n\n          root.appendChild(el);\n        });\n      }\n\n      // Initial render\n      renderTop3();\n\n      // Bind change handlers once (avoid duplicate listeners on hot reload / re-entry)\n      if (!window.__ie_month_constraints_bound) {\n        window.__ie_month_constraints_bound = true;\n\n        const ids = [\n          "ie-filter-publicHoliday",\n          "ie-filter-schoolHoliday",\n          "ie-filter-promoDays",\n          "ie-filter-badWeather",     \n          "ie-filter-competition",\n        ];\n\n        ids.forEach((id) => {\n          const el = document.getElementById(id);\n          if (el instanceof HTMLInputElement) {\n            el.addEventListener("change", () => {\n              try {\n                renderTop3();\n              } catch (_) {}\n            });\n          }\n        });\n      }\n    }\n\n    async function loadMonthGrid() {\n      const out = await loadMonthData();\n      if (!out) return;\n\n      bindMonthMeta(out);\n\n      const rawDays = out.days;\n      const windowStart = asYmd(out.window?.window_start_date);\n      if (!Array.isArray(rawDays) || !windowStart) return;\n\n      const days = rawDays\n        .map((r) => ({ ...r, date: asYmd(r?.date) }))\n        .filter((r) => typeof r.date === "string" && r.date.length === 10);\n      \n      // DEV-ONLY schema probe (truth for implementing business constraints)\n      try {\n        const host = String(window.location.hostname || "");\n        const isLocalhost = host === "localhost" || host === "127.0.0.1";\n        const isDebug = new URL(window.location.href).searchParams.get("debug") === "1";\n        const isDev = isLocalhost || isDebug;\n\n        if (isDev && !window.__ie_month_day_schema_logged) {\n          window.__ie_month_day_schema_logged = true;\n          const sample = days && days.length ? days[0] : null;\n          console.log("[IE][month] days.length:", Array.isArray(days) ? days.length : null);\n          console.log("[IE][month] sample day:", sample);\n          console.log("[IE][month] sample day keys:", sample && typeof sample === "object" ? Object.keys(sample) : null);\n        }\n      } catch (_) {}\n\n      const grid = document.getElementById("ie-30d-grid");\n      if (!grid) return;\n\n      const monthHeader = document.getElementById("ie-30d-month-header");\n      if (monthHeader) monthHeader.setAttribute("data-window-start", windowStart);\n\n      grid.innerHTML = "";\n\n      function ymdToUtcDate(s) {\n        const [y, m, d] = s.split("-").map(Number);\n        return new Date(Date.UTC(y, m - 1, d));\n      }\n\n      function toYmd(dt) {\n        const y = dt.getUTCFullYear();\n        const m = String(dt.getUTCMonth() + 1).padStart(2, "0");\n        const d = String(dt.getUTCDate()).padStart(2, "0");\n        return \\`\\${y}-\\${m}-\\${d}\\`;\n      }\n\n      const semanticByDate = new Map(days.map((d) => [d.date, d]));\n\n      window.__ie_month_semanticByDate = semanticByDate;\n\n      const start = ymdToUtcDate(windowStart);\n      start.setUTCDate(start.getUTCDate() - ((start.getUTCDay() + 6) % 7)); // Monday\n\n      for (let i = 0; i < 42; i++) {\n        const dt = new Date(start);\n        dt.setUTCDate(start.getUTCDate() + i);\n        const ymd = toYmd(dt);\n\n        const semantic = semanticByDate.get(ymd);\n\n        const btn = document.createElement("button");\n        btn.className = "ie-30d-day";\n        btn.setAttribute("data-date", ymd);\n\n        if (!semantic) btn.classList.add("ie-spillover");\n\n        const iconSrc = semantic ? weatherIconSrc(semantic.weather_code) : "";\n\n        btn.innerHTML = \\`\n          <div class="ie-30d-daynum">\\${dt.getUTCDate()}</div>\n          \\${semantic?.opportunity_medal ? \\`<div class="ie-30d-medal">\\${semantic.opportunity_medal}</div>\\` : ""}\n          \\${iconSrc ? \\`\n            <div class="ie-30d-weather">\n              <img src="\\${iconSrc}" alt="" />\n            </div>\n          \\` : ""}\n        \\`;\n\n        grid.appendChild(btn);\n      }\n\n      try { updateGridConstraints(); } catch (_) {}\n    }\n\n    let __monthCache = null;\n    let __monthCachePromise = null;\n\n    async function loadMonthData() {\n      if (__monthCache) return __monthCache;\n      if (__monthCachePromise) return __monthCachePromise;\n\n      __monthCachePromise = (async () => {\n        try {\n          const url = "/api/insight/month" + window.location.search;\n\n          const rid = crypto.randomUUID();\n          console.log("[MONTH UI] fetching month api", { rid, url });\n\n          const res = await fetch(url, {\n            headers: {\n              accept: "application/json",\n              "x-request-id": rid,\n            },\n          });\n\n          if (!res.ok) return null;\n\n          const out = await res.json();\n          if (!out || out.ok !== true) return null;\n\n          __monthCache = out;\n          return out;\n        } catch (_) {\n          return null;\n        }\n      })();\n\n      return __monthCachePromise;\n    }\n\n    function bindMonthMeta(out) {\n      const labelEl = document.getElementById("ie-30d-display-label");\n      const takeawayEl = document.getElementById("ie-30d-takeaway-text");\n\n      const keyTakeaway =\n        (typeof out?.ai_points_cles_text === "string" && out.ai_points_cles_text.trim())\n          ? out.ai_points_cles_text\n          : out?.window?.key_takeaway;\n\n      const startYmd = asYmd(out?.window?.window_start_date);\n      const endYmd = asYmd(out?.window?.window_end_date);\n\n      const MONTHS_FR = ["JAN","F√âV","MAR","AVR","MAI","JUN","JUL","AO√õ","SEP","OCT","NOV","D√âC"];\n\n      function fmtRange(ymd){\n        if (!ymd) return null;\n        const parts = String(ymd).split("-");\n        if (parts.length !== 3) return null;\n\n        const y = parseInt(parts[0], 10);\n        const m = parseInt(parts[1], 10);\n        const d = parseInt(parts[2], 10);\n\n        if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;\n        if (m < 1 || m > 12) return null;\n\n        return \\`\\${String(d)} \\${MONTHS_FR[m - 1]} \\${String(y)}\\`;\n      }\n\n      const startLabel = fmtRange(startYmd);\n      const endLabel = fmtRange(endYmd);\n\n      if (labelEl && startLabel && endLabel) {\n        labelEl.textContent = \\`\\${startLabel} - \\${endLabel}\\`;\n      }\n\n      if (takeawayEl && typeof keyTakeaway === "string") {\n        takeawayEl.textContent = keyTakeaway;\n      }\n    }\n\n    (async function bootstrapMonth() {\n      await loadMonthTop3();\n      await loadMonthGrid();\n      await updateGridConstraints(); // <-- apply initial state\n    })();\n\n    function goPrompt(){ window.location.href = "/app/insightevent/prompt"; }\n    function goMonth(){ window.location.href = "/app/insightevent/month" + window.location.search; }\n    function goDay(){ window.location.href = "/app/insightevent/days" + window.location.search; }\n\n    const MAX_DAYS = 7;\n\n    function parseSelectedDates(url){\n        const raw = url.searchParams.get("selected_dates") || "";\n        const parts = raw.split(",").map(s => s.trim()).filter(Boolean);\n        const out = [];\n        const seen = new Set();\n        for(const d of parts){\n        if(!seen.has(d)){\n            out.push(d);\n            seen.add(d);\n        }\n        }\n        return out;\n    }\n\n    function setSelectedDates(url, dates){\n        if(dates.length === 0){\n        url.searchParams.delete("selected_dates");\n        } else {\n        url.searchParams.set("selected_dates", dates.join(","));\n        }\n    }\n\n    function fmtPill(yyyy_mm_dd){\n        const parts = yyyy_mm_dd.split("-");\n        if(parts.length !== 3) return yyyy_mm_dd;\n        const m = parseInt(parts[1], 10);\n        const d = parseInt(parts[2], 10);\n        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];\n        if(!Number.isFinite(m) || !Number.isFinite(d) || m < 1 || m > 12) return yyyy_mm_dd;\n        return \\`\\${months[m-1]} \\${String(d)}\\`;\n    }\n\n    const titleEl = document.getElementById("ie-30d-selected-title");\n    const hintEl  = document.getElementById("ie-30d-selected-hint");\n    const pillsEl = document.getElementById("ie-30d-selected-pills");\n    const barEl   = document.getElementById("ie-30d-bottom-bar");\n\n    // -----------------------------\n    // Action bar pills: click to remove\n    // (event delegation so it survives re-render)\n    // -----------------------------\n    if (pillsEl) {\n      pillsEl.addEventListener("click", (e) => {\n        const tgt = e.target;\n        if (!(tgt instanceof Element)) return;\n\n        const pill = tgt.closest(".ie-pill");\n        if (!pill) return;\n\n        const d = pill.getAttribute("data-date");\n        if (!d) return;\n\n        const idx = selected.indexOf(d);\n        if (idx < 0) return;\n\n        // Remove from selection\n        selected.splice(idx, 1);\n\n        // Persist to URL (same pipeline as grid)\n        const nextUrl = new URL(window.location.href);\n        setSelectedDates(nextUrl, selected);\n        window.history.replaceState({}, "", nextUrl.toString());\n\n        // Re-render UI\n        renderSelected(selected);\n        applyNavState();\n      });\n    }\n\n    function flashMaxHint(){\n        if(!hintEl) return;\n        hintEl.style.display = "block";\n        window.clearTimeout(flashMaxHint._t);\n        flashMaxHint._t = window.setTimeout(() => {\n        hintEl.style.display = "none";\n        }, 1200);\n    }\n    flashMaxHint._t = null;\n\n    function renderSelected(dates){\n        if(titleEl){\n        titleEl.textContent = \\`CHOIX (\\${dates.length}/\\${MAX_DAYS})\\`;\n        }\n        if(!pillsEl) return;\n\n        pillsEl.innerHTML = dates.map(d => (\n        \\`<span class="ie-pill" data-date="\\${d}">\\${fmtPill(d)}</span>\\`\n        )).join("");\n\n        document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {\n        const d = btn.getAttribute("data-date");\n        if(!d) return;\n        const isSelected = dates.includes(d);\n        btn.classList.toggle("ie-30d-selected-day", isSelected);\n\n        if (btn.classList.contains("ie-spillover") && isSelected) {\n            btn.classList.add("ie-30d-spillover-selected");\n        } else {\n            btn.classList.remove("ie-30d-spillover-selected");\n        }\n        });\n    }\n\n    const url = new URL(window.location.href);\n    let selected = parseSelectedDates(url);\n    renderSelected(selected);\n\n    function applyNavState(){\n      const voirBtn = document.getElementById("ie-30d-view-details");\n\n      const hasSelection = (Array.isArray(selected) && selected.length > 0);\n\n      // Show action bar only when there is at least one selected day\n      if (barEl) {\n        barEl.style.display = hasSelection ? "flex" : "none";\n      }\n\n      if(voirBtn && voirBtn.tagName === "BUTTON"){\n        voirBtn.disabled = !hasSelection;\n        voirBtn.style.opacity = hasSelection ? "1" : "0.45";\n        voirBtn.style.cursor  = hasSelection ? "pointer" : "default";\n        voirBtn.setAttribute("aria-disabled", hasSelection ? "false" : "true");\n      }\n    }\n\n    applyNavState();\n\n    function keepQuery(path){\n      const cur = new URL(window.location.href);\n      const u = new URL(path, window.location.origin);\n\n      const keys = ["location_id", "anchor_date", "selected_date", "selected_dates", "q"];\n      for (const k of keys) {\n        const v = cur.searchParams.get(k);\n        if (v && v.trim()) u.searchParams.set(k, v);\n      }\n      return u.pathname + u.search;\n    }\n\n    function goDaysFromSelection(){\n      if(!Array.isArray(selected) || selected.length === 0) return;\n\n      const u = new URL(window.location.href);\n      u.searchParams.set("selected_dates", selected.join(","));\n      if(!u.searchParams.get("selected_date")) u.searchParams.set("selected_date", selected[0]);\n\n      window.location.href = "/app/insightevent/days" + u.search;\n    }\n\n    const voirBtn = document.getElementById("ie-30d-view-details");\n    if (voirBtn) voirBtn.addEventListener("click", (e) => {\n      e.preventDefault(); e.stopPropagation();\n      goDaysFromSelection();\n    }, true);\n\n    const grid = document.getElementById("ie-30d-grid");\n    if(grid){\n        grid.addEventListener("click", (e) => {\n        const tgt = e.target;\n        if(!(tgt instanceof Element)) return;\n        const btn = tgt.closest(".ie-30d-day");\n        if(!btn) return;\n\n        const d = btn.getAttribute("data-date");\n        if(!d) return;\n\n        const idx = selected.indexOf(d);\n        if(idx >= 0){\n            selected.splice(idx, 1);\n        } else {\n            if(selected.length >= MAX_DAYS){\n            flashMaxHint();\n            return;\n            }\n            selected.push(d);\n        }\n\n        const nextUrl = new URL(window.location.href);\n        setSelectedDates(nextUrl, selected);\n        window.history.replaceState({}, "", nextUrl.toString());\n        renderSelected(selected);\n        applyNavState();\n        });\n    }\n\n    const header = document.getElementById("ie-30d-month-header");\n    const prevBtn = document.getElementById("ie-30d-month-prev");\n    const nextBtn = document.getElementById("ie-30d-month-next");\n\n    if(header && prevBtn && nextBtn){\n        function ymd(dt){\n        const yy = dt.getUTCFullYear();\n        const mm = String(dt.getUTCMonth() + 1).padStart(2, "0");\n        const dd = String(dt.getUTCDate()).padStart(2, "0");\n        return \\`\\${yy}-\\${mm}-\\${dd}\\`;\n        }\n\n        function parseYmdToUtcDate(s){\n        if(!s) return null;\n        const parts = String(s).split("-");\n        if(parts.length !== 3) return null;\n        const y = parseInt(parts[0], 10);\n        const m = parseInt(parts[1], 10) - 1;\n        const d = parseInt(parts[2], 10);\n        if(!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;\n        return new Date(Date.UTC(y, m, d));\n        }\n\n        function go(deltaDays){\n        const u = new URL(window.location.href);        \n        const wsParam = u.searchParams.get("window_start_date"); // NEW (from prompt)\n        const wsAttr  = header.getAttribute("data-window-start");\n\n        const sd = u.searchParams.get("selected_date");\n        const ad = u.searchParams.get("anchor_date");\n\n        const base =\n          parseYmdToUtcDate(wsParam) ||\n          parseYmdToUtcDate(sd) ||\n          parseYmdToUtcDate(ad) ||\n          parseYmdToUtcDate(wsAttr);        \n        if(!base){\n            return;\n        }\n\n        const next = new Date(base.getTime());\n        next.setUTCDate(next.getUTCDate() + deltaDays);\n\n        const nextStr = ymd(next);\n\n        u.searchParams.set("window_start_date", nextStr); // NEW canonical for month\n        u.searchParams.set("selected_date", nextStr);      // keep for backward compat\n        u.searchParams.set("anchor_date", nextStr);        // keep for backward compat\n\n        window.location.href = "/app/insightevent/month" + u.search;\n        }\n\n        prevBtn.addEventListener("click", () => go(-42));\n        nextBtn.addEventListener("click", () => go(+42));\n    }\n    })();<\/script> </div> '])), maybeRenderHead(), renderComponent($$result3, "InsightBottomBar", $$InsightBottomBar, { "active": "month", "showActions": false, "search": Astro2.url.search }), defineScriptVars({ location_id })) })}` })}`;
}, "/Users/julendeajuriaguerra/Documents/Muse_Square/Muse_Square_Website/muse-square/src/pages/app/insightevent/month.astro", void 0);
const $$file = "/Users/julendeajuriaguerra/Documents/Muse_Square/Muse_Square_Website/muse-square/src/pages/app/insightevent/month.astro";
const $$url = "/app/insightevent/month";
const _page = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({
  __proto__: null,
  default: $$Month,
  file: $$file,
  prerender,
  url: $$url
}, Symbol.toStringTag, { value: "Module" }));
const page = () => _page;
export {
  page,
  renderers
};
