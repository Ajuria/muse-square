---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { BigQuery } from "@google-cloud/bigquery";

if (import.meta.env.DEV) {
  console.log("PROFILE SSR locals (safe):", {
    authStatus: (Astro.locals as any)?.authStatus ?? null,
    clerk_user_id: (Astro.locals as any)?.clerk_user_id ?? null,
    location_id: (Astro.locals as any)?.location_id ?? null,
    profileRowExists: (Astro.locals as any)?.profileRowExists ?? null,
  });
}

function requireString(v: unknown, name: string): string {
  if (typeof v !== "string" || v.trim() === "") {
    throw new Error(`Missing or invalid field: ${name}`);
  }
  return v.trim();
}

// ---- AUTH + CONTEXT (SOURCE OF TRUTH) ----
const clerk_user_id_raw = (Astro.locals as any)?.clerk_user_id;
const location_id_raw = (Astro.locals as any)?.location_id;

if (typeof clerk_user_id_raw !== "string" || clerk_user_id_raw.trim() === "") {
  return Astro.redirect("/sign-in");
}

const clerk_user_id = clerk_user_id_raw.trim();

// IMPORTANT:
// Profile page must NOT redirect if location_id is missing.
// It is the page where location_id gets created.
const location_id =
  typeof location_id_raw === "string" && location_id_raw.trim() !== ""
    ? location_id_raw.trim()
    : null;

// ---- BIGQUERY CLIENT (EU) ----
const projectId = (process.env.BQ_PROJECT_ID || "").trim();
const dataset = (process.env.BQ_DATASET || "").trim();
const table = (process.env.BQ_TABLE || "").trim();

const hasKeyfile = !!process.env.GOOGLE_APPLICATION_CREDENTIALS;

// In prod, do not silently rely on "maybe ADC exists".
// Either provide a key file OR run on a platform with guaranteed ADC and set BQ_USE_ADC=true.
const useAdc = (process.env.BQ_USE_ADC || "").trim().toLowerCase() === "true";

if (!hasKeyfile && !useAdc) {
  console.error("[PROFILE] BigQuery auth not configured.");
}

const bigquery = new BigQuery(
  hasKeyfile
    ? { projectId, keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS }
    : { projectId }
);

const fullTable = `\`${projectId}.${dataset}.${table}\``;

const BQ_LOCATION = (process.env.BQ_LOCATION || "EU").trim();

// ---- LOAD SAVED PROFILE (AUTHORITATIVE) ----
const sql = `
  SELECT
    clerk_user_id,
    location_id,
    email,
    first_name,
    last_name,
    position,
    company_name,
    company_address,
    company_activity_type,
    location_type,
    event_time_profile,
    location_access_pattern,
    nearest_transit_stop,
    primary_audience_1,
    primary_audience_2,
    origin_city_id_1,
    origin_city_id_2,
    origin_city_id_3
  FROM ${fullTable}
  WHERE clerk_user_id = @clerk_user_id
    AND location_id = @location_id
  ORDER BY updated_at DESC
  LIMIT 1
`;

let saved_row: any = null;
// NOTE: do not expose raw DB values directly into HTML attributes.
// Keep only escaped values in saved_safe.

function escAttr(v: unknown): string {
  const s = v == null ? "" : String(v);
  return s
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

let saved_safe: Record<string, string> | null = null;

try {
  const [rows] = await bigquery.query({
    query: sql,
    location: BQ_LOCATION,
    params: { clerk_user_id, location_id: location_id ?? "" },
    types: { clerk_user_id: "STRING", location_id: "STRING" },
  });

  saved_row = Array.isArray(rows) && rows.length > 0 ? rows[0] : null;

  saved_safe = saved_row
    ? {
        email: escAttr(saved_row.email),
        first_name: escAttr(saved_row.first_name),
        last_name: escAttr(saved_row.last_name),
        position: escAttr(saved_row.position),
        company_name: escAttr(saved_row.company_name),
        company_address: escAttr(saved_row.company_address),
        company_activity_type: escAttr(saved_row.company_activity_type),
        location_type: escAttr(saved_row.location_type),
        event_time_profile: escAttr(saved_row.event_time_profile),
        location_access_pattern: escAttr(saved_row.location_access_pattern),
        nearest_transit_stop: escAttr(saved_row.nearest_transit_stop),
        primary_audience_1: escAttr(saved_row.primary_audience_1),
        primary_audience_2: escAttr(saved_row.primary_audience_2),
        origin_city_id_1: escAttr(saved_row.origin_city_id_1),
        origin_city_id_2: escAttr(saved_row.origin_city_id_2),
        origin_city_id_3: escAttr(saved_row.origin_city_id_3),
      }
    : null;
} catch (e) {
  if (import.meta.env.DEV) {
    console.error("[PROFILE][BQ FAIL] load_saved_profile", e);
  } else {
    console.error("[PROFILE][BQ FAIL] load_saved_profile");
  }
  saved_safe = null;
  saved_row = null;
}

// ---- NORMALIZE MULTI-SELECT DEFAULTS ----
const selected_audiences = [
  saved_safe?.primary_audience_1 || null,
  saved_safe?.primary_audience_2 || null,
].filter(Boolean) as string[];

const selected_origin_city_ids = [
  saved_safe?.origin_city_id_1 || null,
  saved_safe?.origin_city_id_2 || null,
  saved_safe?.origin_city_id_3 || null,
].filter(Boolean) as string[];
---
<BaseLayout title="Profil - Muse Square" hideSurveyCta={true}>
  <div class="min-h-screen bg-white pt-26 pb-20 px-4">
    <div class="max-w-2xl mx-auto mt-10">

      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-start justify-between mb-2">
          <h1 class="text-3xl ont-semibold">Profil</h1>
          <a href="/api/auth/signout" class="text-sm text-gray-500 uppercase tracking-wide hover:text-black">
            Déconnexion
          </a>
        </div>
        <p class="text-sm text-gray-500">Gérez vos informations et préférences d'analyse.</p>
      </div>

      <!-- Form -->
      <form method="POST" id="profileForm">
        <!-- Sections only: controls the big gaps between sections -->
        <div class="space-y-[15px]">

          <!-- SECTION 1: PROFIL D'UTILISATEUR -->
          <section class="space-y-10">
            <div>
              <h2 class="text-base font-medium text-black uppercase tracking-wider">PROFIL D'UTILISATEUR</h2>
            </div>

            <div class="space-y-[20px]">
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                    Prénom <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="first_name"
                    required
                    value={saved_safe?.first_name ?? ""}
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                  />
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                    Nom <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    name="last_name"
                    required
                    value={saved_safe?.last_name ?? ""}
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                  />
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Fonction
                </label>
                <input
                  type="text"
                  name="position"
                  value={saved_safe?.position ?? ""}
                  class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                />
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={saved_safe?.email ?? ""}
                  readonly
                  style="background:#f9fafb !important; color:#6b7280 !important;"
                  class="w-full px-6 py-4 border-0 rounded-2xl text-base cursor-not-allowed"
                />
              </div>

              <div class="pt-2">
                <a href="https://accounts.clerk.com/user/security" target="_blank" rel="noopener" class="text-sm text-gray-600 hover:text-black">
                  → Modifier mon mot de passe
                </a>
              </div>
            </div>
          </section>

          <!-- SECTION 2: PROFIL D'ENTREPRISE -->
          <section class="space-y-10">
            <div>
              <h2 class="text-base font-medium text-black uppercase tracking-wider">PROFIL D'ENTREPRISE</h2>
              <p class="text-sm text-gray-500">Requis pour personnaliser les insights métiers</p>
            </div>

            <div class="space-y-[20px]">
              <input type="hidden" name="location_id" value={location_id ?? ""} />
              <input type="hidden" name="origin_city_label_1" id="origin_city_label_1" value={saved_safe?.origin_city_label_1 ?? ""} />
              <input type="hidden" name="origin_city_label_2" id="origin_city_label_2" value={saved_safe?.origin_city_label_2 ?? ""} />
              <input type="hidden" name="origin_city_label_3" id="origin_city_label_3" value={saved_safe?.origin_city_label_3 ?? ""} />
              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Entreprise <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="company_name"
                  required
                  value={saved_safe?.company_name ?? ""}
                  class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                />
              </div>

              <div class="relative">
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Adresse professionnelle
                </label>

                <input
                  id="companyAddressInput"
                  type="text"
                  name="company_address"
                  autocomplete="off"
                  value={saved_safe?.company_address ?? ""}
                  class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                />

                <!-- Suggestions dropdown -->
                <div
                  id="companyAddressSuggestions"
                  class="absolute z-50 mt-2 w-full bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden hidden"
                ></div>

                <p class="text-xs text-gray-500 mt-2">Commencez à taper, puis sélectionnez une proposition.</p>
              </div>


              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Secteur d'activité <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="company_activity_type"
                    required
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all appearance-none pr-12"
                  >
                    <option value="cultural" selected={(saved_safe?.company_activity_type ?? "") === "cultural"}>Culture & Patrimoine</option>
                    <option value="events" selected={(saved_safe?.company_activity_type ?? "") === "events"}>Événementiel</option>
                    <option value="tourism" selected={(saved_safe?.company_activity_type ?? "") === "tourism"}>Tourisme & Loisirs</option>
                    <option value="restaurant" selected={(saved_safe?.company_activity_type ?? "") === "restaurant"}>Restauration & Bars</option>
                    <option value="retail" selected={(saved_safe?.company_activity_type ?? "") === "retail"}>Commerce & Retail</option>
                    <option value="hospitality" selected={(saved_safe?.company_activity_type ?? "") === "hospitality"}>Hôtellerie & Hébergement</option>
                    <option value="public" selected={(saved_safe?.company_activity_type ?? "") === "public"}>Collectivités & Secteur public</option>
                    <option value="sports" selected={(saved_safe?.company_activity_type ?? "") === "sports"}>Sports & Loisirs actifs</option>
                    <option value="transport" selected={(saved_safe?.company_activity_type ?? "") === "transport"}>Transport & Mobilité locale</option>
                    <option value="education" selected={(saved_safe?.company_activity_type ?? "") === "education"}>Éducation & Enseignement</option>
                    <option value="nonprofit" selected={(saved_safe?.company_activity_type ?? "") === "nonprofit"}>Associatif & Non lucratif</option>
                    <option value="other" selected={(saved_safe?.company_activity_type ?? "") === "other"}>Autre activité accueillant du public</option>
                  </select>
                  <div class="absolute inset-y-0 right-6 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Audience, Clientèle visée <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="primary_audience_1"
                    required
                    multiple
                    size="6"
                    class="w-full px-6 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all overflow-auto"
                  >
                    <option value="">Sélectionner...</option>
                    <option value="local" selected={selected_audiences.includes("local")}>Public local / résidents</option>
                    <option value="tourists" selected={selected_audiences.includes("tourists")}>Touristes</option>
                    <option value="mixed" selected={selected_audiences.includes("mixed")}>Public mixte (locaux + touristes)</option>
                    <option value="professionals" selected={selected_audiences.includes("professionals")}>Professionnels</option>
                    <option value="students" selected={selected_audiences.includes("students")}>Scolaires / étudiants</option>
                    <option value="families" selected={selected_audiences.includes("families")}>Familles</option>
                  </select>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                  Maintenez Cmd/Ctrl pour sélectionner jusqu’à 2 audiences
                </p>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Villes d'origine principales de vos clients <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="origin_city_ids"
                    required
                    multiple
                    size="12"
                    class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all overflow-auto"
                  >
                    <optgroup label="Île-de-France">
                      <option value="75056" selected={selected_origin_city_ids.includes("75056")}>Paris</option>
                      <option value="92012" selected={selected_origin_city_ids.includes("92012")}>Boulogne-Billancourt</option>
                      <option value="93066" selected={selected_origin_city_ids.includes("93066")}>Saint-Denis</option>
                      <option value="93048" selected={selected_origin_city_ids.includes("93048")}>Montreuil</option>
                      <option value="92050" selected={selected_origin_city_ids.includes("92050")}>Nanterre</option>
                      <option value="78646" selected={selected_origin_city_ids.includes("78646")}>Versailles</option>
                      <option value="94028" selected={selected_origin_city_ids.includes("94028")}>Créteil</option>
                      <option value="94081" selected={selected_origin_city_ids.includes("94081")}>Vitry-sur-Seine</option>
                      <option value="idf_other" selected={selected_origin_city_ids.includes("idf_other")}>Autres villes de la région</option>
                      <option value="idf_outside" selected={selected_origin_city_ids.includes("idf_outside")}>Hors région</option>
                    </optgroup>

                    <optgroup label="Provence–Alpes–Côte d'Azur">
                      <option value="13055" selected={selected_origin_city_ids.includes("13055")}>Marseille</option>
                      <option value="06088" selected={selected_origin_city_ids.includes("06088")}>Nice</option>
                      <option value="13001" selected={selected_origin_city_ids.includes("13001")}>Aix-en-Provence</option>
                      <option value="83137" selected={selected_origin_city_ids.includes("83137")}>Toulon</option>
                      <option value="84007" selected={selected_origin_city_ids.includes("84007")}>Avignon</option>
                      <option value="06029" selected={selected_origin_city_ids.includes("06029")}>Cannes</option>
                      <option value="06004" selected={selected_origin_city_ids.includes("06004")}>Antibes</option>
                      <option value="06069" selected={selected_origin_city_ids.includes("06069")}>Grasse</option>
                      <option value="paca_other" selected={selected_origin_city_ids.includes("paca_other")}>Autres villes de la région</option>
                      <option value="paca_outside" selected={selected_origin_city_ids.includes("paca_outside")}>Hors région</option>
                    </optgroup>

                    <optgroup label="Occitanie">
                      <option value="31555" selected={selected_origin_city_ids.includes("31555")}>Toulouse</option>
                      <option value="34172" selected={selected_origin_city_ids.includes("34172")}>Montpellier</option>
                      <option value="30189" selected={selected_origin_city_ids.includes("30189")}>Nîmes</option>
                      <option value="66136" selected={selected_origin_city_ids.includes("66136")}>Perpignan</option>
                      <option value="34032" selected={selected_origin_city_ids.includes("34032")}>Béziers</option>
                      <option value="11262" selected={selected_origin_city_ids.includes("11262")}>Narbonne</option>
                      <option value="81004" selected={selected_origin_city_ids.includes("81004")}>Albi</option>
                      <option value="11069" selected={selected_origin_city_ids.includes("11069")}>Carcassonne</option>
                      <option value="occ_other" selected={selected_origin_city_ids.includes("occ_other")}>Autres villes de la région</option>
                      <option value="occ_outside" selected={selected_origin_city_ids.includes("occ_outside")}>Hors région</option>
                    </optgroup>
                  </select>
                </div>
                <p class="text-xs text-gray-500 mt-2">Maintenez Cmd/Ctrl pour sélectionner plusieurs villes</p>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Moments d'activité principaux <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="event_time_profile"
                    required
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all appearance-none pr-12"
                  >
                    <option value="">Sélectionner...</option>
                    <option value="day" selected={(saved_safe?.event_time_profile ?? "") === "day"}>Journée</option>
                    <option value="evening" selected={(saved_safe?.event_time_profile ?? "") === "evening"}>Soirée</option>
                    <option value="weekend" selected={(saved_safe?.event_time_profile ?? "") === "weekend"}>Week-end</option>
                    <option value="variable" selected={(saved_safe?.event_time_profile ?? "") === "variable"}>Variable / selon événements</option>
                  </select>
                  <div class="absolute inset-y-0 right-6 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- SECTION 3: ENVIRONNEMENT DE TRAVAIL -->
          <section class="space-y-10">
            <div>
              <h2 class="text-base font-medium text-black uppercase tracking-wider">ENVIRONNEMENT DE TRAVAIL</h2>
              <p class="text-sm text-gray-500">Requis pour personnaliser les alertes météo et mobilité</p>
            </div>

            <div class="space-y-[20px]">
              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Type de lieu favori <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="location_type"
                    required
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all appearance-none pr-12"
                  >
                    <option value="">Sélectionner...</option>
                    <option value="outdoor" selected={(saved_safe?.location_type ?? "") === "outdoor"}>Espace extérieur</option>
                    <option value="indoor" selected={(saved_safe?.location_type ?? "") === "indoor"}>Espace intérieur</option>
                    <option value="mixed" selected={(saved_safe?.location_type ?? "") === "mixed"}>Espace mixte</option>
                  </select>
                  <div class="absolute inset-y-0 right-6 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Profil de déplacement audience <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <select
                    name="location_access_pattern"
                    required
                    class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all appearance-none pr-12"
                  >
                    <option value="">Sélectionner...</option>
                    <option value="public_transit" selected={(saved_safe?.location_access_pattern ?? "") === "public_transit"}>Transports en commun / Métro</option>
                    <option value="walking" selected={(saved_safe?.location_access_pattern ?? "") === "walking"}>À pied</option>
                    <option value="car" selected={(saved_safe?.location_access_pattern ?? "") === "car"}>Voiture</option>
                    <option value="bike" selected={(saved_safe?.location_access_pattern ?? "") === "bike"}>Vélo</option>
                  </select>
                  <div class="absolute inset-y-0 right-6 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">
                  Station de métro la plus proche (optionnel)
                </label>
                <input
                  type="text"
                  name="nearest_transit_stop"
                  placeholder="Rechercher une station..."
                  value={saved_safe?.nearest_transit_stop ?? ""}
                  class="w-full px-6 py-4 bg-gray-50 border-0 rounded-2xl text-base focus:ring-2 focus:ring-black focus:bg-white transition-all"
                />
                <p class="text-xs text-gray-500 mt-2">Tapez pour rechercher</p>
              </div>
            </div>
          </section>

        </div>

        <!-- Submit Button (kept separate so it doesn't inherit the 120px section gap) -->
        <div class="pt-10">
          <button
            type="submit"
            class="ms-btn w-full h-[56px] font-normal"
          >
            Enregistrer les modifications
          </button>
        </div>
      </form>

    </div>
  </div>

  <script>
    // @ts-nocheck

    const profileForm = document.getElementById('profileForm');

    profileForm?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.currentTarget;
        if (!(form instanceof HTMLFormElement)) return;

        if (form.dataset.saving === "1") return;
        form.dataset.saving = "1";

        const btn = form.querySelector('button[type="submit"]');
        const button = btn instanceof HTMLButtonElement ? btn : null;

        const originalText =
        button && button.textContent ? button.textContent : "Enregistrer les modifications";

        let status = form.querySelector('#profileSaveStatus');
        if (!(status instanceof HTMLElement)) {
        status = document.createElement('div');
        status.id = 'profileSaveStatus';
        status.className = 'mt-4 text-sm';
        status.setAttribute('role', 'status');
        status.setAttribute('aria-live', 'polite');
        form.appendChild(status);
        }

        function setStatus(message, kind) {
        status.textContent = message || '';
        status.className =
            'mt-4 text-sm ' +
            (kind === 'error'
            ? 'text-red-700'
            : kind === 'success'
                ? 'text-emerald-700'
                : 'text-gray-600');
        }

        function resetButtonText() {
        if (!button) return;
        button.textContent = originalText;
        }

        // Clear status when user edits any field after a save attempt
        const clearStatusOnce = () => setStatus('', 'info');
        form.addEventListener('input', clearStatusOnce, { once: true });

        setStatus('', 'info');

        if (button) {
        button.disabled = true;
        button.textContent = "Enregistrement...";
        }

        try {
        const res = await fetch('/api/profile/save', {
            method: 'POST',
            body: new FormData(form),
            headers: { 'Accept': 'application/json' },
        });

        let out = null;
        try {
            out = await res.json();
        } catch (_) {
            out = null;
        }

        if (!res.ok) {
            if (button) button.textContent = "Réessayer";
            setStatus((out && out.error) ? out.error : `Erreur lors de l’enregistrement (HTTP ${res.status}).`, 'error');
            return;
        }

        if (!out || out.ok !== true) {
            if (button) button.textContent = "Réessayer";
            setStatus((out && out.error) ? out.error : 'Erreur lors de l’enregistrement.', 'error');
            return;
        }

        setStatus('Profil enregistré.', 'success');

        if (button) {
            button.textContent = "✓ Modifications enregistrées";
            setTimeout(() => {
            resetButtonText();
            }, 2000);
        }
        } catch (err) {
        if (button) button.textContent = "Réessayer";
        setStatus('Erreur réseau. Veuillez réessayer.', 'error');
        } finally {
        form.dataset.saving = "0";
        if (button) button.disabled = false;
        // If an error happened, keep "Réessayer" visible; if success timeout already set, it will reset.
        // If neither, ensure we don't leave an empty label.
        if (button && !button.textContent) resetButtonText();
        }
    });

    const origin = document.querySelector('select[name="origin_city_ids"]');
    const originSelect = origin instanceof HTMLSelectElement ? origin : null;

    if (originSelect) {
      function syncOriginCityLabels() {
        const selected = Array.from(originSelect.selectedOptions);

        // Keep your max-3 rule
        if (selected.length > 3) {
          selected[selected.length - 1].selected = false;
        }

        // Recompute after enforcing limit
        const kept = Array.from(originSelect.selectedOptions);

        // Only keep real INSEE codes (5 digits). Skip idf_other, paca_other, etc.
        const labels = kept
          .filter((opt) => /^\d{5}$/.test(opt.value))
          .map((opt) => (opt.textContent || "").trim());

        const l1 = document.getElementById("origin_city_label_1");
        const l2 = document.getElementById("origin_city_label_2");
        const l3 = document.getElementById("origin_city_label_3");

        if (l1) l1.value = labels[0] || "";
        if (l2) l2.value = labels[1] || "";
        if (l3) l3.value = labels[2] || "";
      }

      originSelect.addEventListener("change", syncOriginCityLabels);

      // Ensure labels are set even if the user doesn’t touch the field before saving
      syncOriginCityLabels();
    }

    function enableClickToggleMultiSelect(selectEl, maxSelected) {
        if (!selectEl || !(selectEl instanceof HTMLSelectElement)) return;
        if (!selectEl.multiple) return;

        selectEl.addEventListener(
        'mousedown',
        function (e) {
            const opt = e.target;
            if (!(opt instanceof HTMLOptionElement)) return;

            e.preventDefault();

            opt.selected = !opt.selected;

            const selected = Array.from(selectEl.selectedOptions);
            if (selected.length > maxSelected) {
            opt.selected = false;
            }

            selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        },
        true
        );
    }

    enableClickToggleMultiSelect(
        document.querySelector('select[name="primary_audience_1"]'),
        2
    );

    enableClickToggleMultiSelect(
        document.querySelector('select[name="origin_city_ids"]'),
        3
    );

    // ------------------------------
    // BAN address autocomplete (company_address)
    // ------------------------------
    (function () {
      const input = document.getElementById("companyAddressInput");
      const box = document.getElementById("companyAddressSuggestions");

      if (!(input instanceof HTMLInputElement)) return;
      if (!(box instanceof HTMLDivElement)) return;

      let aborter = null;
      let activeIndex = -1;
      let items = []; // current feature list

      function hide() {
        box.classList.add("hidden");
        box.innerHTML = "";
        activeIndex = -1;
        items = [];
      }

      function show() {
        box.classList.remove("hidden");
      }

      function esc(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function debounce(fn, ms) {
        let t = null;
        return function (...args) {
          if (t) clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), ms);
        };
      }

      async function fetchBAN(q) {
        if (aborter) aborter.abort();
        aborter = new AbortController();

        const url = new URL("https://api-adresse.data.gouv.fr/search");
        url.searchParams.set("q", q);
        url.searchParams.set("limit", "6");
        url.searchParams.set("type", "housenumber");

        const res = await fetch(url.toString(), {
          method: "GET",
          headers: { Accept: "application/json" },
          signal: aborter.signal,
        });

        if (!res.ok) return [];
        const data = await res.json().catch(() => null);
        const feats = Array.isArray(data?.features) ? data.features : [];
        return feats;
      }

      function render(features) {
        items = features;
        activeIndex = -1;

        if (!items.length) {
          hide();
          return;
        }

        const html = items
          .map((f, i) => {
            const label = f?.properties?.label ?? "";
            const score = typeof f?.properties?.score === "number" ? f.properties.score : null;
            return `
              <button
                type="button"
                data-idx="${i}"
                class="w-full text-left px-5 py-3 hover:bg-gray-50 focus:bg-gray-50 outline-none"
              >
                <div class="text-sm text-gray-900">${esc(label)}</div>
              </button>
            `;
          })
          .join("");

        box.innerHTML = html;
        show();
      }

      function pick(i) {
        const f = items[i];
        const label = f?.properties?.label;
        if (typeof label === "string" && label.trim()) {
          input.value = label.trim();
          input.dispatchEvent(new Event("input", { bubbles: true }));
        }
        hide();
      }

      const onInput = debounce(async () => {
        const q = input.value.trim();
        if (q.length < 6) {
          hide();
          return;
        }

        try {
          const feats = await fetchBAN(q);
          render(feats);
        } catch (e) {
          // Network / abort: silently degrade
          hide();
        }
      }, 220);

      input.addEventListener("input", onInput);

      // Click selection
      box.addEventListener("click", (e) => {
        const btn = e.target instanceof Element ? e.target.closest("button[data-idx]") : null;
        if (!btn) return;
        const idx = Number(btn.getAttribute("data-idx"));
        if (Number.isFinite(idx)) pick(idx);
      });

      // Keyboard navigation
      input.addEventListener("keydown", (e) => {
        if (box.classList.contains("hidden")) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, items.length - 1);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, 0);
        } else if (e.key === "Enter") {
          if (activeIndex >= 0) {
            e.preventDefault();
            pick(activeIndex);
          }
        } else if (e.key === "Escape") {
          hide();
        }

        // highlight active
        const buttons = box.querySelectorAll("button[data-idx]");
        buttons.forEach((b) => b.classList.remove("bg-gray-50"));
        if (activeIndex >= 0 && buttons[activeIndex]) {
          buttons[activeIndex].classList.add("bg-gray-50");
          (buttons[activeIndex]).scrollIntoView({ block: "nearest" });
        }
      });

      // Hide when clicking outside
      document.addEventListener("mousedown", (e) => {
        const t = e.target;
        if (!(t instanceof Node)) return;
        if (t === input || box.contains(t)) return;
        hide();
      });

      // Hide on blur (with small delay so click can register)
      input.addEventListener("blur", () => {
        setTimeout(() => hide(), 150);
      });
    })();

  </script>

</BaseLayout>
