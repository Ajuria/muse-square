---
export const prerender = false;

function ymdUtcToday(): string {
  const now = new Date();
  const y = now.getUTCFullYear();
  const m = String(now.getUTCMonth() + 1).padStart(2, "0");
  const d = String(now.getUTCDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

const u = new URL(Astro.request.url);

// If user lands on /month with no canonical params, redirect before any HTML renders.
// This eliminates the second page-load, hence eliminates the second API call.
if (!u.searchParams.get("window_start_date")) {
  const base =
    u.searchParams.get("selected_date") ||
    u.searchParams.get("anchor_date") ||
    ymdUtcToday();

  u.searchParams.set("window_start_date", base);
  u.searchParams.set("selected_date", base);
  u.searchParams.set("anchor_date", base);

  return Astro.redirect(u.pathname + u.search, 302);
}

import BaseLayout from "../../../layouts/BaseLayout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";
import InsightBottomBar from "../../../components/InsightBottomBar.astro";
import { MS_ASTER_CONTRACT, MS_ASTER_CONTRACT_VERSION } from "../../../lib/ai/msAsterContract";

/**
 * Truth-based: same location_id resolution pattern as prompt.astro.
 */
const location_id =
  (Astro.locals &&
    typeof (Astro.locals as any).location_id === "string" &&
    (Astro.locals as any).location_id.trim())
    ? (Astro.locals as any).location_id.trim()
    : null;

const location_id_for_dev = location_id ?? "les_costieres_de_l_art";
---

<SignedOut>
  <script is:inline>
    window.location.href = "/sign-in";
  </script>
</SignedOut>

<SignedIn>
  <BaseLayout
    title="Insight Event ‚Äî Mois"
    hideSurveyCta={true}
    hideFooter={true}
  >
    <div id="ie-30d-root" data-role="ie-30d-root">
      <main id="ie-30d-main" data-role="ie-30d-main">
        <header id="ie-30d-header" data-role="ie-30d-header">
            <nav id="ie-breadcrumb" aria-label="Breadcrumb">
                <span class="ie-breadcrumb-root">Insight Event</span>
                <span class="ie-breadcrumb-sep">/</span>
                <span class="ie-breadcrumb-current" id="ie-breadcrumb-current">Mois</span>
            </nav>
        </header>

        <section id="ie-30d-takeaway" data-role="ie-30d-takeaway">
          <div id="ie-30d-takeaway-header" data-role="ie-30d-takeaway-header">
            <div id="ie-30d-takeaway-title" data-role="ie-30d-takeaway-title">
              <span aria-hidden="true">‚ú¶</span>
              <span>Points cl√©s</span>
            </div>
            <div>Insight IA</div>
          </div>

          <div id="ie-30d-takeaway-card" data-role="ie-30d-takeaway-card">
            <p id="ie-30d-takeaway-text" data-role="ie-30d-takeaway-text"><!-- TAKEAWAY_ANCHOR --></p>
          </div>
        </section>

        <!-- =========================
        R√âGLAGES AVANC√âS (v1) ‚Äî Contraintes m√©tier
        Placement: directly under Top 3 cards (affects recommendations only)
        ========================= -->
        <section id="ie-30d-constraints" data-role="ie-30d-constraints" aria-label="R√©glages avanc√©s">
          <details id="ie-constraints-details">
            
            <summary id="ie-constraints-summary" class="ie-section-header ie-filters-header">
              <span class="ie-filters-icon" aria-hidden="true">‚öôÔ∏é</span>
              <span class="ie-section-title">Filtres</span>
            </summary>


            <div id="ie-constraints-body">
              <div id="ie-constraints-row">
                  <div class="ms-chip-grid" role="group" aria-label="Contraintes m√©tier">
                    <button type="button" class="ms-chip" data-checkbox="ie-filter-publicHoliday">
                      <span class="ms-chip__check" aria-hidden="true"></span>
                      <span class="ms-chip__label">Jours f√©ri√©s</span>
                    </button>

                    <button type="button" class="ms-chip" data-checkbox="ie-filter-schoolHoliday">
                      <span class="ms-chip__check" aria-hidden="true"></span>
                      <span class="ms-chip__label">Vacances scolaires</span>
                    </button>

                    <button type="button" class="ms-chip" data-checkbox="ie-filter-promoDays">
                      <span class="ms-chip__check" aria-hidden="true"></span>
                      <span class="ms-chip__label">Jours promo</span>
                    </button>

                    <button type="button" class="ms-chip" data-checkbox="ie-filter-competition">
                      <span class="ms-chip__check" aria-hidden="true"></span>
                      <span class="ms-chip__label">Forte concurrence</span>
                    </button>

                    <button type="button" class="ms-chip" data-checkbox="ie-filter-badWeather">
                      <span class="ms-chip__check" aria-hidden="true"></span>
                      <span class="ms-chip__label">Fortes intemp√©ries</span>
                    </button>

                    <!-- optional spacer so row 2 aligns perfectly under col 3 -->
                    <span class="ms-chip-spacer" aria-hidden="true"></span>
                  </div>

                  <!-- hidden inputs: JS reads these by id -->
                  <input id="ie-filter-publicHoliday" type="checkbox" hidden />
                  <input id="ie-filter-schoolHoliday" type="checkbox" hidden />
                  <input id="ie-filter-promoDays" type="checkbox" hidden />
                  <input id="ie-filter-competition" type="checkbox" hidden />
                  <input id="ie-filter-badWeather" type="checkbox" hidden />
              </div>
            </div>
          </details>
        </section>

        <!-- =========================
        FILTER BAR (v1) ‚Äî 4 buttons
        Placement: under Points cl√©s, above constraints + calendar
        ========================= -->
        <section id="ie-30d-filterbar" data-role="ie-30d-filterbar" aria-label="Filtres rapides">
          <div class="ms-seg" role="tablist" aria-label="Filtres rapides">
            <button type="button" class="ms-seg__btn is-active" data-ms-filter="top3" role="tab" aria-selected="true">
              Top 3
            </button>
            <button type="button" class="ms-seg__btn" data-ms-filter="vacances" role="tab" aria-selected="false">
              Vacances
            </button>
            <button type="button" class="ms-seg__btn" data-ms-filter="ferie" role="tab" aria-selected="false">
              F√©ri√©
            </button>
            <button type="button" class="ms-seg__btn" data-ms-filter="temps_forts" role="tab" aria-selected="false">
              Temps forts
            </button>
          </div>
        </section>

        <section id="ie-30d-calendar-section" data-role="ie-30d-calendar-section">
          <div id="ie-30d-calendar-header">
            <div>CALENDRIER</div>
            <div></div>
          </div>

          <div id="ie-30d-calendar-card">
            <div
              id="ie-30d-month-header"
              data-role="ie-30d-month-header"
              data-window-start=""
            >
              <div class="ie-30d-month-center">
                <h2 id="ie-30d-display-label" data-role="ie-30d-display-label"></h2>

                  <select
                    id="ie-30d-month-select"
                    class="ie-30d-month-select is-chevron-only"
                    aria-label="Choisir un mois"
                    title="Choisir un mois"
                  >
                  </select>
                </div>
              </div>
            </div>
                      
            <div id="ie-30d-calendar" data-role="ie-30d-calendar">
              <div id="ie-30d-weekdays" data-role="ie-30d-weekdays">
                <div class="ie-30d-weekday">Lun</div>
                <div class="ie-30d-weekday">Mar</div>
                <div class="ie-30d-weekday">Mer</div>
                <div class="ie-30d-weekday">Jeu</div>
                <div class="ie-30d-weekday">Ven</div>
                <div class="ie-30d-weekday">Sam</div>
                <div class="ie-30d-weekday">Dim</div>
              </div>

              <div id="ie-30d-grid" data-role="ie-30d-grid">
                <!-- GRID_ANCHOR -->
              </div>
            </div>
          </div>
        </section>

        <!-- Month intro overlay (client-only, v1: localStorage) -->
        <div
          id="ms-month-intro"
          class="ms-month-intro hidden"
          role="dialog"
          aria-modal="true"
          aria-labelledby="ms-month-intro-title"
        >
          <div class="ms-month-intro__card">
            <div class="ms-month-intro__icon" aria-hidden="true">üóìÔ∏è</div>

            <h2 id="ms-month-intro-title" class="ms-month-intro__title">
              Comment utiliser le calendrier
            </h2>

            <ul class="ms-month-intro__list">
              <li><strong>A, B et C</strong> indiquent si un jour est plus ou moins favorable pour votre √©v√®nement.</li>
              <li>Les signes <strong>"+"</strong> et <strong>"‚àí"</strong> pr√©cisent si le jour est meilleur ou l√©g√®rement en dessous de la moyenne.</li>
              <li><strong>Cliquez sur 1 √† 7 jours</strong> pour voir le d√©tail de chaque journ√©e.</li>
            </ul>

            <button type="button" class="ms-month-intro__cta" id="ms-month-intro-dismiss">
              NE PLUS AFFICHER
            </button>
          </div>
        </div>

        <script is:inline>
          (function () {
            const KEY = "ms_month_intro_dismissed_v1";

            const root = document.getElementById("ms-month-intro");
            if (!root) return;

            const dismissBtn = document.getElementById("ms-month-intro-dismiss");
            const backdrop = root.querySelector(".ms-month-intro__backdrop");

            const hide = () => {
              root.classList.add("hidden");
              root.setAttribute("aria-hidden", "true");
              document.documentElement.style.overflow = "";
              document.body.style.overflow = "";
            };

            const show = () => {
              root.classList.remove("hidden");
              root.removeAttribute("aria-hidden");
              document.documentElement.style.overflow = "hidden";
              document.body.style.overflow = "hidden";
            };

            // Show only if user did not dismiss
            try {
              const dismissed = window.localStorage.getItem(KEY) === "1";
              if (!dismissed) show();
              else hide();
            } catch (_) {
              // If storage blocked, default to showing once per page load
              show();
            }

            const dismissForever = () => {
              try { window.localStorage.setItem(KEY, "1"); } catch (_) {}
              hide();
            };

            if (dismissBtn) dismissBtn.addEventListener("click", dismissForever);

            // Optional niceties (safe + standard UX):
            // click outside closes (WITHOUT saving preference)
            if (backdrop) backdrop.addEventListener("click", hide);

            // Escape closes (WITHOUT saving preference)
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && !root.classList.contains("hidden")) hide();
            });
          })();
        </script>
      </main>

      <div id="ie-30d-bottom-bar" data-role="ie-30d-bottom-bar">
        <div id="ie-30d-bottom-inner">
          <div id="ie-30d-selected-wrap">
            <div id="ie-30d-selected-row">
              <div id="ie-30d-selected-title">CHOIX (0/7)</div>
              <div id="ie-30d-selected-pills" aria-label="Selected days"></div>
              <div id="ie-30d-selected-hint" style="display:none;">Maximum 7 jours</div>
            </div>
          </div>
      
          <button id="ie-30d-view-details" data-role="ie-30d-view-details" type="button">Voir ‚Üí</button>
        </div>
      </div>

      <InsightBottomBar active="month" showActions={false} search={Astro.url.search} />

    <style is:global>
      /* ==============================
      IE 30D ‚Äî UI ROOT ISOLATION
      ============================== */
      #ie-30d-root{
        background: #ffffff !important;
        color: #111827 !important;
        font-family: var(--font-family) !important;
      }

      #ie-30d-root *{
        box-sizing: border-box;
      }

      /* =============================
      IE Capsule (30d) ‚Äî typography + section rhythm ONLY
      ============================= */
      #ie-30d-root{
        --ie-bottom-actions-h: 65px;
        --ie-bottom-nav-h: 74px;
        --ie-30d-selectedbar-h: var(--ie-bottom-actions-h);

        --ie-kicker-size: var(--font-size-label, 12px);
        --ie-kicker-weight: var(--font-weight-medium, 500);
        --ie-kicker-tracking: var(--letter-spacing-wider, 0.08em);
        --ie-kicker-color: var(--color-text-muted, rgba(17,24,39,0.45));
        --ie-kicker-mb: 16px;

        --ie-title-mb: 12px;
        --ie-section-gap: 18px;

        --ie-body-size: 14px;
        --ie-body-lh: var(--line-height-relaxed, 1.55);
        --ie-body-color: var(--color-text-primary, #111827);
      }

      #ie-30d-main{
        max-width: 620px;
        margin: 0 auto;
        padding: 0 20px;
      }

      #ie-30d-main{
        padding-bottom: calc(var(--ie-30d-selectedbar-h) + var(--ie-bottom-nav-h) + 28px) !important;
      }

      @media (max-width: 620px){
        #ie-30d-main{ padding: 0 16px; }
      }

      #ie-30d-takeaway{
        margin: 0 0 var(--ie-section-gap);
      }

      #ie-30d-takeaway-header {
        display:flex;
        align-items:center;
        justify-content:space-between;

        font-size: var(--ie-kicker-size);
        font-weight: var(--ie-kicker-weight);
        letter-spacing: var(--ie-kicker-tracking);
        text-transform: uppercase;
        color: var(--ie-kicker-color);

        opacity: 0.75;
        margin: 0 0 var(--ie-title-mb);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--color-border);
      }

      #ie-30d-takeaway-title { display:flex; align-items:center; gap:8px; }
      #ie-30d-takeaway-card{
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        padding: var(--card-padding-sm);
      }

      #ie-30d-takeaway-text { 
        margin: 0;
        font-size: 14px;
        line-height: 1.45;
        opacity: 0.92;
        white-space: pre-line; /* ‚Üê THIS IS THE FIX */
      }

      /* =============================
      Filter bar (4 buttons)
      ============================= */
      #ie-30d-filterbar{
        margin: 0 0 var(--ie-section-gap);
      }

      .ms-seg{
        width: 100%;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      @media (max-width: 520px){
        .ms-seg{
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .ms-seg__btn{
        height: 36px;
        width: 100%;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        background: var(--color-bg-card);
        color: var(--color-text-secondary);

        font-family: var(--font-family);
        font-size: var(--font-size-label);           /* slightly smaller = cleaner in caps */
        font-weight: var(--font-weight-semibold);
        letter-spacing: var(--letter-spacing-wider); /* consistent with your section headers */
        text-transform: uppercase;

        cursor: pointer;
        user-select: none;

        transition: border-color 120ms ease, color 120ms ease, background-color 120ms ease;
      }

      .ms-seg__btn:hover{
        border-color: var(--color-border-hover);
        color: var(--color-text-primary);
        background: rgba(17,24,39,0.03); /* subtle hover, not brand */
      }

      .ms-seg__btn:focus-visible{
        outline: none;
        border-color: var(--color-brand-blue);
        box-shadow: 0 0 0 3px rgba(29,59,179,0.12); /* keep as-is unless you have a token */
      }

      /* Active = brand blue outline + text ONLY */
      .ms-seg__btn.is-active{
        border-color: var(--color-brand-blue);
        background: var(--color-bg-card); /* no fill */
        color: var(--color-brand-blue);
      }

      #ie-30d-top3{
        margin: var(--ie-section-gap) 0 0;
        padding-bottom: var(--space-xl);
      }

      #ie-30d-top3-header{
        display:flex;
        align-items:center;
        justify-content:space-between;

        font-size: var(--ie-kicker-size);
        font-weight: var(--ie-kicker-weight);
        letter-spacing: var(--ie-kicker-tracking);
        text-transform: uppercase;
        color: var(--ie-kicker-color);

        opacity:0.70;
        margin: 0 0 var(--ie-title-mb);
        padding-bottom:10px;
        border-bottom:1px solid var(--color-border);
      }

      .ie-group-label{
        font-size: var(--font-size-small);
        font-weight: var(--font-weight-semibold);
        letter-spacing: var(--letter-spacing-wider);
        text-transform: uppercase;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
      }

      #ie-constraints-summary.ie-section-header{
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;

        font-size: var(--ie-kicker-size);
        font-weight: var(--ie-kicker-weight);
        letter-spacing: var(--ie-kicker-tracking);
        text-transform: uppercase;
        color: var(--ie-kicker-color);

        margin: 0 0 var(--ie-title-mb);
      }

      .ie-filters-icon{
        font-size: 14px;
        opacity: 0.7;
      }

      #ie-constraints-summary::-webkit-details-marker{
        display:none;
      }

      /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      Advanced Settings ‚Äî styled using design-tokens.css
      (Add this AFTER design-tokens.css is loaded)
      ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

      /* Optional (recommended): tiny additions to avoid magic numbers.
        If you don't want to touch tokens, keep these here. */
      :root{
        --space-sm: 8px;
        --control-height-sm: 32px;
        --control-padding-x-sm: 12px;
      }

      /* Card wrapper for the whole ‚ÄúR√©glages avanc√©s‚Äù block */
      .ms-advanced-settings{
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--card-padding-sm);
        margin-top: var(--space-xl);
        margin-bottom: var(--space-xl);
      }

      /* Header row: icon + ‚ÄúR√âGLAGES AVANC√âS‚Äù + chevron */
      .ms-advanced-settings__header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom: var(--space-md);
      }

      .ms-advanced-settings__header-left{
        display:flex;
        align-items:center;
        gap: var(--space-md);
      }

      /* Section titles: R√âGLAGES AVANC√âS, POINTS CL√âS, CALENDRIER */
      .ms-section-title{
        font-family: var(--font-family);
        font-size: var(--font-size-label);           /* 12px */
        font-weight: var(--font-weight-semibold);    /* 600 */
        letter-spacing: var(--letter-spacing-wider); /* 0.08em */
        text-transform: uppercase;
        color: var(--color-text-primary);
        line-height: var(--line-height-normal);
      }

      /* Secondary group label: CONTRAINTES M√âTIER */
      .ms-group-label{
        font-family: var(--font-family);
        font-size: var(--font-size-small);           /* 11px */
        font-weight: var(--font-weight-semibold);    /* 600 */
        letter-spacing: var(--letter-spacing-wider);
        text-transform: uppercase;
        color: var(--color-text-secondary);
        line-height: var(--line-height-normal);
        margin-bottom: var(--space-sm);
      }

      /* Spacing between groups inside the card */
      .ms-section-block{
        margin-top: var(--space-xl);                 /* 24px */
      }

      /* Divider (optional) */
      .ms-divider{
        height: 1px;
        background: var(--color-border);
        margin: var(--space-lg) 0;                   /* 20px */
      }

      /* Chip grid */
      .ms-chip-grid{
        display: grid;
        grid-template-columns: repeat(3, max-content); /* 3 aligned columns */
        gap: var(--space-sm) 12px;
        align-items: center;
      }

      /* Responsive: 2 columns on small screens */
      @media (max-width: 520px){
        .ms-chip-grid{
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      /* spacer cell to keep 2nd row aligned */
      .ms-chip-spacer{
        display: block;
      }
      @media (max-width: 520px){
        .ms-chip-spacer{ display:none; }
      }

      /* Chip / toggle pill */
      .ms-chip{
        height: var(--control-height-sm);            /* 32px */
        padding: 0 var(--control-padding-x-sm);      /* 12px */
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        background: var(--color-bg-card);
        color: var(--color-text-primary);
        font-family: var(--font-family);
        font-size: var(--font-size-subtitle);        /* 13px */
        font-weight: var(--font-weight-medium);      /* 500 */
        line-height: var(--line-height-normal);
        display:inline-flex;
        align-items:center;
        gap: var(--space-sm);
        cursor:pointer;
        user-select:none;
        transition: border-color 120ms ease, box-shadow 120ms ease;
      }

      /* Hover / focus */
      .ms-chip:hover{
        border-color: var(--color-border-hover);
      }
      .ms-chip:focus-visible{
        outline:none;
        border-color: var(--color-border-hover);
        box-shadow: 0 0 0 3px rgba(29,59,179,0.12);
      }

      /* Active (checked) */
      .ms-chip.is-active{
        border-color: var(--color-brand-blue);
      }

      /* Checkbox icon inside pill */
      .ms-chip{
        justify-content: flex-start; /* ensures label lines up */
      }

      .ms-chip__check{
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid var(--color-border);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        flex: 0 0 16px;
        position: relative;
      }

      /* checkmark */
      .ms-chip__check::after{
        content: "";
        width: 8px;
        height: 4px;
        border-left: 2px solid transparent;
        border-bottom: 2px solid transparent;
        transform: rotate(-45deg);
        margin-top: -1px;
      }

      /* active = blue box + white tick */
      .ms-chip.is-active .ms-chip__check{
        border-color: var(--color-brand-blue);
        background: var(--color-brand-blue);
      }
      .ms-chip.is-active .ms-chip__check::after{
        border-left-color: #fff;
        border-bottom-color: #fff;
      }

      /* Optional: muted state */
      .ms-chip.is-disabled{
        opacity: 0.5;
        cursor:not-allowed;
      }

      /* Make the ‚ÄúCalendrier‚Äù title match section style */
      .ms-calendar-title{
        margin-top: var(--space-xl);
        margin-bottom: var(--space-md);
      }

      /* If your calendar is inside another card, keep spacing consistent */
      .ms-calendar-card{
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--card-padding-sm);
      }

      /* If you still have legacy checkbox rows, normalize them */
      .ms-checkbox-row{
        display:flex;
        flex-wrap:wrap;
        gap: var(--space-sm);
      }

      .ie-30d-day{ position:relative; }

      #ie-30d-month-header{
        display: flex;
        justify-content: center;   /* key: center the whole unit */
        margin: 6px 0 var(--space-xl);
      }

      .ie-30d-month-center{
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .ie-30d-month-select.is-chevron-only{
        width: 28px;
        min-width: 28px;
        padding: 0;
        text-indent: -9999px;     /* hides text */
        color: transparent;       /* double safety */
        background-position: center;
      }

      .ie-30d-month-select-wrap{
        flex: 0 0 auto;
      }

      .ie-30d-month-select{
        width: 28px;
        min-width: 28px;
        height: 28px;
        padding: 0;

        border: 0;

        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;

        color: transparent;
        text-indent: -9999px;

        background-color: transparent;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='none' stroke='%23111827' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 8 10 12 14 8'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 16px;

        cursor: pointer;
      }

      .ie-30d-month-select:focus-visible{
        outline: none;
        border-color: var(--color-brand-blue);
        box-shadow: 0 0 0 3px rgba(29,59,179,0.12);
      }

      .ie-30d-month-select:focus-visible{
        outline: none;
        border-color: var(--color-brand-blue);
        box-shadow: 0 0 0 3px rgba(29,59,179,0.12);
      }

      #ie-30d-calendar-section{
        margin: var(--ie-section-gap) 0 0;
      }

      #ie-30d-calendar-header{
        display:flex;
        align-items:center;
        justify-content:space-between;

        font-size: var(--ie-kicker-size);
        font-weight: var(--ie-kicker-weight);
        letter-spacing: var(--ie-kicker-tracking);
        text-transform: uppercase;
        color: var(--ie-kicker-color);

        opacity: 0.75;
        margin: 0 0 var(--ie-title-mb);
        padding-bottom: 8px;
        border-bottom: 1px solid var(--color-border);
      }

      /* Force 7x5 visible grid: hide last row (7 cells) */
      #ie-30d-grid > .ie-30d-day:nth-last-child(-n + 7){
        display: none !important;
      }

      #ie-30d-calendar-card{
        background: transparent;
        border: 0;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
      }

      /* Keep shadows only where they still make sense */
      .ie-top3-card,
      #ie-30d-takeaway-card {
        box-shadow: var(--shadow-md);
      }

      /* Grid day constrained (filters ON) */
      #ie-30d-grid .ie-30d-day.ie-30d-constrained{
        opacity: 0.35;
      }

      #ie-30d-grid .ie-30d-day.ie-30d-constrained .ie-30d-medal{
        opacity: 0.60;
      }

      #ie-30d-grid .ie-30d-day.ie-30d-constrained .ie-30d-weather{
        opacity: 0.60;
      }

      #ie-30d-grid .ie-30d-day.ie-30d-constrained .ie-30d-weather img{
        filter: grayscale(1);
      }

      .ie-spillover {
        opacity: 0.22;
      }

      #ie-30d-display-label{
        font-family: var(--font-family);
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-medium);
        letter-spacing: 0.02em;
        color: var(--color-text-primary);
        margin: 0;
        white-space: nowrap;
      }

      .ie-30d-month-nav{
        border: none;
        background: transparent;
        padding: 8px 10px;
        font-size: calc(var(--font-size-lg) + 6px);
        line-height: 1;
        font-weight: 800;
        color: var(--color-text-secondary);
        cursor: pointer;
        border-radius: 10px;
      }

      .ie-30d-month-nav:hover{
        color: var(--color-text-primary);
        background: rgba(17,24,39,0.06);
      }

      #ie-30d-month-prev{
        justify-self: start;
      }

      #ie-30d-month-next{
        justify-self: end;
      }

      #ie-30d-weekdays{
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px 8px;
        width: 100%;
        margin: 0 0 8px;

        font-size: var(--font-size-label);
        letter-spacing: var(--letter-spacing-wider);
        color: var(--color-text-muted);
        font-weight: var(--font-weight-medium);
        text-transform: uppercase;
      }

      /* constrained days = visually de-emphasized (but still clickable/selectable) */
      .ie-30d-day.ie-30d-constrained{
        opacity: 0.28;
      }
      .ie-30d-day.ie-30d-constrained .ie-30d-weather img{
        filter: grayscale(1) contrast(1.1);
      }

      .ie-30d-spillover-selected {
        outline: 1px dashed rgba(17,24,39,0.35);
      }

      .ie-30d-weekday{
        text-align:center;
        line-height: 1;
      }

      #ie-30d-grid{
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px 8px;
        width: 100%;
        margin: 0;
      }

      .ie-30d-day{
        border: 0;
        border-radius: 0;
        padding: 6px 0 12px;
        height: 72px;
        overflow: hidden;

        display: grid;
        grid-template-rows: auto 18px 1fr;
        align-items: center;

        color: inherit;
        text-decoration: none;
        background: transparent;

        position: relative;
      }

      .ie-30d-daynum{
        font-size: 12px;
        opacity: 0.85;
        margin: 0;
      }

      .ie-30d-medal{
        font-size: 12px;
        font-weight: 600;
        height: 18px;
        line-height: 18px;
        margin: 0;
        opacity: 0.88;
      }
      
      .ie-30d-weather{
        margin-top: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;

        opacity: 0.95;
        margin-bottom: 2px;

        gap: 0;
      }

      .ie-30d-weather-label{
        font-family: var(--font-family);
        font-size: 9px;
        line-height: 1;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--color-text-secondary);
        opacity: 0.92;
      }

      #ie-30d-root .ie-30d-weather img{
        width: 24px !important;
        height: 24px !important;
        max-width: none !important;
        max-height: none !important;
        display: block;
      }

      .ie-out-window{ opacity:0.35; }
      .ie-out-window .ie-30d-medal{ opacity:0.60; }
      .ie-out-window .ie-30d-weather{ opacity:0.60; }
      .ie-out-window .ie-30d-weather img{ filter: contrast(1.1) brightness(0.70); }

      .ie-spillover { opacity: 0.30;}

      .ie-30d-day::after{
        content:"";
        position:absolute;
        left:50%;
        bottom:2px;
        width:22px;
        height:3px;
        transform:translateX(-50%);
        background: #111;
        border-radius: 2px;
        opacity: 0;
        pointer-events:none;
      }

      .ie-30d-selected-day::after{
        opacity: 0.90;
      }

      .ie-30d-day:hover::after{
        opacity: 0.45;
      }

      .ie-30d-day:focus:not(.ie-30d-selected-day)::after,
      .ie-30d-day:focus-visible:not(.ie-30d-selected-day)::after{
        opacity: 0;
      }

      .ie-30d-day.ie-30d-selected-day:focus::after,
      .ie-30d-day.ie-30d-selected-day:focus-visible::after{
        opacity: 0.90;
      }

      #ie-30d-bottom-bar{
        position: fixed;
        left: 0;
        right: 0;
        bottom: 74px;
        z-index: 80;

        background: #ffffff;
        border-top: 1px solid rgba(17,24,39,0.12);
        box-shadow: none;

        height: var(--ie-bottom-actions-h);
        display: flex;
        justify-content: center;

        pointer-events: auto;
      }

      .ms-bottombar{
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 70 !important;
      }

      #ms-month-intro { z-index: 10000 !important; }

      #ie-30d-bottom-inner{
        max-width: 620px;
        width: 100%;
        height: var(--ie-bottom-actions-h);
        padding: 0 20px;
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: space-between;
        pointer-events: auto;
      }

      @media (max-width: 620px){
        #ie-30d-bottom-inner{ padding: 0 16px; }
      }

      #ie-30d-view-details {
        flex: 0 0 auto;
        border: 0;
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 13px;
        font-weight: 700;
        background: #111;
        color: #fff;
        cursor: pointer;
        white-space: nowrap;
        pointer-events: auto;
      }

      #ie-30d-view-details:disabled{
        opacity: 0.35;
        cursor: default;
        pointer-events: none;
      }

      #ie-30d-view-details:active { transform:scale(0.98); }

      #ie-30d-selected-wrap{
        flex: 1 1 auto;
        min-width: 0;
        position: relative;
      }

      #ie-30d-selected-row{
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        min-width: 0;
      }

      #ie-30d-selected-title{
        flex: 0 0 auto;
        font-size: 11px;
        letter-spacing: 0.10em;
        text-transform: uppercase;
        font-weight: 500;
        color: var(--color-text-secondary);
        opacity: 0.90;
        white-space: nowrap;
      }

      #ie-30d-selected-pills{
        flex: 1 1 auto;
        min-width: 0;

        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        gap: 8px;

        max-height: 44px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 2px 0;
      }

      .ie-pill{
        display: inline-flex;
        align-items: center;
        justify-content: center;

        padding: 6px 10px;
        border-radius: 12px;
        background: rgba(17,24,39,0.06);
        border: 1px solid rgba(17,24,39,0.10);

        font-size: 12px;
        font-weight: 500;
        line-height: 1;

        color: var(--color-text-primary);
        white-space: nowrap;
        user-select: none;
      }

      .ie-pill:hover{
        border-color: rgba(17,24,39,0.18);
      }

      #ie-30d-selected-hint{
        position: absolute;
        right: 0;
        top: -18px;
        font-size: 11px;
        font-weight: 600;
        color: var(--color-text-secondary);
        opacity: 0.95;
        white-space: nowrap;
        pointer-events: none;
      }

      #ie-30d-root a:link,
      #ie-30d-root a:visited{
        color: inherit;
        text-decoration: none;
      }

      #ie-30d-root a:hover{
        text-decoration: none;
      }

    </style>
    <script is:inline define:vars={{ location_id }}>
    console.log("[IE] Month UI (Astro) loaded");
    console.log("[IE][DBG] month.astro inline script: BUILD_ID=2026-01-30-AAA", Date.now());

    // ---- HARD RUNTIME PROBE (must prove script is executing + handlers bind + clicks fire) ----
    window.addEventListener("error", (ev) => {
      try {
        console.error("[IE][window.error]", ev?.message, ev?.filename, ev?.lineno, ev?.colno, ev?.error);
      } catch (_) {}
    });

    window.addEventListener("unhandledrejection", (ev) => {
      try {
        console.error("[IE][unhandledrejection]", ev?.reason);
      } catch (_) {}
    });

    console.log("[IE] Script reached: after global error hooks");
    
    // --- Pills -> hidden checkbox bridge (must run after DOM is present) ---
    function bindConstraintChips(){
      document.querySelectorAll(".ms-chip").forEach((chip) => {
        const id = chip.getAttribute("data-checkbox");
        const input = id ? document.getElementById(id) : null;
        if (!(input instanceof HTMLInputElement)) return;

        const sync = () => chip.classList.toggle("is-active", input.checked === true);
        sync();

        chip.addEventListener("click", () => {
          input.checked = !input.checked;
          input.dispatchEvent(new Event("change", { bubbles: true }));
          sync();
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindConstraintChips, { once: true });
    } else {
      bindConstraintChips();
    }

    // -----------------------------
    // Filter bar (4 buttons) ‚Äî single active
    // -----------------------------
    function bindQuickFilters(){
      const root = document.getElementById("ie-30d-filterbar");
      if (!root) return;

      const btns = Array.from(root.querySelectorAll(".ms-seg__btn"));

      function setActive(key){
        btns.forEach((b) => {
          const k = b.getAttribute("data-ms-filter");
          const on = (k === key);
          b.classList.toggle("is-active", on);
          b.setAttribute("aria-selected", on ? "true" : "false");
        });

        // v1: store on window only (wiring to grid comes in next step)
        window.__ie_month_quick_filter = key;
        console.log("[IE][month] quick filter:", key);

        // apply mode to existing rendered grid (no re-render)
        try { applyGridMode(); } catch (_) {}    
      }

      // default
      const initial = "top3";
      setActive(initial);

      root.addEventListener("click", (e) => {
        const tgt = e.target;
        if (!(tgt instanceof Element)) return;

        const btn = tgt.closest(".ms-seg__btn");
        if (!btn) return;

        const key = btn.getAttribute("data-ms-filter");
        if (!key) return;

        setActive(key);
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindQuickFilters, { once: true });
    } else {
      bindQuickFilters();
    }

    // -----------------------------
    // Constraints UI -> predicates
    // -----------------------------
    function readConstraintFilters(){
      const get = (id) => {
        const el = document.getElementById(id);
        return el instanceof HTMLInputElement ? el.checked === true : false;
      };

      return {
        publicHoliday: get("ie-filter-publicHoliday"),
        schoolHoliday: get("ie-filter-schoolHoliday"),
        promoDays: get("ie-filter-promoDays"),
        competition: get("ie-filter-competition"),
        badWeather: get("ie-filter-badWeather"),
      };
    }

    // -----------------------------
    // Apply constraints to grid UI
    // - greys constrained days
    // - never hides them
    // -----------------------------
    async function updateGridConstraints(){
      const out = await loadMonthData();
      if (!out || !Array.isArray(out.days)) return;

      const filters = readConstraintFilters();

      // Map by YYYY-MM-DD
      const semanticByDate = new Map(
        out.days
          .map((r) => ({ ...r, date: asYmd(r?.date) }))
          .filter((r) => typeof r.date === "string" && r.date.length === 10)
          .map((r) => [r.date, r])
      );

      document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {
        const ymd = btn.getAttribute("data-date");
        if (!ymd) return;

        const semantic = semanticByDate.get(ymd);
        // If spillover/no semantic, don't constrain (keep existing spillover styling)
        if (!semantic) {
          btn.classList.remove("ie-30d-constrained");
          return;
        }

        const constrained = isConstrainedDay(semantic, filters);
        btn.classList.toggle("ie-30d-constrained", constrained);
        btn.setAttribute("aria-disabled", constrained ? "true" : "false");
      });
      
      try { applyGridMode(); } catch (_) {}
    }

    // --- Hidden inputs -> refresh grid constraints on any change (keyboard/programmatic) ---
    [
      "ie-filter-publicHoliday",
      "ie-filter-schoolHoliday",
      "ie-filter-promoDays",
      "ie-filter-competition",
      "ie-filter-badWeather",
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (el instanceof HTMLInputElement) {
        el.addEventListener("change", () => {
          try { updateGridConstraints(); } catch (_) {}
        });
      }
    });

    // ---- END PROBE ----

    // -----------------------------
    // Apply current quick-filter mode to grid:
    // - top3 => medal becomes 1er/2e/3e for best 3 only, weather stays
    // - vacances/ferie/temps_forts => icon+label replaces weather icon when condition matches, medal stays
    // -----------------------------
    function computeTop3RankMap(out, filters){
      const m = new Map();

      // 1) Prefer API-provided top_days (if present)
      const topDays =
        out?.window?.top_days ??
        out?.top_days ??
        [];
      let ranked = Array.isArray(topDays) ? topDays.slice() : [];

      // 2) Fallback: compute top3 from out.days by opportunity_score_final_local
      if (ranked.length === 0 && Array.isArray(out?.days)) {
        ranked = out.days
          .map((r) => ({ ...r, date: asYmd(r?.date) }))
          .filter((r) => typeof r.date === "string" && r.date.length === 10)
          .filter((d) => !isConstrainedDay(d, filters))
          .filter((d) => Number.isFinite(Number(d?.opportunity_score_final_local)))
          .sort((a, b) => Number(b.opportunity_score_final_local) - Number(a.opportunity_score_final_local));
      } else {
        // apply same constraint rule as Top3 cards
        ranked = ranked.filter((d) => !isConstrainedDay(d, filters));
      }

      const labels = ["1er", "2e", "3e"];
      for (let i = 0; i < Math.min(3, ranked.length); i++){
        const ymd = asYmd(ranked[i]?.date);
        if (ymd) m.set(ymd, labels[i]);
      }

      return m;
    }

    async function applyGridMode(){
      const out = await loadMonthData();
      if (!out || !Array.isArray(out.days)) return;

      const key = String(window.__ie_month_quick_filter || "top3");
      const filters = readConstraintFilters();

      // Build semantic map
      const semanticByDate = new Map(
        out.days
          .map((r) => ({ ...r, date: asYmd(r?.date) }))
          .filter((r) => typeof r.date === "string" && r.date.length === 10)
          .map((r) => [r.date, r])
      );

      const top3Rank = (key === "top3") ? computeTop3RankMap(out, filters) : new Map();

      document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {
        const ymd = btn.getAttribute("data-date");
        if (!ymd) return;

        const semantic = semanticByDate.get(ymd);
        const medalEl = btn.querySelector('[data-role="ie-medal"]');
        const iconImg = btn.querySelector('[data-role="ie-icon-img"]');
        const iconLbl = btn.querySelector('[data-role="ie-icon-label"]');

        // spillover: leave as-is
        if (!semantic) return;

        // ---- Medal behavior ----
        if (medalEl instanceof HTMLElement) {
          const baseMedal = resolveMedalText(semantic);

          if (key === "top3") {
            const rank = top3Rank.get(ymd);

            if (rank) {
              medalEl.textContent = rank;
              medalEl.style.color = "var(--color-brand-blue)";
            } else {
              medalEl.textContent = baseMedal;
              medalEl.style.color = "";
            }

            medalEl.style.display = "block";
          } else {
            // For mode filters:
            // Only hide medal IF overlay exists for that day
            const overlay = computeModeOverlay(semantic, key);

            if (overlay) {
              medalEl.textContent = "";
              medalEl.style.display = "none";
            } else {
              medalEl.textContent = baseMedal;
              medalEl.style.display = "block";
              medalEl.style.color = "";
            }
          }
        }
                        
        // ---- Icon behavior ----
        // default = weather
        const weatherSrc = weatherIconSrc(semantic.weather_code);

        const overlay = computeModeOverlay(semantic, key);

        if (iconImg instanceof HTMLImageElement) {
          const src = overlay?.iconSrc || weatherSrc || "";
          iconImg.src = src;
          iconImg.style.display = src ? "block" : "none";
        }

        if (iconLbl instanceof HTMLElement) {
          const text = overlay?.labelText || "";

          if (text) {
            iconLbl.textContent = text;
            iconLbl.style.display = "block";
            iconLbl.style.color = "var(--color-brand-blue)";
          } else {
            iconLbl.textContent = "";
            iconLbl.style.display = "none";
            iconLbl.style.color = "";
          }
        }
      });
    }
  
    function asYmd(v){
      if (!v) return null;
      if (typeof v === "string") return v.slice(0, 10);
      if (v instanceof Date) return v.toISOString().slice(0, 10);

      if (typeof v === "object") {
        if (typeof v.value === "string") return v.value.slice(0, 10);
        if (typeof v.toJSON === "function") {
          const j = v.toJSON();
          if (typeof j === "string") return j.slice(0, 10);
        }
      }

      return null;
    }

    // -----------------------------
    // Medal label resolution (A/B/C/A+/...)
    // Single source of truth for both grid render + mode apply.
    // -----------------------------
    function resolveMedalText(day){
      if (!day || typeof day !== "object") return "";

      // Accept several possible schema names (defensive, no semantic invention).
      const raw =
        day.opportunity_medal ??
        day.opportunity_medal_local ??
        day.opportunity_grade ??
        day.opportunity_grade_local ??
        day.opportunity_label ??
        day.opportunity_label_local ??
        day.score_medal ??
        day.medal ??
        "";

      if (typeof raw !== "string") return "";
      const v = raw.trim();
      return v;
    }

    // =========================================================
    // Business constraints (v1) ‚Äî single source of truth predicate
    // Meaning: when a constraint toggle is ON, matching days are EXCLUDED
    // from recommendation logic (top days, KPI counts, ranked lists),
    // but remain visible in the grid.
    // Pure + deterministic: no side effects, no external dependencies.
    // =========================================================
    function isConstrainedDay(day, filters){
      // Defensive: if bad inputs, never constrain
      if (!day || typeof day !== "object") return false;
      if (!filters || typeof filters !== "object") return false;

      // ---- Local helpers (keep all constants inside this function) ----
      const asBool = (v) => v === true;
      const asNum = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };

      // Threshold constants (v1 defaults; live only here)
      const RAIN_PROB_PCT_MIN = 60;   // precip_probability_max_pct >= 60
      const WIND_KMH_MIN = 40;        // wind_speed_10m_max >= 40
      const COMPETITION_EVENTS_MIN = 50; // events_within_10km_count >= 50

      // ---- Match rules (truth-based field names from your sample) ----
      // 1) Jours f√©ri√©s
      if (asBool(filters.publicHoliday)) {
        if (day.is_public_holiday_fr_flag === true) return true;
      }

      // 2) Vacances scolaires
      if (asBool(filters.schoolHoliday)) {
        if (day.is_school_holiday_flag === true) return true;
      }

      // 3) Jours promo
      if (asBool(filters.promoDays)) {
        // adjust the field name to your schema:
        // - you logged: is_commercial_event_flag_region: true
        if (day.is_commercial_event_flag_region === true) return true;

        // optionally: if you also have names list:
        // if (Array.isArray(day.commercial_event_names_region) && day.commercial_event_names_region.length) return true;
      }

      // 4) Bad weather = rain OR strong wind (v1)
      if (asBool(filters.badWeather)) {
        const p = asNum(day.precip_probability_max_pct);
        const w = asNum(day.wind_speed_10m_max);
        if ((p !== null && p >= RAIN_PROB_PCT_MIN) || (w !== null && w >= WIND_KMH_MIN)) return true;
      }

      // 5) Forte concurrence
      if (asBool(filters.competition)) {
        const c = asNum(day.events_within_10km_count);
        if (c !== null && c >= COMPETITION_EVENTS_MIN) return true;
      }

      return false;
    }

    function weatherIconSrc(code){
      const c = Number(code);
      if (!Number.isFinite(c)) return "";

      // WMO weather interpretation groups (Open-Meteo style)
      if (c === 0) return "/icons/weather/weather_sunny.svg";
      if (c === 1 || c === 2 || c === 3) return "/icons/weather/weather_cloudy.svg";
      if (c === 45 || c === 48) return "/icons/weather/weather_cloudy.svg";

      // drizzle / rain
      if ((c >= 51 && c <= 57) || (c >= 61 && c <= 67)) return "/icons/weather/weather_rain.svg";

      // snow
      if (c >= 71 && c <= 77) return "/icons/weather/weather_snow.svg";

      // rain showers
      if (c >= 80 && c <= 82) return "/icons/weather/weather_rain-showers.svg";

      // thunderstorm
      if (c >= 95 && c <= 99) return "/icons/weather/weather_rain-showers.svg";

      return "/icons/weather/weather_cloudy.svg";
    }

        // -----------------------------
    // Mode icons (inline SVG data URIs)
    // - no external deps
    // - monochrome, inherits via currentColor not possible in <img>, so we bake a neutral dark
    // -----------------------------
    function svgDataUri(svg){
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    }

    const MODE_ICON = {
      vacances: "/icons/month/vacances.png",
      ferie: "/icons/month/ferie.png",
      temps_forts: "/icons/month/temps-fort.png",
    };

    // -----------------------------
    // Mode label resolution (best-effort from semantic row)
    // -----------------------------
    function firstLabel(v){
      if (typeof v === "string" && v.trim()) return v.trim();
      if (Array.isArray(v) && typeof v[0] === "string" && v[0].trim()) return v[0].trim();
      return null;
    }

    function resolveVacancesLabel(day){
      // try common variants; fallback stays "VACANCES"
      return firstLabel(
        day?.school_holiday_label ??
        day?.school_holiday_zone_label ??
        day?.school_holiday_zone ??
        day?.school_holiday_name ??
        day?.vacances_scolaires_label ??
        null
      );
    }

    function resolveFerieLabel(day){
      return firstLabel(
        day?.public_holiday_name_fr ??
        day?.public_holiday_name ??
        day?.public_holiday_label ??
        day?.holiday_name ??
        null
      );
    }

    function resolveTempsFortsLabel(day){
      return firstLabel(
        day?.commercial_event_names_region ??
        day?.commercial_event_name_region ??
        day?.commercial_event_label_region ??
        day?.commercial_event_name ??
        null
      );
    }

    // if too long -> first letter (per your rule)
    function clampModeLabel(s, maxLen){
      const v = (typeof s === "string" ? s.trim() : "");
      if (!v) return null;
      if (v.length <= maxLen) return v;
      return v.slice(0, 1).toUpperCase();
    }

    // Returns { iconSrc, labelText } or null (meaning: keep weather)
    function computeModeOverlay(day, key){
      if (!day || typeof day !== "object") return null;

      if (key === "vacances") {
        if (day.is_school_holiday_flag !== true) return null;
        return { iconSrc: MODE_ICON.vacances, labelText: "VAC" };
      }

      if (key === "ferie") {
        if (day.is_public_holiday_fr_flag !== true) return null;
        return { iconSrc: MODE_ICON.ferie, labelText: "F√âR" };
      }

      if (key === "temps_forts") {
        if (day.is_commercial_event_flag_region !== true) return null;
        return { iconSrc: MODE_ICON.temps_forts, labelText: "TF" };
      }

      return null;
    }
        
    async function loadMonthTop3() {
      const out = await loadMonthData();
      if (!out) return;

      bindMonthMeta(out);

      const topDays = out.window?.top_days;
      if (!Array.isArray(topDays) || topDays.length === 0) return;

      const root = document.getElementById("ie-30d-top3-cards");
      if (!root) return;

      // ---- Render TOP 3 from effective dataset ----
      function renderTop3() {
        const filters = readConstraintFilters();
        const effectiveTopDays = topDays.filter((d) => !isConstrainedDay(d, filters));

        root.innerHTML = "";

        // If everything gets excluded, we render nothing (v1 minimal, no extra UI)
        if (effectiveTopDays.length === 0) return;

        effectiveTopDays.slice(0, 3).forEach((d, idx) => {
          const ymd = asYmd(d?.date);
          if (!ymd) return;

          const parts = ymd.split("-").map(Number);
          const m = parts[1];
          const day = parts[2];
          if (!Number.isFinite(m) || !Number.isFinite(day)) return;

          const month = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][m - 1];

          const score =
            Number.isFinite(d?.opportunity_score_final_local)
              ? d.opportunity_score_final_local
              : "";

          const medal =
            typeof d?.opportunity_medal === "string" && d.opportunity_medal.length
              ? `<div class="ie-top3-badge">${d.opportunity_medal}</div>`
              : "";

          const el = document.createElement("div");
          el.className = "ie-top3-card";

          el.innerHTML = `
            <div class="ie-top3-toprow">
              <div class="ie-top3-rank">#${idx + 1}</div>
              <div class="ie-top3-month">${month}</div>
            </div>
            <div class="ie-top3-day">${day}</div>
            <div class="ie-top3-score">${score}</div>
            ${medal}
          `;

          root.appendChild(el);
        });
      }

      // Initial render
      renderTop3();

      // Bind change handlers once (avoid duplicate listeners on hot reload / re-entry)
      if (!window.__ie_month_constraints_bound) {
        window.__ie_month_constraints_bound = true;

        const ids = [
          "ie-filter-publicHoliday",
          "ie-filter-schoolHoliday",
          "ie-filter-promoDays",
          "ie-filter-badWeather",     
          "ie-filter-competition",
        ];

        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (el instanceof HTMLInputElement) {
            el.addEventListener("change", () => {
              try {
                renderTop3();
              } catch (_) {}
            });
          }
        });
      }
    }

    async function loadMonthGrid() {
      const out = await loadMonthData();
      if (!out) return;

      bindMonthMeta(out);

      const rawDays = out.days;
      const windowStart = asYmd(out.window?.window_start_date);
      if (!Array.isArray(rawDays) || !windowStart) return;

      const days = rawDays
        .map((r) => ({ ...r, date: asYmd(r?.date) }))
        .filter((r) => typeof r.date === "string" && r.date.length === 10);
      
      // DEV-ONLY schema probe (truth for implementing business constraints)
      let isDev = false;
      let sample = null;

      try {
        const host = String(window.location.hostname || "");
        const isLocalhost = host === "localhost" || host === "127.0.0.1";
        const isDebug = new URL(window.location.href).searchParams.get("debug") === "1";
        isDev = isLocalhost || isDebug;

        if (isDev && !window.__ie_month_day_schema_logged) {
          window.__ie_month_day_schema_logged = true;
          sample = days && days.length ? days[0] : null;
          console.log("[IE][month] days.length:", Array.isArray(days) ? days.length : null);
          console.log("[IE][month] sample day:", sample);
          console.log("[IE][month] sample day keys:", sample && typeof sample === "object" ? Object.keys(sample) : null);
        }
      } catch (_) {}
      
    const grid = document.getElementById("ie-30d-grid");
      if (!grid) return;

      const monthHeader = document.getElementById("ie-30d-month-header");
      if (monthHeader) monthHeader.setAttribute("data-window-start", windowStart);

      grid.innerHTML = "";

      function ymdToUtcDate(s) {
        const [y, m, d] = s.split("-").map(Number);
        return new Date(Date.UTC(y, m - 1, d));
      }

      function toYmd(dt) {
        const y = dt.getUTCFullYear();
        const m = String(dt.getUTCMonth() + 1).padStart(2, "0");
        const d = String(dt.getUTCDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      const semanticByDate = new Map(days.map((d) => [d.date, d]));

      window.__ie_month_semanticByDate = semanticByDate;

      const start = ymdToUtcDate(windowStart);
      start.setUTCDate(start.getUTCDate() - ((start.getUTCDay() + 6) % 7)); // Monday

      for (let i = 0; i < 42; i++) {
        const dt = new Date(start);
        dt.setUTCDate(start.getUTCDate() + i);
        const ymd = toYmd(dt);

        const semantic = semanticByDate.get(ymd);

        const btn = document.createElement("button");
        btn.className = "ie-30d-day";
        btn.setAttribute("data-date", ymd);

        if (!semantic) btn.classList.add("ie-spillover");

        const iconSrc = semantic ? weatherIconSrc(semantic.weather_code) : "";

        const medalText = semantic ? resolveMedalText(semantic) : "";

        btn.innerHTML = `
          <div class="ie-30d-daynum">${dt.getUTCDate()}</div>

          <div class="ie-30d-medal" data-role="ie-medal">${medalText}</div>

          <div class="ie-30d-weather" data-role="ie-icon">
            <div class="ie-30d-weather-label" data-role="ie-icon-label" style="display:none;"></div>
            ${iconSrc ? `<img data-role="ie-icon-img" src="${iconSrc}" alt="" />` : `<img data-role="ie-icon-img" src="" alt="" style="display:none;" />`}
          </div>
        `;

        grid.appendChild(btn);
      }
      try { updateGridConstraints(); } catch (_) {}

      grid.addEventListener("click", (e) => {
        const tgt = e.target;
        if(!(tgt instanceof Element)) return;
        const btn = tgt.closest(".ie-30d-day");
        if(!btn) return;
        const d = btn.getAttribute("data-date");
        if(!d) return;
        const idx = selected.indexOf(d);
        if(idx >= 0){
          selected.splice(idx, 1);
        } else {
          if(selected.length >= MAX_DAYS){
            flashMaxHint();
            return;
          }
          selected.push(d);
        }
        const nextUrl = new URL(window.location.href);
        setSelectedDates(nextUrl, selected);
        window.history.replaceState({}, "", nextUrl.toString());
        renderSelected(selected);
        applyNavState();
      });
    } // end loadMonthGrid

    let __monthCache = null;
    let __monthCachePromise = null;

    async function loadMonthData() {
      if (__monthCache) return __monthCache;
      if (__monthCachePromise) return __monthCachePromise;

      __monthCachePromise = (async () => {
        try {
          const url = "/api/insight/month" + window.location.search;

          const rid = crypto.randomUUID();
          console.log("[MONTH UI] fetching month api", { rid, url });

          const res = await fetch(url, {
            headers: {
              accept: "application/json",
              "x-request-id": rid,
            },
          });

          if (!res.ok) return null;

          const out = await res.json();
          if (!out || out.ok !== true) return null;

          __monthCache = out;
          return out;
        } catch (_) {
          return null;
        }
      })();

      return __monthCachePromise;
    }

    function ymdParts(ymd){
      if (!ymd || typeof ymd !== "string") return null;
      const p = ymd.slice(0, 10).split("-");
      if (p.length !== 3) return null;
      const y = parseInt(p[0], 10);
      const m = parseInt(p[1], 10);
      if (!Number.isFinite(y) || !Number.isFinite(m) || m < 1 || m > 12) return null;
      return { y, m };
    }

    function monthKey(y, m){
      return `${String(y)}-${String(m).padStart(2, "0")}`;
    }

    function buildMonthSelect(out){
      const sel = document.getElementById("ie-30d-month-select");
      if (!(sel instanceof HTMLSelectElement)) return;

      const ws = asYmd(out?.window?.window_start_date);
      const parts = ymdParts(ws);
      if (!parts) return;

      const { y } = parts;

      // 12 months for the current year (simple + deterministic)
      const MONTHS_FR_LONG = [
        "Janvier","F√©vrier","Mars","Avril","Mai","Juin",
        "Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"
      ];

      // Build options once per render
      sel.innerHTML = "";
      for (let m = 1; m <= 12; m++){
        const opt = document.createElement("option");
        opt.value = monthKey(y, m);
        opt.textContent = `${MONTHS_FR_LONG[m - 1]} ${y}`;
        sel.appendChild(opt);
      }

      // Set current selection to window_start month
      sel.value = monthKey(parts.y, parts.m);
    }

    function bindMonthMeta(out) {
      const labelEl = document.getElementById("ie-30d-display-label");
      const takeawayEl = document.getElementById("ie-30d-takeaway-text");

      const keyTakeaway =
        (typeof out?.ai_points_cles_text === "string" && out.ai_points_cles_text.trim())
          ? out.ai_points_cles_text
          : out?.window?.key_takeaway;

      const startYmd = asYmd(out?.window?.window_start_date);
      const endYmd = asYmd(out?.window?.window_end_date);

      const MONTHS_FR = ["JAN","F√âV","MAR","AVR","MAI","JUN","JUL","AO√õ","SEP","OCT","NOV","D√âC"];

      function fmtRange(ymd){
        if (!ymd) return null;
        const parts = String(ymd).split("-");
        if (parts.length !== 3) return null;

        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        const d = parseInt(parts[2], 10);

        if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return null;
        if (m < 1 || m > 12) return null;

        return `${String(d)} ${MONTHS_FR[m - 1]} ${String(y)}`;
      }

      const startLabel = fmtRange(startYmd);
      const endLabel = fmtRange(endYmd);

      if (labelEl && startLabel && endLabel) {
        labelEl.textContent = `${startLabel} - ${endLabel}`;
      }

      if (takeawayEl && typeof keyTakeaway === "string") {
        takeawayEl.textContent = keyTakeaway;
      }
      try { buildMonthSelect(out); } catch (_) {}
    }

    function goPrompt(){ window.location.href = "/app/insightevent/prompt"; }
    function goMonth(){ window.location.href = "/app/insightevent/month" + window.location.search; }
    function goDay(){ window.location.href = "/app/insightevent/days" + window.location.search; }

    const MAX_DAYS = 7;

    function parseSelectedDates(url){
        const raw = url.searchParams.get("selected_dates") || "";
        const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
        const out = [];
        const seen = new Set();
        for(const d of parts){
        if(!seen.has(d)){
            out.push(d);
            seen.add(d);
        }
        }
        return out;
    }

    function setSelectedDates(url, dates){
        if(dates.length === 0){
        url.searchParams.delete("selected_dates");
        } else {
        url.searchParams.set("selected_dates", dates.join(","));
        }
    }

    function fmtPill(yyyy_mm_dd){
        const parts = yyyy_mm_dd.split("-");
        if(parts.length !== 3) return yyyy_mm_dd;
        const m = parseInt(parts[1], 10);
        const d = parseInt(parts[2], 10);
        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        if(!Number.isFinite(m) || !Number.isFinite(d) || m < 1 || m > 12) return yyyy_mm_dd;
        return `${months[m-1]} ${String(d)}`;
    }

    function flashMaxHint(){
        const hintEl = document.getElementById("ie-30d-selected-hint");
        if(!hintEl) return;
        hintEl.style.display = "block";
        window.clearTimeout(flashMaxHint._t);
        flashMaxHint._t = window.setTimeout(() => {
        hintEl.style.display = "none";
        }, 1200);
    }
    flashMaxHint._t = null;

    function renderSelected(dates){
        const titleEl = document.getElementById("ie-30d-selected-title");
        const pillsEl = document.getElementById("ie-30d-selected-pills");

        if(titleEl){
        titleEl.textContent = `CHOIX (${dates.length}/${MAX_DAYS})`;
        }
        if(!pillsEl) return;

        pillsEl.innerHTML = dates.map(d => (
        `<span class="ie-pill" data-date="${d}">${fmtPill(d)}</span>`
        )).join("");

        document.querySelectorAll("#ie-30d-grid .ie-30d-day").forEach((btn) => {
        const d = btn.getAttribute("data-date");
        if(!d) return;
        const isSelected = dates.includes(d);
        btn.classList.toggle("ie-30d-selected-day", isSelected);

        if (btn.classList.contains("ie-spillover") && isSelected) {
            btn.classList.add("ie-30d-spillover-selected");
        } else {
            btn.classList.remove("ie-30d-spillover-selected");
        }
        });
    }

    const url = new URL(window.location.href);
    let selected = parseSelectedDates(url);

    function setSelectedBarHeightPx(px){
      const root = document.getElementById("ie-30d-root");
      if (!root) return;
      root.style.setProperty("--ie-30d-selectedbar-h", `${px}px`);
    }

    function applyNavState(){
      const barEl   = document.getElementById("ie-30d-bottom-bar");
      const voirBtn = document.getElementById("ie-30d-view-details");

      const hasSelection = (Array.isArray(selected) && selected.length > 0);

      if (barEl) {
        barEl.style.display = hasSelection ? "flex" : "none";
      }

      setSelectedBarHeightPx(hasSelection ? 65 : 0);
               
      if(voirBtn && voirBtn.tagName === "BUTTON"){
        voirBtn.disabled = !hasSelection;
        voirBtn.style.opacity = hasSelection ? "1" : "0.45";
        voirBtn.style.cursor  = hasSelection ? "pointer" : "default";
        voirBtn.setAttribute("aria-disabled", hasSelection ? "false" : "true");
      }
    }

    function bindPillsRemove(){
      const pillsEl = document.getElementById("ie-30d-selected-pills");
      if (!pillsEl) return;
      pillsEl.addEventListener("click", (e) => {
        const tgt = e.target;
        if (!(tgt instanceof Element)) return;
        const pill = tgt.closest(".ie-pill");
        if (!pill) return;
        const d = pill.getAttribute("data-date");
        if (!d) return;
        const idx = selected.indexOf(d);
        if (idx < 0) return;
        selected.splice(idx, 1);
        const nextUrl = new URL(window.location.href);
        setSelectedDates(nextUrl, selected);
        window.history.replaceState({}, "", nextUrl.toString());
        renderSelected(selected);
        applyNavState();
      });
    }

    function initSelectionUI(){
      renderSelected(selected);
      applyNavState();
      bindPillsRemove();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initSelectionUI, { once: true });
    } else {
      initSelectionUI();
    }

    function keepQuery(path){
      const cur = new URL(window.location.href);
      const u = new URL(path, window.location.origin);

      const keys = ["location_id", "anchor_date", "selected_date", "selected_dates", "q"];
      for (const k of keys) {
        const v = cur.searchParams.get(k);
        if (v && v.trim()) u.searchParams.set(k, v);
      }
      return u.pathname + u.search;
    }

    function goDaysFromSelection(){
      if(!Array.isArray(selected) || selected.length === 0) return;

      const u = new URL(window.location.href);
      u.searchParams.set("selected_dates", selected.join(","));
      if(!u.searchParams.get("selected_date")) u.searchParams.set("selected_date", selected[0]);

      window.location.href = "/app/insightevent/days" + u.search;
    }

    function bindVoirBtn(){
      const voirBtn = document.getElementById("ie-30d-view-details");
      if (voirBtn) voirBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        goDaysFromSelection();
      }, true);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bindVoirBtn, { once: true });
    } else {
      bindVoirBtn();
    }

    (function bindMonthDropdownNav(){
      const sel = document.getElementById("ie-30d-month-select");
      if (!(sel instanceof HTMLSelectElement)) return;

      function parseMonthKey(v){
        if (!v || typeof v !== "string") return null;
        const p = v.split("-");
        if (p.length !== 2) return null;
        const y = parseInt(p[0], 10);
        const m = parseInt(p[1], 10);
        if (!Number.isFinite(y) || !Number.isFinite(m) || m < 1 || m > 12) return null;
        return { y, m };
      }

      sel.addEventListener("change", () => {
        const mk = parseMonthKey(sel.value);
        if (!mk) return;

        const u = new URL(window.location.href);

        // Jump to the 1st of the selected month (API + grid will align week internally)
        const nextStr = `${mk.y}-${String(mk.m).padStart(2, "0")}-01`;

        u.searchParams.set("window_start_date", nextStr); // canonical for month
        u.searchParams.set("selected_date", nextStr);     // keep for backward compat
        u.searchParams.set("anchor_date", nextStr);       // keep for backward compat

        // Preserve existing selections across month navigation
        const existingSelected = new URL(window.location.href).searchParams.get("selected_dates");
        if (existingSelected) u.searchParams.set("selected_dates", existingSelected);

        window.location.href = "/app/insightevent/month" + u.search;
      });
    })();
    
    (async function bootstrapMonth() {
      await loadMonthTop3();
      await loadMonthGrid();
      await updateGridConstraints(); // sets constrained styling
      try { await applyGridMode(); } catch (_) {} // sets icon/label + top3 medal
    })();

    </script>
  </BaseLayout>
</SignedIn>
